

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rkviewer.canvas.canvas &mdash; SBcoyote 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> SBcoyote
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../QuickStart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../PluginDevelopment.html">Plugin Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../PluginReference.html">Plugin Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../InternalJSONModelFormat.html">Internal JSON Model Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CoreDevelopment.html">Core Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Reference.html">Core Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SBcoyote</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>rkviewer.canvas.canvas</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for rkviewer.canvas.canvas</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The main canvas panel.</span>

<span class="sd">This handles user input actions, updates the model, and performs redraws after the model is updated.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># pylint: disable=maybe-no-member</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">logging</span> <span class="kn">import</span> <span class="n">Logger</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">DefaultDict</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">cast</span>
<span class="kn">from</span> <span class="nn">commentjson.commentjson</span> <span class="kn">import</span> <span class="n">JSONLibraryException</span>
<span class="kn">from</span> <span class="nn">marshmallow.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>

<span class="kn">from</span> <span class="nn">sortedcontainers</span> <span class="kn">import</span> <span class="n">SortedKeyList</span>
<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">..config</span> <span class="kn">import</span> <span class="n">get_setting</span><span class="p">,</span> <span class="n">get_theme</span><span class="p">,</span> <span class="n">pop_settings_err</span>
<span class="kn">from</span> <span class="nn">..events</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CanvasDidUpdateEvent</span><span class="p">,</span>
    <span class="n">DidCommitDragEvent</span><span class="p">,</span> <span class="n">DidDeleteEvent</span><span class="p">,</span> <span class="n">DidMoveNodesEvent</span><span class="p">,</span>
    <span class="n">DidPaintCanvasEvent</span><span class="p">,</span>
    <span class="n">SelectionDidUpdateEvent</span><span class="p">,</span>
    <span class="n">bind_handler</span><span class="p">,</span>
    <span class="n">post_event</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..mvc</span> <span class="kn">import</span> <span class="n">IController</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">even_round</span><span class="p">,</span> <span class="n">opacity_mul</span><span class="p">,</span> <span class="n">resource_path</span>
<span class="kn">from</span> <span class="nn">.data</span> <span class="kn">import</span> <span class="n">Compartment</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Reaction</span><span class="p">,</span> <span class="n">ReactionBezier</span><span class="p">,</span> <span class="n">compute_centroid</span><span class="p">,</span> <span class="n">init_bezier</span>
<span class="kn">from</span> <span class="nn">.elements</span> <span class="kn">import</span> <span class="n">BezierHandle</span><span class="p">,</span> <span class="n">CanvasElement</span><span class="p">,</span> <span class="n">CompartmentElt</span><span class="p">,</span> <span class="n">Layer</span><span class="p">,</span> <span class="n">NodeElement</span><span class="p">,</span> <span class="n">ReactionCenter</span><span class="p">,</span> <span class="n">ReactionElement</span><span class="p">,</span> <span class="n">SelectBox</span><span class="p">,</span> <span class="n">layer_above</span>
<span class="kn">from</span> <span class="nn">.geometry</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Rect</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">,</span> <span class="n">circle_bounds</span><span class="p">,</span>
    <span class="n">clamp_rect_pos</span><span class="p">,</span> <span class="n">get_bounding_rect</span><span class="p">,</span>
    <span class="n">padded_rect</span><span class="p">,</span>
    <span class="n">rects_overlap</span><span class="p">,</span>
    <span class="n">pt_in_rect</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.overlays</span> <span class="kn">import</span> <span class="n">CanvasOverlay</span><span class="p">,</span> <span class="n">Minimap</span>
<span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="n">InputMode</span><span class="p">,</span> <span class="n">cstate</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">Observer</span><span class="p">,</span> <span class="n">SetSubject</span><span class="p">,</span> <span class="n">default_handle_positions</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">draw_rect</span><span class="p">,</span> <span class="n">get_nodes_by_idx</span>


<span class="n">BOUNDS_EPS</span> <span class="o">=</span> <span class="mi">0</span>
<span class="sd">&quot;&quot;&quot;The padding around the canvas to ensure nodes are not moved out of bounds due to floating pont</span>
<span class="sd">issues.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">BOUNDS_EPS_VEC</span> <span class="o">=</span> <span class="n">Vec2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">BOUNDS_EPS</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;2D bounds vector formed from BOUNDS_EPS&quot;&quot;&quot;</span>


<div class="viewcode-block" id="Alignment"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.canvas.Alignment">[docs]</a><span class="k">class</span> <span class="nc">Alignment</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alignment&quot;&quot;&quot;</span>
    <span class="n">LEFT</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">RIGHT</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">CENTER</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">TOP</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">BOTTOM</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">MIDDLE</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">GRID</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">HORIZONTAL</span> <span class="o">=</span> <span class="mi">7</span>  <span class="c1">#: Arrange into a row</span>
    <span class="n">VERTICAL</span> <span class="o">=</span> <span class="mi">8</span>  <span class="c1">#: Arrange into a column</span></div>


<span class="n">DBL_CLICK_TIMER</span> <span class="o">=</span> <span class="mi">123</span>
<span class="c1"># Don&#39;t use ScrolledPanel since Canvas does not scroll conventionally.</span>
<span class="k">class</span> <span class="nc">Canvas</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">ScrolledWindow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The main window onto which nodes, reactions, etc. will be drawn.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        MIN_ZOOM_LEVEL: The minimum zoom level the user is allowed to reach. See SetZoomLevel() for more detail.</span>
<span class="sd">        MAX_ZOOM_LEVEL: The maximum zoom level the user is allowed to reach.</span>
<span class="sd">        NODE_LAYER: The node layer.</span>
<span class="sd">        REACTION_LAYER: The reaction layer.</span>
<span class="sd">        SELECT_BOX_LAYER: The layer for the select box.</span>

<span class="sd">        controller: The associated controller instance.</span>
<span class="sd">        realsize: The actual, total size of canvas, including the part offscreen.</span>
<span class="sd">        net_index: The index of the current network. Rightn now it can be zero.</span>
<span class="sd">        sel_nodes_idx: The set of indices of the currently selected nodes.</span>
<span class="sd">        sel_reactions_idx: The set of indices of the currently selected reactions.</span>
<span class="sd">        sel_compartments_idx: The set of indices of the currently selected compartments.</span>
<span class="sd">        drag_sel_nodes_idx: The set of indices tentatively selected during dragging. This is added</span>
<span class="sd">                           to sel_nodes_idx only after the user has stopped drag-selecting.</span>
<span class="sd">        drag_sel_comps_idx: See drag_sel_nodes_idx but for compartments</span>
<span class="sd">        hovered_element: The element over which the mouse is hovering, or None.</span>
<span class="sd">        zoom_slider: The zoom slider widget.</span>
<span class="sd">        reaction_map: Maps node index to the set of reaction (indices) that it is in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">MIN_ZOOM_LEVEL</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">11</span>
    <span class="n">MAX_ZOOM_LEVEL</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">NODE_LAYER</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">REACTION_LAYER</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">COMPARTMENT_LAYER</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">DRAGGED_NODE_LAYER</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">SELECT_BOX_LAYER</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">HANDLE_LAYER</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">MILLIS_PER_REFRESH</span> <span class="o">=</span> <span class="mi">16</span>  <span class="c1"># serves as framerate cap</span>
    <span class="n">KEY_MOVE_STRIDE</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#: Number of pixels to move when the user presses an arrow key.</span>
    <span class="c1">#: Larger move stride for convenience; used when SHIFT is pressed.</span>
    <span class="n">KEY_MOVE_LONG_STRIDE</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">controller</span><span class="p">:</span> <span class="n">IController</span>
    <span class="n">realsize</span><span class="p">:</span> <span class="n">Vec2</span>
    <span class="n">sel_nodes_idx</span><span class="p">:</span> <span class="n">SetSubject</span>
    <span class="n">sel_reactions_idx</span><span class="p">:</span> <span class="n">SetSubject</span>
    <span class="n">sel_compartments_idx</span><span class="p">:</span> <span class="n">SetSubject</span>
    <span class="n">drag_sel_nodes_idx</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">drag_sel_rxns_idx</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">drag_sel_comps_idx</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">hovered_element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">]</span>
    <span class="n">dragged_element</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">]</span>
    <span class="n">zoom_slider</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Slider</span>
    <span class="n">reaction_map</span><span class="p">:</span> <span class="n">DefaultDict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>  <span class="c1"># maps node index to reactions it&#39;s part of</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">Logger</span>

    <span class="c1">#: Current network index. Right now this is always 0 since there is only one tab.</span>
    <span class="n">_net_index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]</span>  <span class="c1">#: List of Node instances. This contains data needed to render them.</span>
    <span class="c1"># TODO move this one to top docstring</span>
    <span class="n">_reactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Reaction</span><span class="p">]</span>  <span class="c1">#: List of ReactionBezier instances.</span>
    <span class="n">_compartments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Compartment</span><span class="p">]</span>  <span class="c1">#: List of Compartment instances</span>
    <span class="n">_node_elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">NodeElement</span><span class="p">]</span>
    <span class="n">_reaction_elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ReactionElement</span><span class="p">]</span>
    <span class="n">_compartment_elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CompartmentElt</span><span class="p">]</span>
    <span class="n">_plugin_elements</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">]</span>
    <span class="n">_zoom_level</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1">#: The current zoom level. See SetZoomLevel() for more detail.</span>
    <span class="c1">#: The zoom scale. This always corresponds one-to-one with zoom_level. See property for detail.</span>
    <span class="n">_reactant_idx</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>  <span class="c1">#: The list of indices of the currently designated reactant nodes.</span>
    <span class="n">_product_idx</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>  <span class="c1">#: The list of indices of the currently designated product nodes</span>
    <span class="n">_select_box</span><span class="p">:</span> <span class="n">SelectBox</span>  <span class="c1">#: The select box element.</span>
    <span class="n">_minimap</span><span class="p">:</span> <span class="n">Minimap</span>  <span class="c1">#: The minimap overlay.</span>
    <span class="n">_overlays</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CanvasOverlay</span><span class="p">]</span>  <span class="c1">#: The list of overlays. Used when processing click events.</span>
    <span class="n">_drag_selecting</span><span class="p">:</span> <span class="nb">bool</span>  <span class="c1">#: If currently dragging the selection rectangle.</span>
    <span class="n">_drag_select_start</span><span class="p">:</span> <span class="n">Vec2</span>  <span class="c1">#: The (logical) mouse position when the user started drag selecting.</span>
    <span class="n">_drag_rect</span><span class="p">:</span> <span class="n">Rect</span>  <span class="c1">#: The current drag-selection rectangle.</span>
    <span class="n">_reverse_status</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>  <span class="c1">#: Maps status string in .config.settings to its index.</span>
    <span class="c1">#: Flag for whether the mouse is currently outside of the root app window.</span>
    <span class="n">_copied_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]</span>  <span class="c1">#: Copy of nodes currently in clipboard</span>
    <span class="n">_accum_frames</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">_last_fps_update</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">_last_refresh</span><span class="p">:</span> <span class="nb">int</span>
    <span class="c1">#: When True, SelectionDidUpdate events are not fired. This is in case multiple such events</span>
    <span class="c1">#: are fired consecutively (e.g. both nodes and reactions changed), to make sure that only one</span>
    <span class="c1">#: event fires in total.</span>
    <span class="n">_in_selection_group</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="c1">#: bool to indicate whether a selection changed event was fired inside selection group.</span>
    <span class="n">_selection_dirty</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">node_idx_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span>  <span class="c1">#: Maps node index to node</span>
    <span class="n">reaction_idx_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Reaction</span><span class="p">]</span>  <span class="c1">#: Maps reaction index to reaction</span>
    <span class="n">node_to_rxn</span><span class="p">:</span> <span class="n">DefaultDict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span>
    <span class="n">comp_idx_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Compartment</span><span class="p">]</span>  <span class="c1">#: Maps compartment index to compartment</span>
    <span class="n">sel_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]</span>  <span class="c1">#: Current list of selected nodes; cached for performance</span>
    <span class="n">sel_reactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Reaction</span><span class="p">]</span>
    <span class="n">sel_comps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Compartment</span><span class="p">]</span>  <span class="c1">#: Current list of selected comps; cached for performance</span>
    <span class="n">drawing_drag</span><span class="p">:</span> <span class="nb">bool</span>  <span class="c1">#: See self._UpdateSelectedLists() for more details</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">IController</span><span class="p">,</span> <span class="n">zoom_slider</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">realsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>  <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="c1"># ensure the parent&#39;s __init__ is called</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">DEFAULT_FRAME_STYLE</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">wx</span><span class="o">.</span><span class="n">MAXIMIZE_BOX</span> <span class="o">^</span> <span class="n">wx</span><span class="o">.</span><span class="n">RESIZE_BORDER</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_motion</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">pop_settings_err</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">JSONLibraryException</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed when parsing settings.json. Using default settings instead.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="n">err</span><span class="o">.</span><span class="n">message</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Invalid settings in settings.json. Using default settings instead.</span><span class="se">\n\n</span><span class="s1">&#39;</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ShowWarningDialog</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="n">init_bezier</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_node_elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compartment_elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># TODO document below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_elements</span> <span class="o">=</span> <span class="n">SortedKeyList</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widget_elements</span> <span class="o">=</span> <span class="n">SortedKeyList</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plugin_elements</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_to_rxn</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)</span>

        <span class="c1"># prevent flickering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetDoubleBuffered</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_LEFT_DOWN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnLeftDown</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_LEFT_UP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnLeftUp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_RIGHT_UP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnRightUp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MOTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnMotion</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_PAINT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnPaint</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SCROLLWIN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnScroll</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MOUSEWHEEL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnMouseWheel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_LEAVE_WINDOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnLeaveWindow</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_WINDOW_DESTROY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnWindowDestroy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_IDLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnIdle</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_ERASE_BACKGROUND</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Don&#39;t erase background</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHAR_HOOK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnChar</span><span class="p">)</span>

        <span class="n">bind_handler</span><span class="p">(</span><span class="n">DidCommitDragEvent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnDidCommitNodePositions</span><span class="p">)</span>

        <span class="c1"># state variables</span>
        <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">=</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">SELECT</span>
        <span class="c1"># Set to (0, 0) since this won&#39;t be used before it&#39;s updated once first</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dragged_rel_window</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Point</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_zoom_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">realsize</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">realsize</span><span class="p">)</span>
        <span class="n">cstate</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="p">)</span>
        <span class="n">scroll_width</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SystemSettings</span><span class="o">.</span><span class="n">GetMetric</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">SYS_VSCROLL_X</span><span class="p">)</span>
        <span class="n">scroll_height</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SystemSettings</span><span class="o">.</span><span class="n">GetMetric</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">SYS_HSCROLL_Y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scroll_off</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">scroll_width</span><span class="p">,</span> <span class="n">scroll_height</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetVirtualSize</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="p">)</span>

        <span class="n">bounds</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">BOUNDS_EPS_VEC</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">realsize</span> <span class="o">-</span> <span class="n">BOUNDS_EPS_VEC</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[],</span> <span class="n">bounds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span>
                                     <span class="n">Canvas</span><span class="o">.</span><span class="n">SELECT_BOX_LAYER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span> <span class="o">=</span> <span class="n">SetSubject</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span> <span class="o">=</span> <span class="n">SetSubject</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span> <span class="o">=</span> <span class="n">SetSubject</span><span class="p">()</span>
        <span class="n">selection_obs</span> <span class="o">=</span> <span class="n">Observer</span><span class="p">(</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectionChanged</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">selection_obs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">selection_obs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">selection_obs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zoom_slider</span> <span class="o">=</span> <span class="n">zoom_slider</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom_slider</span><span class="o">.</span><span class="n">SetRange</span><span class="p">(</span><span class="n">Canvas</span><span class="o">.</span><span class="n">MIN_ZOOM_LEVEL</span><span class="p">,</span> <span class="n">Canvas</span><span class="o">.</span><span class="n">MAX_ZOOM_LEVEL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom_slider</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;zoom_slider_bg&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GetParent</span><span class="p">()</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SLIDER</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnSlider</span><span class="p">)</span>

        <span class="c1"># Set a placeholder value for position; we will set it later in SetOverlayPositions().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span> <span class="o">=</span> <span class="n">Minimap</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">Vec2</span><span class="p">(),</span> <span class="n">device_pos</span><span class="o">=</span><span class="n">Vec2</span><span class="p">(),</span> <span class="n">width</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">realsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="p">,</span>
                                <span class="n">window_size</span><span class="o">=</span><span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetSize</span><span class="p">()),</span> <span class="n">pos_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">SetOriginPos</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_overlays</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_selecting</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_select_start</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(),</span> <span class="n">Vec2</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_nodes_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_rxns_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_comps_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status_bar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetTopLevelParent</span><span class="p">()</span><span class="o">.</span><span class="n">GetStatusBar</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_bar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Need to create status bar before creating canvas!&quot;</span>

        <span class="n">status_fields</span> <span class="o">=</span> <span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;status_fields&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">status_fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_status</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">status_fields</span><span class="p">)}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_copied_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">SetZoomLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_accum_frames</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_logical_pos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_fps_update</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_refresh</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode_changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InputModeChanged</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp_index</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Compartment of index; remove once controller implements compartments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_idx_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reaction_idx_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp_idx_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes_floating</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_selection_group</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selection_dirty</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SetOverlayPositions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_comps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawing_drag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_elements</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_static_bitmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">OnWindowDestroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnIdle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="c1"># if self._static_bitmap is None:</span>
        <span class="c1">#     self._RedrawDynamicToBuffer()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LazyRefresh</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnChar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="n">keycode</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetKeyCode</span><span class="p">()</span>

        <span class="n">offset</span><span class="p">:</span> <span class="n">Vec2</span>
        <span class="k">if</span> <span class="n">keycode</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">WXK_LEFT</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">keycode</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">WXK_RIGHT</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">keycode</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">WXK_UP</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">keycode</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">WXK_DOWN</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">evt</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">wx</span><span class="o">.</span><span class="n">GetKeyState</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">WXK_SHIFT</span><span class="p">):</span>
            <span class="n">offset</span> <span class="o">*=</span> <span class="n">Canvas</span><span class="o">.</span><span class="n">KEY_MOVE_LONG_STRIDE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">*=</span> <span class="n">Canvas</span><span class="o">.</span><span class="n">KEY_MOVE_STRIDE</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">move_offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">select_box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reactions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">compartments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span>

    <span class="k">def</span> <span class="nf">InputModeChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="n">InputMode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">ADD_NODES</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Cursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_CROSS</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Cursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_ARROW</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_SetStatusText</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">net_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span>

    <span class="k">def</span> <span class="nf">ArrowTipChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">rea_el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bz</span> <span class="ow">in</span> <span class="n">rea_el</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">dest_beziers</span><span class="p">:</span>
                <span class="n">bz</span><span class="o">.</span><span class="n">arrow_tip_changed</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_RedrawDynamicToBuffer</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">RegisterAllChildren</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Connect all descendants of this widget to relevant events.</span>

<span class="sd">        wxPython does not propagate events like LEFT_UP and MOTION up to the</span>
<span class="sd">        parent of the window that received it. Therefore normally there is</span>
<span class="sd">        no way for DragDrop to detect a mouse event if it occurred on top</span>
<span class="sd">        of a child widget of window. This function solves this problem by</span>
<span class="sd">        recursively connecting all child widgets of window to trigger the DragDrop</span>
<span class="sd">        handlers. Note that whatever event registered here must do evt.Skip() so</span>
<span class="sd">        that the child itself can handle its event as well.</span>

<span class="sd">        This solution is from https://stackoverflow.com/a/27911300/9171534</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span> <span class="o">!=</span> <span class="n">widget</span><span class="p">:</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">Connect</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">wxEVT_LEFT_UP</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnLeftUp</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">Connect</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">wxEVT_MOTION</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnMotion</span><span class="p">)</span>
            <span class="n">widget</span><span class="o">.</span><span class="n">Connect</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">ID_ANY</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">wxEVT_LEAVE_WINDOW</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnLeaveWindow</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">widget</span><span class="o">.</span><span class="n">GetChildren</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RegisterAllChildren</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_InWhichOverlay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CanvasOverlay</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;If position is within an overlay, return that overlay; otherwise return None.</span>

<span class="sd">        Note:</span>
<span class="sd">            If the position is within multiple overlays, return the latest added overlay, i.e. the</span>
<span class="sd">            overlay with the largest index in the _overlays list.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An overlay if applicable, or None if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO right now this is hardcoded; in the future add List[CanvasOverlay] attribute</span>
        <span class="k">if</span> <span class="n">pt_in_rect</span><span class="p">(</span><span class="n">device_pos</span><span class="p">,</span> <span class="n">Rect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">device_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">size</span><span class="p">)):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">SetOverlayPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the positions of the overlaid widgets.</span>

<span class="sd">        This should be called in OnPaint so that the overlaid widgets stay in the same relative</span>
<span class="sd">        position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># do all the minimap updates here, since this is simpler and less prone to bugs</span>
        <span class="n">minimap_pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetClientSize</span><span class="p">())</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">size</span>
        <span class="n">minimap_pos</span> <span class="o">=</span> <span class="n">minimap_pos</span><span class="o">.</span><span class="n">swapped</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">minimap_pos</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">device_pos</span> <span class="o">=</span> <span class="n">minimap_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcUnscrolledPosition</span><span class="p">(</span><span class="o">*</span><span class="n">minimap_pos</span><span class="o">.</span><span class="n">as_int</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">window_pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcUnscrolledPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetSize</span><span class="p">())</span> <span class="o">/</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">realsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">realsize</span>

    <span class="k">def</span> <span class="nf">CreateNodeElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Layer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeElement</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">NodeElement</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CreateReactionElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn</span><span class="p">:</span> <span class="n">Reaction</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Layer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReactionElement</span><span class="p">:</span>
        <span class="n">snodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_idx_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">sources</span><span class="p">]</span>
        <span class="n">tnodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_idx_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">rxn</span><span class="o">.</span><span class="n">targets</span><span class="p">]</span>
        <span class="n">rb</span> <span class="o">=</span> <span class="n">ReactionBezier</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">snodes</span><span class="p">,</span> <span class="n">tnodes</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ReactionElement</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">,</span> <span class="n">Canvas</span><span class="o">.</span><span class="n">HANDLE_LAYER</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CreateCompartmentElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">:</span> <span class="n">Compartment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CompartmentElt</span><span class="p">:</span>
        <span class="c1"># NOTE the index of the compartment is used as its *secondary layer*, i.e. all compartments</span>
        <span class="c1"># share the same main layor (COMPARTMENT_LAYER), but to make sure the containing nodes</span>
        <span class="c1"># are rendered correctly, a secondary layer is applied to each compartment, taking its</span>
        <span class="c1"># index. This works because compartments with higher indices are added later and therefore</span>
        <span class="c1"># should be rendered on top.</span>
        <span class="k">return</span> <span class="n">CompartmentElt</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">Canvas</span><span class="o">.</span><span class="n">COMPARTMENT_LAYER</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">Reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">],</span> <span class="n">reactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Reaction</span><span class="p">],</span> <span class="n">compartments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Compartment</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Update the list of nodes and apply the current scale.&quot;&quot;&quot;</span>
        <span class="c1"># destroy old elements</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_elements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget_elements</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">elt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plugin_elements</span><span class="p">:</span>
                <span class="n">elt</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

        <span class="c1"># cull removed indices</span>
        <span class="n">node_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">}</span>
        <span class="n">rxn_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">}</span>
        <span class="n">comp_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">node_idx</span><span class="p">)</span>
        <span class="n">new_sel_reactions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">rxn_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">new_sel_reactions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">comp_idx</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span> <span class="o">&amp;=</span> <span class="n">node_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span> <span class="o">&amp;=</span> <span class="n">node_idx</span>

        <span class="c1"># Update index maps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_idx_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_idx_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reaction_idx_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_idx_map</span><span class="p">[</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp_idx_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comp_idx_map</span><span class="p">[</span><span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp</span>

        <span class="c1"># Update reaction map</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_to_rxn</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nodei</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_to_rxn</span><span class="p">[</span><span class="n">nodei</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span> <span class="o">=</span> <span class="n">reactions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span> <span class="o">=</span> <span class="n">compartments</span>
        <span class="c1"># Don&#39;t clear hovered_element if it is SelectBox</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span><span class="p">,</span> <span class="n">SelectBox</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_compartment_elements</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">CreateCompartmentElement</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">]</span>
        <span class="c1"># create node elements and assign the correct layers to them (accounting for compartments)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_node_elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">compi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_compartment_of_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="n">Canvas</span><span class="o">.</span><span class="n">NODE_LAYER</span> <span class="k">if</span> <span class="n">compi</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="k">else</span> <span class="p">(</span><span class="n">Canvas</span><span class="o">.</span><span class="n">COMPARTMENT_LAYER</span><span class="p">,</span> <span class="n">compi</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_node_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CreateNodeElement</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">layers</span><span class="p">))</span>

        <span class="c1"># create reaction elements and assign the correct layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">:</span>
            <span class="n">related_nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">targets</span><span class="p">))</span>
            <span class="n">top_layer</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">el</span><span class="o">.</span><span class="n">layers</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_elements</span> <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">related_nodes</span><span class="p">)</span>
            <span class="c1"># Make sure reaction is displayed above its top-most node</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CreateReactionElement</span><span class="p">(</span><span class="n">rxn</span><span class="p">,</span> <span class="n">layer_above</span><span class="p">(</span><span class="n">top_layer</span><span class="p">)))</span>

        <span class="c1"># Initialize elements list</span>
        <span class="n">select_elements</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_elements</span><span class="p">)</span> <span class="o">+</span> <span class="n">cast</span><span class="p">(</span>
            <span class="n">List</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span><span class="p">)</span> <span class="o">+</span> <span class="n">cast</span><span class="p">(</span>
                <span class="n">List</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartment_elements</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rxn_el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span><span class="p">:</span>
            <span class="c1"># Add Bezier handle and center elements</span>
            <span class="n">select_elements</span> <span class="o">+=</span> <span class="n">rxn_el</span><span class="o">.</span><span class="n">bhandles</span>
            <span class="n">select_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_el</span><span class="o">.</span><span class="n">center_el</span><span class="p">)</span>
            <span class="c1"># Update reactions on whether they are selected</span>
            <span class="n">rxn_el</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="n">rxn_el</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">new_sel_reactions</span>

        <span class="k">for</span> <span class="n">plugin_el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plugin_elements</span><span class="p">:</span>
            <span class="n">select_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugin_el</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_model_elements</span> <span class="o">=</span> <span class="n">SortedKeyList</span><span class="p">(</span><span class="n">select_elements</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetSelectedNodes</span><span class="p">(),</span>
                                <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">index</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateSelectBoxLayer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">related_elts</span> <span class="o">=</span> <span class="n">select_elements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widget_elements</span> <span class="o">=</span> <span class="n">SortedKeyList</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_elements</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateSelectedLists</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>

        <span class="n">post_event</span><span class="p">(</span><span class="n">CanvasDidUpdateEvent</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">GetCompartment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Compartment</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">comp_idx</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">comp</span>

        <span class="k">return</span> <span class="n">Optional</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_SetStatusText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_status</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_bar</span><span class="o">.</span><span class="n">SetStatusText</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SetOriginPos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the origin position (position of the topleft corner) to pos by scrolling.&quot;&quot;&quot;</span>
        <span class="c1"># check if out of bounds</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">realsize</span> <span class="o">*</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span> <span class="o">-</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetSize</span><span class="p">())</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">reduce2</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span><span class="o">.</span><span class="n">elem_div</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetScrollPixelsPerUnit</span><span class="p">()))</span>
        <span class="c1"># need to mult by scale here since self.VirtualPosition is artificially increased, per</span>
        <span class="c1"># scale * self.realsize</span>
        <span class="c1">#self.Scroll(*pos)</span>
        <span class="n">pos_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">pos_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pos_item</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos_item</span> <span class="ow">in</span> <span class="n">pos_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Scroll</span><span class="p">(</span><span class="o">*</span><span class="n">pos_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetOverlayPositions</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">zoom_level</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zoom_level</span>

    <span class="k">def</span> <span class="nf">SetZoomLevel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zoom</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">anchor</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Zoom in/out with the given anchor.</span>

<span class="sd">        The anchor point stays at the same relative position after</span>
<span class="sd">        zooming. Note that the anchor position is scrolled position,</span>
<span class="sd">        i.e. device position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">zoom</span> <span class="o">&lt;</span> <span class="n">Canvas</span><span class="o">.</span><span class="n">MIN_ZOOM_LEVEL</span> <span class="ow">or</span> <span class="n">zoom</span> <span class="o">&gt;</span> <span class="n">Canvas</span><span class="o">.</span><span class="n">MAX_ZOOM_LEVEL</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Zoom level must be between </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">. Got </span><span class="si">{}</span><span class="s1"> instead.&#39;</span><span class="p">,</span>
                             <span class="n">Canvas</span><span class="o">.</span><span class="n">MIN_ZOOM_LEVEL</span><span class="p">,</span> <span class="n">Canvas</span><span class="o">.</span><span class="n">MAX_ZOOM_LEVEL</span><span class="p">,</span> <span class="n">zoom</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zoom_level</span> <span class="o">=</span> <span class="n">zoom</span>
        <span class="n">old_scale</span> <span class="o">=</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">1.2</span> <span class="o">**</span> <span class="n">zoom</span>

        <span class="c1"># adjust scroll position</span>
        <span class="n">logical</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcUnscrolledPosition</span><span class="p">(</span><span class="n">anchor</span><span class="o">.</span><span class="n">to_wx_point</span><span class="p">()))</span>
        <span class="n">scaled</span> <span class="o">=</span> <span class="n">logical</span> <span class="o">*</span> <span class="p">(</span><span class="n">cstate</span><span class="o">.</span><span class="n">scale</span> <span class="o">/</span> <span class="n">old_scale</span><span class="p">)</span>
        <span class="n">newanchor</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcScrolledPosition</span><span class="p">(</span><span class="n">scaled</span><span class="o">.</span><span class="n">to_wx_point</span><span class="p">()))</span>
        <span class="c1"># the amount of shift needed to keep anchor at the same position</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">newanchor</span> <span class="o">-</span> <span class="n">anchor</span>
        <span class="n">cur_scroll</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcUnscrolledPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">new_scroll</span> <span class="o">=</span> <span class="n">cur_scroll</span> <span class="o">+</span> <span class="n">shift</span>
        <span class="c1"># convert to scroll units</span>
        <span class="n">new_scroll</span> <span class="o">=</span> <span class="n">new_scroll</span><span class="o">.</span><span class="n">elem_div</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetScrollPixelsPerUnit</span><span class="p">()))</span>

        <span class="n">vsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">realsize</span> <span class="o">*</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetVirtualSize</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">vsize</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">vsize</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

        <span class="c1"># Important: set virtual size first, then scroll</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Scroll</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">new_scroll</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_scroll</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zoom_slider</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zoom_level</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom_slider</span><span class="o">.</span><span class="n">SetPageSize</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_SetStatusText</span><span class="p">(</span><span class="s1">&#39;zoom&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{:.2f}</span><span class="s1">x&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cstate</span><span class="o">.</span><span class="n">scale</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ZoomCenter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zooming_in</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Zoom in on the center of the visible window.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">IncrementZoom</span><span class="p">(</span><span class="n">zooming_in</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetSize</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">IncrementZoom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zooming_in</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">anchor</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Zoom in/out by one step on the anchor, if within zoom range.&quot;&quot;&quot;</span>
        <span class="n">new_zoom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zoom_level</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">zooming_in</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_zoom</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MIN_ZOOM_LEVEL</span> <span class="ow">or</span> <span class="n">new_zoom</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_ZOOM_LEVEL</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetZoomLevel</span><span class="p">(</span><span class="n">new_zoom</span><span class="p">,</span> <span class="n">anchor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ResetZoom</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the zoom level, with the anchor on the center of the visible window.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetZoomLevel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetSize</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">FitNodeSizeToText</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">WindowDC</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">gc</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
        <span class="n">min_w</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_width&#39;</span><span class="p">)</span>
        <span class="n">min_h</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_height&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="c1"># TODO set font</span>
                <span class="n">tp</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">composite_shape</span><span class="o">.</span><span class="n">text_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">font</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">FontInfo</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">font_size</span><span class="p">)</span>
                               <span class="o">.</span><span class="n">Family</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">font_family</span><span class="p">)</span>
                               <span class="o">.</span><span class="n">Style</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">font_style</span><span class="p">)</span>
                               <span class="o">.</span><span class="n">Weight</span><span class="p">(</span><span class="n">tp</span><span class="o">.</span><span class="n">font_weight</span><span class="p">))</span>
                <span class="n">gfont</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreateFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
                <span class="n">gc</span><span class="o">.</span><span class="n">SetFont</span><span class="p">(</span><span class="n">gfont</span><span class="p">)</span>
                <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">GetFullTextExtent</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">+=</span> <span class="mi">20</span>
                <span class="n">h</span> <span class="o">+=</span> <span class="mi">10</span>
                <span class="n">w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">min_w</span><span class="p">)</span>
                <span class="n">h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">min_h</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_GetUniqueName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Given a base name &quot;x&quot;, try &quot;x_0&quot;, &quot;x_1&quot;, ... until it is unique in all the collections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># keep incrementing as long as there is duplicate ID</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">increment</span><span class="p">)</span>

            <span class="n">cur_id</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">suffix</span>

            <span class="k">if</span> <span class="n">cur_id</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">increment</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cur_id</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
                    <span class="n">increment</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># loop finished normally; done</span>
                <span class="k">return</span> <span class="n">cur_id</span>

    <span class="k">def</span> <span class="nf">OnLeftDown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">device_pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>
            <span class="n">logical_pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcUnscrolledPosition</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()))</span> <span class="o">/</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span>

            <span class="c1"># Check if clicked on overlay using device_pos</span>
            <span class="n">overlay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_InWhichOverlay</span><span class="p">(</span><span class="n">device_pos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">overlay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">overlay</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">overlay</span><span class="o">.</span><span class="n">OnLeftDown</span><span class="p">(</span><span class="n">device_pos</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">for</span> <span class="n">ol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overlays</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">overlay</span> <span class="ow">and</span> <span class="n">ol</span><span class="o">.</span><span class="n">hovering</span><span class="p">:</span>
                    <span class="n">ol</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ElementsHighToLow</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">pos_inside</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span> <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">on_left_down</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="o">=</span> <span class="n">el</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_last_drag_pos</span> <span class="o">=</span> <span class="n">logical_pos</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># variables for keeping track if clicked on a selectable element</span>
                <span class="n">node</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Node</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">rxn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Reaction</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">comp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Compartment</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">rxn_center</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ReactionCenter</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">,</span> <span class="n">NodeElement</span><span class="p">):</span>
                    <span class="n">n_elem</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">NodeElement</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">)</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">n_elem</span><span class="o">.</span><span class="n">node</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">,</span> <span class="n">ReactionElement</span><span class="p">):</span>
                    <span class="n">r_elem</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">ReactionElement</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">)</span>
                    <span class="n">rxn</span> <span class="o">=</span> <span class="n">r_elem</span><span class="o">.</span><span class="n">reaction</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">,</span> <span class="n">CompartmentElt</span><span class="p">):</span>
                    <span class="n">c_elem</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">CompartmentElt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">)</span>
                    <span class="n">comp</span> <span class="o">=</span> <span class="n">c_elem</span><span class="o">.</span><span class="n">compartment</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">,</span> <span class="n">ReactionCenter</span><span class="p">):</span>
                    <span class="n">rxn_center</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">ReactionCenter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">)</span>
                    <span class="n">rxn</span> <span class="o">=</span> <span class="n">rxn_center</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">reaction</span>

                <span class="c1"># not resizing or dragging</span>
                <span class="k">if</span> <span class="n">cstate</span><span class="o">.</span><span class="n">multi_select</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rxn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectGroupEvent</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">rxn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">})</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                        <span class="k">elif</span> <span class="n">node</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">})</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                        <span class="k">elif</span> <span class="n">comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">})</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="c1"># clear selected nodes</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">cstate</span><span class="o">.</span><span class="n">multi_select</span><span class="p">:</span>
                    <span class="c1"># if clicked on a new node/compartment, immediately allow dragging on the</span>
                    <span class="c1"># updated select box</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">node</span> <span class="ow">or</span> <span class="n">comp</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">pos_inside</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">on_mouse_enter</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span>
                        <span class="n">good</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">on_left_down</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">good</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_FloatNodes</span><span class="p">()</span>
                        <span class="k">return</span>

                <span class="c1"># clicked on nothing; drag-selecting</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_drag_selecting</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_drag_select_start</span> <span class="o">=</span> <span class="n">logical_pos</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_drag_select_start</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_nodes_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_rxns_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_comps_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">,</span> <span class="n">SelectBox</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_FloatNodes</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">ADD_NODES</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_width&#39;</span><span class="p">),</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_height&#39;</span><span class="p">))</span>

                <span class="n">unscaled_pos</span> <span class="o">=</span> <span class="n">logical_pos</span>
                <span class="n">adj_pos</span> <span class="o">=</span> <span class="n">unscaled_pos</span> <span class="o">-</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">2</span>

                <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
                    <span class="s1">&#39;x&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span>
                    <span class="n">pos</span><span class="o">=</span><span class="n">adj_pos</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
                    <span class="c1"># fill_color=get_theme(&#39;node_fill&#39;),</span>
                    <span class="c1"># border_color=get_theme(&#39;node_border&#39;),</span>
                    <span class="c1"># border_width=get_theme(&#39;node_border_width&#39;),</span>
                    <span class="n">comp_idx</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RectInWhichCompartment</span><span class="p">(</span><span class="n">Rect</span><span class="p">(</span><span class="n">adj_pos</span><span class="p">,</span> <span class="n">size</span><span class="p">)),</span>
                    <span class="n">floatingNode</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">lockNode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">clamp_rect_pos</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="n">Rect</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="p">),</span> <span class="n">BOUNDS_EPS</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetUniqueName</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">])</span>

                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                    <span class="n">nodei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">add_node_g</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                    <span class="n">fill_color</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_fill&#39;</span><span class="p">)</span>
                    <span class="n">border_color</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_border&#39;</span><span class="p">)</span>
                    <span class="n">border_width</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_border_width&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_fill_rgb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">fill_color</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_fill_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">fill_color</span><span class="o">.</span><span class="n">Alpha</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_border_rgb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">border_color</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_border_alpha</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">border_color</span><span class="o">.</span><span class="n">Alpha</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_border_width</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">border_width</span><span class="p">)</span>

                <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_node_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectGroupEvent</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="n">index</span><span class="p">})</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">ADD_COMPARTMENTS</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drag_selecting</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drag_select_start</span> <span class="o">=</span> <span class="n">logical_pos</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_drag_select_start</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_nodes_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">ZOOM</span><span class="p">:</span>
                <span class="n">zooming_in</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">wx</span><span class="o">.</span><span class="n">GetKeyState</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">WXK_SHIFT</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">IncrementZoom</span><span class="p">(</span><span class="n">zooming_in</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">device_pos</span><span class="p">))</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_RedrawDynamicToBuffer</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>
            <span class="n">evt</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SetFocus</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_FloatNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper that temporarily resets the layer of the nodes being dragged.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes_floating</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes_floating</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Only &quot;float&quot; if only nodes (and possibly reactions) are selected.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">node_elements</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">NodeElement</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_elements</span><span class="p">:</span>
            <span class="n">elt</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">NodeElement</span><span class="p">,</span> <span class="n">elt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">elt</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="p">:</span>
                <span class="n">node_elements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">node_elements</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ResetLayer</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DRAGGED_NODE_LAYER</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_UnfloatNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Only &quot;float&quot; if only nodes (and possibly reactions) are selected.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_elements</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ResetLayer</span><span class="p">(</span><span class="n">elt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NODE_LAYER</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OnLeftUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_EndDrag</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
            <span class="c1"># self._UnfloatNodes()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nodes_floating</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>
            <span class="n">evt</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnRightUp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Right mouse button up event handler.</span>

<span class="sd">        Note that the handling of the right click up event is determined by the canvas rather</span>
<span class="sd">        than by the individual elements.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">device_pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>
        <span class="n">logical_pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcUnscrolledPosition</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()))</span> <span class="o">/</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span>

        <span class="n">overlay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_InWhichOverlay</span><span class="p">(</span><span class="n">device_pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overlay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">node_el</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">NodeElement</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">reaction_el</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ReactionElement</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comp_el</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompartmentElt</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ElementsHighToLow</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">pos_inside</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">NodeElement</span><span class="p">):</span>
                    <span class="n">node_el</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">NodeElement</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">ReactionElement</span><span class="p">):</span>
                    <span class="n">reaction_el</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">ReactionElement</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">CompartmentElt</span><span class="p">):</span>
                    <span class="n">comp_el</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">CompartmentElt</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="n">on_selected</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Whether clicked on a selected element.</span>
        <span class="n">selected_nodes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">selected_reactions</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">selected_comps</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node_el</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node_el</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="p">:</span>
                <span class="n">on_selected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node_el</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">reaction_el</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reaction_el</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="p">:</span>
                <span class="n">on_selected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_reactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reaction_el</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">comp_el</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comp_el</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="p">:</span>
                <span class="n">on_selected</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selected_comps</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">comp_el</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">on_selected</span><span class="p">:</span>
            <span class="c1"># If right-clicked on selected element, then don&#39;t need to update anything, but only</span>
            <span class="c1"># need to populate right-clicked element lists.</span>
            <span class="n">selected_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
            <span class="n">selected_reactions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
            <span class="n">selected_comps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If right-clicked on something not selected, update selected indices.</span>
            <span class="n">cur_selected</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="p">)</span> <span class="o">+</span>
                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="p">))</span>
            <span class="n">new_selected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_nodes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_reactions</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_comps</span><span class="p">)</span>
            <span class="c1"># If nothing is selected before or after, don&#39;t update anything</span>
            <span class="k">if</span> <span class="n">cur_selected</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">new_selected</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectGroupEvent</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">selected_nodes</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">selected_reactions</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">selected_comps</span><span class="p">)</span>

        <span class="c1"># Whether clicked on something?</span>
        <span class="n">total_selected</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_nodes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_reactions</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_comps</span><span class="p">)</span>
        <span class="n">menu</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>

        <span class="c1"># def add_item(menu: wx.Menu, menu_name, callback):</span>
        <span class="c1">#    qmi = wx.MenuItem(menu, -1, menu_name)</span>
        <span class="c1">#    #qmi.SetBitmap(wx.Bitmap(&#39;exit.png&#39;))</span>
        <span class="c1">#    id_ = menu.Append(qmi) # (-1, menu_name).Id</span>
        <span class="c1">#    menu.Bind(wx.EVT_MENU, lambda _: callback(), id=id_)</span>

        <span class="k">def</span> <span class="nf">add_item</span><span class="p">(</span><span class="n">menu</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Menu</span><span class="p">,</span> <span class="n">menu_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">image_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">menu</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">menu_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">image_name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">SetBitmap</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Bitmap</span><span class="p">(</span><span class="n">resource_path</span><span class="p">(</span><span class="n">image_name</span><span class="p">)))</span>
            <span class="n">menu</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_MENU</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">callback</span><span class="p">(),</span> <span class="nb">id</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">Id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">total_selected</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_item</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="s1">&#39;Delete&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">DeleteSelectedItems</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">menu</span><span class="o">.</span><span class="n">AppendSeparator</span><span class="p">()</span>
            <span class="n">add_item</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="s1">&#39;Create Alias&#39;</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">CreateAliases</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_to_rxn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">menu</span><span class="p">,</span> <span class="s1">&#39;Split on Reactions&#39;</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">SplitAliasesOnReactions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="c1"># Only allow align when the none of the nodes are in a compartment. This prevents</span>
            <span class="c1"># nodes inside a compartment being arranged outside.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">comp_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span><span class="p">):</span>
                <span class="c1"># Only allow alignment if all selected nodes are in the same compartment</span>
                <span class="c1"># Add alignment options</span>

                <span class="n">menu</span><span class="o">.</span><span class="n">AppendSeparator</span><span class="p">()</span>
                <span class="n">align_menu</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">align_menu</span><span class="p">,</span> <span class="s1">&#39;Align Left&#39;</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignSelectedNodes</span><span class="p">(</span><span class="n">Alignment</span><span class="o">.</span><span class="n">LEFT</span><span class="p">),</span>
                         <span class="s1">&#39;alignLeft_XP.png&#39;</span><span class="p">)</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">align_menu</span><span class="p">,</span> <span class="s1">&#39;Align Right&#39;</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignSelectedNodes</span><span class="p">(</span><span class="n">Alignment</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">),</span>
                         <span class="s1">&#39;alignRight_XP.png&#39;</span><span class="p">)</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">align_menu</span><span class="p">,</span> <span class="s1">&#39;Align Center&#39;</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignSelectedNodes</span><span class="p">(</span><span class="n">Alignment</span><span class="o">.</span><span class="n">CENTER</span><span class="p">),</span>
                         <span class="s1">&#39;alignHorizCenter_XP.png&#39;</span><span class="p">)</span>
                <span class="n">align_menu</span><span class="o">.</span><span class="n">AppendSeparator</span><span class="p">()</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">align_menu</span><span class="p">,</span> <span class="s1">&#39;Align Top&#39;</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignSelectedNodes</span><span class="p">(</span><span class="n">Alignment</span><span class="o">.</span><span class="n">TOP</span><span class="p">),</span>
                         <span class="s1">&#39;alignTop_XP.png&#39;</span><span class="p">)</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">align_menu</span><span class="p">,</span> <span class="s1">&#39;Align Bottom&#39;</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignSelectedNodes</span><span class="p">(</span><span class="n">Alignment</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">),</span>
                         <span class="s1">&#39;AlignBottom_XP.png&#39;</span><span class="p">)</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">align_menu</span><span class="p">,</span> <span class="s1">&#39;Align Middle&#39;</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignSelectedNodes</span><span class="p">(</span><span class="n">Alignment</span><span class="o">.</span><span class="n">MIDDLE</span><span class="p">),</span>
                         <span class="s1">&#39;alignVertCenter_XP.png&#39;</span><span class="p">)</span>
                <span class="n">align_menu</span><span class="o">.</span><span class="n">AppendSeparator</span><span class="p">()</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">align_menu</span><span class="p">,</span> <span class="s1">&#39;Grid&#39;</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignSelectedNodes</span><span class="p">(</span><span class="n">Alignment</span><span class="o">.</span><span class="n">GRID</span><span class="p">),</span>
                         <span class="s1">&#39;alignOnGrid_XP.png&#39;</span><span class="p">)</span>
                <span class="n">align_menu</span><span class="o">.</span><span class="n">AppendSeparator</span><span class="p">()</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">align_menu</span><span class="p">,</span> <span class="s1">&#39;Arrange Horizontally&#39;</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignSelectedNodes</span><span class="p">(</span><span class="n">Alignment</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">),</span>
                         <span class="s1">&#39;alignHorizEqually_XP.png&#39;</span><span class="p">)</span>
                <span class="n">add_item</span><span class="p">(</span><span class="n">align_menu</span><span class="p">,</span> <span class="s1">&#39;Arrange Vertically&#39;</span><span class="p">,</span>
                         <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">AlignSelectedNodes</span><span class="p">(</span><span class="n">Alignment</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">),</span>
                         <span class="s1">&#39;alignVertEqually_XP.png&#39;</span><span class="p">)</span>
                <span class="n">menu</span><span class="o">.</span><span class="n">AppendSubMenu</span><span class="p">(</span><span class="n">align_menu</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s1">&#39;Align...&#39;</span><span class="p">)</span>

        <span class="c1"># Must refresh before the context menu is displayed, otherwise the refresh won&#39;t occur</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Refresh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PopupMenu</span><span class="p">(</span><span class="n">menu</span><span class="p">)</span>
        <span class="n">menu</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">CreateAliases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
        <span class="n">new_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="n">alias_pos</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">Vec2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">comp_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_idx_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">comp_idx</span><span class="p">]</span>
                    <span class="n">alias_pos</span> <span class="o">=</span> <span class="n">clamp_rect_pos</span><span class="p">(</span><span class="n">Rect</span><span class="p">(</span><span class="n">alias_pos</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">comp</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span>

                <span class="n">new_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">add_alias_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                                         <span class="n">alias_pos</span><span class="p">,</span>
                                                         <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">new_indices</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="n">new_indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">SplitAliasesOnReactions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">):</span>
        <span class="n">rea_els</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span> <span class="k">for</span> <span class="n">re</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_to_rxn</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">]]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="c1"># exclude the first reaction</span>
            <span class="k">for</span> <span class="n">rea_el</span> <span class="ow">in</span> <span class="n">rea_els</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">reaction</span> <span class="o">=</span> <span class="n">rea_el</span><span class="o">.</span><span class="n">reaction</span>
                <span class="n">alias_pos</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">*</span> <span class="mf">0.8</span> <span class="o">+</span> <span class="n">rea_el</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">real_center</span> <span class="o">*</span> <span class="mf">0.2</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">comp_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_idx_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">comp_idx</span><span class="p">]</span>
                    <span class="n">alias_pos</span> <span class="o">=</span> <span class="n">clamp_rect_pos</span><span class="p">(</span><span class="n">Rect</span><span class="p">(</span><span class="n">alias_pos</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">comp</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span>

                <span class="c1"># move node position slightly toward the position of the reaction</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">alias_for_reaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                                   <span class="n">alias_pos</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetBoundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Rect</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the bounding rectangle of all nodes, reactions, and compartments.</span>

<span class="sd">        Returns None if there are no nodes, reactions, or compartments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_elements</span><span class="p">:</span>
            <span class="n">rects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">bounding_rect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span><span class="p">:</span>
            <span class="n">rects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">bounding_rect</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartment_elements</span><span class="p">:</span>
            <span class="n">rects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="o">.</span><span class="n">bounding_rect</span><span class="p">())</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_bounding_rect</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">findMinX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the left-most node&#39;s x position</span>
<span class="sd">        Args:</span>
<span class="sd">            self</span>
<span class="sd">            l: the list of indices of the selected nodes</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">findMaxX</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the right-most node&#39;s x position</span>
<span class="sd">        Args:</span>
<span class="sd">            self</span>
<span class="sd">            l: the list of indices of the selected nodes</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">findMinY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the left-most node&#39;s x position</span>
<span class="sd">        Args:</span>
<span class="sd">            self</span>
<span class="sd">            l: the list of indices of the selected nodes</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">findMaxY</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the right-most node&#39;s x position</span>
<span class="sd">        Args:</span>
<span class="sd">            self</span>
<span class="sd">            l: the list of indices of the selected nodes</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_DefaultHandlePositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rea_el</span><span class="p">:</span> <span class="n">ReactionElement</span><span class="p">):</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">rea_el</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">real_center</span>
        <span class="n">reactants</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_idx_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rea_el</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">sources</span><span class="p">]</span>
        <span class="n">products</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_idx_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rea_el</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">targets</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">default_handle_positions</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">reactants</span><span class="p">,</span> <span class="n">products</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setDefaultHandles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">r_el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">r_el</span><span class="o">.</span><span class="n">reaction</span>
                <span class="n">handles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DefaultHandlePositions</span><span class="p">(</span><span class="n">r_el</span><span class="p">)</span>  <span class="c1"># centroid, sources, target</span>
                <span class="n">sources</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sources</span>
                <span class="n">targets</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">targets</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_center_handle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">handles</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_src_node_handle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">handles</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_dest_node_handle</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">handles</span><span class="p">[</span><span class="n">count</span><span class="p">])</span>
                    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">AlignSelectedNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alignment</span><span class="p">:</span> <span class="n">Alignment</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Align the selected nodes. Should be called only when *only* nodes are selected.&quot;&quot;&quot;</span>
        <span class="c1"># The selected nodes are self.sel_nodes</span>
        <span class="c1"># To access a file in the resources folder, use</span>
        <span class="c1"># Jin_edit:refer to plugins/arrange.py</span>

        <span class="n">sel_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span>
        <span class="k">if</span> <span class="n">alignment</span> <span class="o">==</span> <span class="n">Alignment</span><span class="o">.</span><span class="n">LEFT</span><span class="p">:</span>
            <span class="c1"># Align selected nodes to the left-most node&#39;s x position</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="n">xpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findMinX</span><span class="p">(</span><span class="n">sel_nodes</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">sel_nodes</span><span class="p">:</span>
                    <span class="n">newPos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">newPos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultHandles</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">alignment</span> <span class="o">==</span> <span class="n">Alignment</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Align selected nodes to the right-most node&#39;s x position</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="n">xpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findMaxX</span><span class="p">(</span><span class="n">sel_nodes</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span><span class="p">:</span>
                    <span class="n">newPos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">newPos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultHandles</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">alignment</span> <span class="o">==</span> <span class="n">Alignment</span><span class="o">.</span><span class="n">CENTER</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Align selected nodes to the relative center of the x positions of the nodes</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="n">xMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findMinX</span><span class="p">(</span><span class="n">sel_nodes</span><span class="p">)</span>
                <span class="n">xMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findMaxX</span><span class="p">(</span><span class="n">sel_nodes</span><span class="p">)</span>
                <span class="n">xpos</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">xMax</span> <span class="o">+</span> <span class="n">xMin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">sel_nodes</span><span class="p">:</span>
                    <span class="n">newPos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">xpos</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">newPos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultHandles</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">alignment</span> <span class="o">==</span> <span class="n">Alignment</span><span class="o">.</span><span class="n">TOP</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="n">ypos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findMinY</span><span class="p">(</span><span class="n">sel_nodes</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span><span class="p">:</span>
                    <span class="n">newPos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ypos</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">newPos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultHandles</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">alignment</span> <span class="o">==</span> <span class="n">Alignment</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="n">ypos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findMaxY</span><span class="p">(</span><span class="n">sel_nodes</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span><span class="p">:</span>
                    <span class="n">newPos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ypos</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">newPos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultHandles</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">alignment</span> <span class="o">==</span> <span class="n">Alignment</span><span class="o">.</span><span class="n">MIDDLE</span><span class="p">:</span>
            <span class="c1"># Align selected nodes to the relative center of the x positions of the nodes</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="n">yMin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findMinY</span><span class="p">(</span><span class="n">sel_nodes</span><span class="p">)</span>
                <span class="n">yMax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findMaxY</span><span class="p">(</span><span class="n">sel_nodes</span><span class="p">)</span>
                <span class="n">ypos</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">yMax</span> <span class="o">+</span> <span class="n">yMin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">sel_nodes</span><span class="p">:</span>
                    <span class="n">newPos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">ypos</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">newPos</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultHandles</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">alignment</span> <span class="o">==</span> <span class="n">Alignment</span><span class="o">.</span><span class="n">GRID</span><span class="p">:</span>
            <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">            Align selected nodes in a net grid manner</span>
<span class="sd">            &#39;&#39;&#39;</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="n">x</span> <span class="o">=</span> <span class="mi">40</span>
                <span class="n">y</span> <span class="o">=</span> <span class="mi">40</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">sel_nodes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">130</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">130</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="mi">40</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultHandles</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">alignment</span> <span class="o">==</span> <span class="n">Alignment</span><span class="o">.</span><span class="n">HORIZONTAL</span><span class="p">:</span>

            <span class="c1"># Sort the selected nodes in x position ascending order</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sel_nodes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

            <span class="c1"># find the average distance beteeen the selected nodes</span>
            <span class="n">averageDistance</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
                <span class="n">node2</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">node1</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="n">averageDistance</span> <span class="o">+=</span> <span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">node1</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">node2</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
            <span class="n">averageDistance</span> <span class="o">=</span> <span class="n">averageDistance</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="c1"># x = Position of left most node</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
                <span class="c1"># Arrange nodes with equal distance between them</span>
                <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
                    <span class="n">newPos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">newPos</span><span class="p">)</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">averageDistance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultHandles</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">alignment</span> <span class="o">==</span> <span class="n">Alignment</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">:</span>

            <span class="c1"># Sort the selected nodes in y position ascending order</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">sel_nodes</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

            <span class="c1"># find the average distance beteeen the selected nodes</span>
            <span class="n">averageDistance</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
                <span class="n">node2</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">node1</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span>
                <span class="n">averageDistance</span> <span class="o">+=</span> <span class="p">(</span><span class="n">node1</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">node1</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">node2</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
            <span class="n">averageDistance</span> <span class="o">=</span> <span class="n">averageDistance</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="c1"># y = Position of top most node</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
                <span class="c1"># Arrange nodes with equal distance between them</span>
                <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)):</span>
                    <span class="n">newPos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">nodes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">newPos</span><span class="p">)</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">averageDistance</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setDefaultHandles</span><span class="p">()</span>

    <span class="c1"># TODO improve this. we might want a special mouseLeftWindow event</span>
    <span class="k">def</span> <span class="nf">_EndDrag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">MouseEvent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send the updated node positions and sizes to the controller.</span>

<span class="sd">        This is called after a dragging operation has completed in OnLeftUp or OnLeaveWindow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">device_pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>
        <span class="n">overlay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_InWhichOverlay</span><span class="p">(</span><span class="n">device_pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">dragging</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">OnLeftUp</span><span class="p">(</span><span class="n">device_pos</span><span class="p">)</span>
            <span class="c1"># HACK once we integrate overlays (e.g. minimap) as CanvasElements, we can simply call</span>
            <span class="c1"># on_mouse_leave or something</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">hovering</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_selecting</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drag_selecting</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_nodes_idx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_rxns_idx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_comps_idx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_nodes_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_rxns_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_comps_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">ADD_COMPARTMENTS</span><span class="p">:</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetUniqueName</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span><span class="p">])</span>

                <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span><span class="o">.</span><span class="n">size</span>
                <span class="c1"># make sure the compartment is at least of some size</span>
                <span class="n">adj_size</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;min_comp_width&#39;</span><span class="p">)),</span>
                                <span class="nb">max</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;min_comp_height&#39;</span><span class="p">)))</span>
                <span class="c1"># compute position</span>
                <span class="n">size_diff</span> <span class="o">=</span> <span class="n">adj_size</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span><span class="o">.</span><span class="n">size</span>
                <span class="c1"># center position if drag_rect size has been adjusted</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">size_diff</span> <span class="o">/</span> <span class="mi">2</span>

                <span class="n">comp</span> <span class="o">=</span> <span class="n">Compartment</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span>
                                   <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_index</span><span class="p">,</span>
                                   <span class="n">net_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span>
                                   <span class="n">nodes</span><span class="o">=</span><span class="nb">list</span><span class="p">(),</span>
                                   <span class="n">volume</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">position</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span>
                                   <span class="n">size</span><span class="o">=</span><span class="n">adj_size</span><span class="p">,</span>
                                   <span class="n">fill</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;comp_fill&#39;</span><span class="p">),</span>
                                   <span class="n">border</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;comp_border&#39;</span><span class="p">),</span>
                                   <span class="n">border_width</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;comp_border_width&#39;</span><span class="p">),</span>
                                   <span class="p">)</span>
                <span class="c1"># clip position</span>
                <span class="n">comp</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">clamp_rect_pos</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="n">Rect</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="p">),</span> <span class="n">BOUNDS_EPS</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">add_compartment_g</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">:</span>
            <span class="c1"># perform left_up on dragged_element if it exists, or just find the node under the</span>
            <span class="c1"># cursor</span>
            <span class="n">logical_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CalcScrolledPositionFloat</span><span class="p">(</span><span class="n">device_pos</span><span class="p">)</span> <span class="o">/</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="o">.</span><span class="n">on_left_up</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span><span class="o">.</span><span class="n">on_mouse_leave</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">evt</span><span class="o">.</span><span class="n">LeftIsDown</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ElementsHighToLow</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">pos_inside</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span> <span class="ow">and</span> <span class="n">el</span><span class="o">.</span><span class="n">on_left_up</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">):</span>
                        <span class="k">return</span>

        <span class="k">if</span> <span class="n">overlay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">overlay</span><span class="o">.</span><span class="n">OnLeftUp</span><span class="p">(</span><span class="n">device_pos</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CalcScrolledPositionFloat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Vec2</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Convert logical position to scrolled (device) position, retaining floating point.</span>

<span class="sd">        self.CalcScrolledPosition() converts the input floats to ints. This is needed if better</span>
<span class="sd">        accuracy is needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcScrolledPosition</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="o">+</span> <span class="n">pos</span>

    <span class="k">def</span> <span class="nf">CalcUnscrolledPositionFloat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Vec2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcUnscrolledPosition</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="o">+</span> <span class="n">pos</span>

    <span class="k">def</span> <span class="nf">OnMotion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_motion</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_motion</span> <span class="o">=</span> <span class="n">now</span>

        <span class="c1"># Update cursor status text here</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_logical_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rounded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_logical_pos</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">status_text</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">rounded</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_SetStatusText</span><span class="p">(</span><span class="s1">&#39;cursor&#39;</span><span class="p">,</span> <span class="n">status_text</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">MouseEvent</span><span class="p">)</span>
        <span class="n">redraw</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">device_pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">())</span>
            <span class="n">logical_pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcUnscrolledPosition</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()))</span> <span class="o">/</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_logical_pos</span> <span class="o">=</span> <span class="n">logical_pos</span>
            <span class="n">rxn_radius</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;reaction_radius&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_selecting</span><span class="p">:</span>
                <span class="c1"># assert evt.leftIsDown</span>
                <span class="n">topleft</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">logical_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_select_start</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                               <span class="nb">min</span><span class="p">(</span><span class="n">logical_pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_select_start</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
                <span class="n">botright</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">logical_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_select_start</span><span class="o">.</span><span class="n">x</span><span class="p">),</span>
                                <span class="nb">max</span><span class="p">(</span><span class="n">logical_pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_select_start</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">topleft</span><span class="p">,</span> <span class="n">botright</span> <span class="o">-</span> <span class="n">topleft</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">:</span>
                    <span class="n">selected_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span>
                                      <span class="k">if</span> <span class="n">rects_overlap</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">s_rect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span><span class="p">)]</span>
                    <span class="n">selected_comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span>
                                      <span class="k">if</span> <span class="n">rects_overlap</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span><span class="p">)]</span>
                    <span class="n">selected_rxns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">reaction</span> <span class="k">for</span> <span class="n">re</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span>
                                     <span class="k">if</span> <span class="n">rects_overlap</span><span class="p">(</span><span class="n">circle_bounds</span><span class="p">(</span>
                                         <span class="n">re</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">real_center</span><span class="p">,</span> <span class="n">rxn_radius</span><span class="p">),</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span><span class="p">)]</span>
                    <span class="n">new_drag_sel_nodes_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">selected_nodes</span><span class="p">)</span>
                    <span class="n">new_drag_sel_rxns_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">selected_rxns</span><span class="p">)</span>
                    <span class="n">new_drag_sel_comps_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">selected_comps</span><span class="p">)</span>

                    <span class="n">reactions_updated</span> <span class="o">=</span> <span class="n">new_drag_sel_rxns_idx</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_rxns_idx</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">new_drag_sel_nodes_idx</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_nodes_idx</span> <span class="ow">or</span>
                            <span class="n">reactions_updated</span> <span class="ow">or</span>
                            <span class="n">new_drag_sel_comps_idx</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_comps_idx</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_nodes_idx</span> <span class="o">=</span> <span class="n">new_drag_sel_nodes_idx</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_rxns_idx</span> <span class="o">=</span> <span class="n">new_drag_sel_rxns_idx</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_comps_idx</span> <span class="o">=</span> <span class="n">new_drag_sel_comps_idx</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateSelectedLists</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">reactions_updated</span><span class="p">:</span>
                        <span class="c1"># If drag selected reactions changed, then update reaction selection state.</span>
                        <span class="n">all_selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_rxns_idx</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span><span class="p">:</span>
                            <span class="n">rel</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="n">rel</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">all_selected</span>
                <span class="k">elif</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">ADD_COMPARTMENTS</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">redraw</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">return</span>

            <span class="c1"># dragging takes priority here</span>
            <span class="k">if</span> <span class="n">evt</span><span class="o">.</span><span class="n">leftIsDown</span><span class="p">:</span>  <span class="c1"># dragging</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">rel_pos</span> <span class="o">=</span> <span class="n">logical_pos</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_drag_pos</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="o">.</span><span class="n">on_mouse_drag</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">):</span>
                        <span class="n">redraw</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_drag_pos</span> <span class="o">=</span> <span class="n">logical_pos</span>
                    <span class="c1"># If redrawing, i.e. dragged element moved, return immediately. Otherwise</span>
                    <span class="c1"># we need to check if the mouse is still inside the dragged element.</span>
                    <span class="c1"># The early return is for performance.</span>
                    <span class="k">if</span> <span class="n">redraw</span><span class="p">:</span>
                        <span class="k">return</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">dragging</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">OnMotion</span><span class="p">(</span><span class="n">device_pos</span><span class="p">,</span> <span class="n">evt</span><span class="o">.</span><span class="n">LeftIsDown</span><span class="p">())</span>
                    <span class="n">redraw</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">overlay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_InWhichOverlay</span><span class="p">(</span><span class="n">device_pos</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">overlay</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">overlay</span><span class="o">.</span><span class="n">OnMotion</span><span class="p">(</span><span class="n">device_pos</span><span class="p">,</span> <span class="n">evt</span><span class="o">.</span><span class="n">LeftIsDown</span><span class="p">())</span>
                    <span class="n">overlay</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">redraw</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># un-hover all other overlays TODO keep track of the currently hovering overlay</span>
                <span class="k">for</span> <span class="n">ol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overlays</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ol</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">overlay</span> <span class="ow">and</span> <span class="n">ol</span><span class="o">.</span><span class="n">hovering</span><span class="p">:</span>
                        <span class="n">ol</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">redraw</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Likely hovering on something else</span>
            <span class="n">hovered</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ElementsHighToLow</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">pos_inside</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">):</span>
                    <span class="n">hovered</span> <span class="o">=</span> <span class="n">el</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">ADD_NODES</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span><span class="p">,</span> <span class="n">CompartmentElt</span><span class="p">)</span>
                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hovered</span><span class="p">,</span> <span class="n">CompartmentElt</span><span class="p">)):</span>
                <span class="c1"># set redraw to True whenever input mode is ADD_NODES and mouse enters, exits,</span>
                <span class="c1"># or moves in a compartment. This is for updating the hightlight of the compartment.</span>
                <span class="c1"># (see CompartmentElt.on_paint).</span>
                <span class="n">redraw</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">hovered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hovered</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span><span class="p">:</span>
                <span class="n">moved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span><span class="o">.</span><span class="n">on_mouse_move</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span>
                <span class="n">redraw</span> <span class="o">=</span> <span class="n">redraw</span> <span class="ow">or</span> <span class="n">moved</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">redraw</span> <span class="o">=</span> <span class="n">redraw</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span><span class="o">.</span><span class="n">on_mouse_leave</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">hovered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">redraw</span> <span class="o">=</span> <span class="n">redraw</span> <span class="ow">or</span> <span class="n">hovered</span><span class="o">.</span><span class="n">on_mouse_enter</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hovered_element</span> <span class="o">=</span> <span class="n">hovered</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">redraw</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">LazyRefresh</span><span class="p">()</span>
            <span class="n">evt</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">FullRedraw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Function to signal that the entire canvas needs to be redrawn.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_static_bitmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LazyRefresh</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">LazyRefresh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_refresh</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MILLIS_PER_REFRESH</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">then_time</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">then_time</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_refresh</span><span class="p">:</span>
                    <span class="c1"># no refreshes since then; do the refresh now</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_last_refresh</span> <span class="o">=</span> <span class="n">then_time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Refresh</span><span class="p">()</span>

            <span class="n">wx</span><span class="o">.</span><span class="n">CallLater</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MILLIS_PER_REFRESH</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">callback</span><span class="p">(</span><span class="n">now</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_refresh</span> <span class="o">=</span> <span class="n">now</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Refresh</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">RedrawModelElements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Redraw the &#39;model&#39;, i.e. non-widget, elements, such as nodes and reactions. This is used</span>
<span class="sd">        for optimizing drawing.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">OnPaint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_accum_frames</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_fps_update</span>
        <span class="k">if</span> <span class="n">diff</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_last_fps_update</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
            <span class="n">fps</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_accum_frames</span> <span class="o">/</span> <span class="n">diff</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_SetStatusText</span><span class="p">(</span><span class="s1">&#39;fps&#39;</span><span class="p">,</span> <span class="s1">&#39;refreshes/sec: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fps</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_accum_frames</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetOverlayPositions</span><span class="p">()</span>  <span class="c1"># have to do this here to prevent jitters</span>

        <span class="n">dc</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">PaintDC</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># transform for drawing to scrolled coordinates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DoPrepareDC</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>

        <span class="c1"># Draw everything</span>
        <span class="n">gc</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">gc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static_bitmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># draw the whole thing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_RedrawDynamicToBuffer</span><span class="p">()</span>

        <span class="n">wpos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CalcUnscrolledPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">wsize</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetSize</span><span class="p">())</span>

        <span class="n">draw_rect</span><span class="p">(</span>
            <span class="n">gc</span><span class="p">,</span>
            <span class="n">Rect</span><span class="p">(</span><span class="n">wpos</span><span class="p">,</span> <span class="n">wsize</span><span class="p">),</span>
            <span class="n">fill</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;canvas_outside_bg&#39;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">subpos</span> <span class="o">=</span> <span class="n">wpos</span>
        <span class="c1"># sometimes the subbitmap might overflow. need to restrict its size to be within the canvas</span>
        <span class="n">subsize</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">subpos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">wsize</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">subpos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">wsize</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
        <span class="n">bitmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_static_bitmap</span><span class="o">.</span><span class="n">GetSubBitmap</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">subpos</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">subpos</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">subsize</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">subsize</span><span class="o">.</span><span class="n">y</span><span class="p">)))</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">DrawBitmap</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">wpos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">wpos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">GetWidth</span><span class="p">(),</span> <span class="n">bitmap</span><span class="o">.</span><span class="n">GetHeight</span><span class="p">())</span>
        <span class="c1"># draw dynamic elements</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">PushState</span><span class="p">()</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">cstate</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ElementsLowToHigh</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_elements</span> <span class="ow">and</span> <span class="n">elt</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="c1"># draw to static buffer</span>
                <span class="n">elt</span><span class="o">.</span><span class="n">on_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DrawVisualCuesToGC</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">PopState</span><span class="p">()</span>

        <span class="c1"># Draw minimap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_minimap</span><span class="o">.</span><span class="n">DoPaint</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>

        <span class="n">post_event</span><span class="p">(</span><span class="n">DidPaintCanvasEvent</span><span class="p">(</span><span class="n">gc</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">DrawActiveRectToImage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Draw to image only the active rectangle -- bounding rect of nodes, reactions, &amp; compartments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bounding_rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetBoundingRect</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bounding_rect</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">bounding_rect</span> <span class="o">=</span> <span class="n">padded_rect</span><span class="p">(</span><span class="n">bounding_rect</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="c1">#bounding_rect = wx.Rect(*bounding_rect.position, *bounding_rect.size)</span>
        <span class="n">pos_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bounding_rect</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="n">pos_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">pos_item</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos_item</span> <span class="ow">in</span> <span class="n">pos_list</span><span class="p">]</span>
        <span class="n">size_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">size_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">size_item</span><span class="p">)</span> <span class="k">for</span> <span class="n">size_item</span> <span class="ow">in</span> <span class="n">size_list</span><span class="p">]</span>
        <span class="n">bounding_rect</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="o">*</span><span class="n">pos_list</span><span class="p">,</span> <span class="o">*</span><span class="n">size_list</span><span class="p">)</span>
        <span class="n">bounding_rect</span><span class="o">.</span><span class="n">Intersect</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Rect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="p">))</span>

        <span class="n">bmp</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Bitmap</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="p">)</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MemoryDC</span><span class="p">()</span>
        <span class="n">dc</span><span class="o">.</span><span class="n">SelectObject</span><span class="p">(</span><span class="n">bmp</span><span class="p">)</span>
        <span class="n">gc</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DrawBackgroundToGC</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DrawModelToGC</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">bmp</span><span class="o">.</span><span class="n">ConvertToImage</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">GetSubImage</span><span class="p">(</span><span class="n">bounding_rect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">DrawBackgroundToGC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">):</span>
        <span class="c1"># # Draw gray background</span>
        <span class="c1"># draw_rect(</span>
        <span class="c1">#     gc,</span>
        <span class="c1">#     Rect(Vec2(0, 0), self.realsize + Vec2(10, 10)),</span>
        <span class="c1">#     fill=get_theme(&#39;canvas_outside_bg&#39;),</span>
        <span class="c1"># )</span>
        <span class="c1"># Draw background TODO move this before gc.Scale()</span>
        <span class="n">draw_rect</span><span class="p">(</span>
            <span class="n">gc</span><span class="p">,</span>
            <span class="n">Rect</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="p">),</span>
            <span class="n">fill</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;canvas_bg&#39;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">DrawModelToGC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elt</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="n">elt</span><span class="o">.</span><span class="n">on_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_GetReactionWidgets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rxn_elt</span><span class="p">:</span> <span class="n">ReactionElement</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">chain</span><span class="p">(</span><span class="n">rxn_elt</span><span class="o">.</span><span class="n">bhandles</span><span class="p">,</span> <span class="p">[</span><span class="n">rxn_elt</span><span class="o">.</span><span class="n">center_el</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_GetDynamicElements</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">]:</span>
        <span class="sd">&#39;&#39;&#39;Get the set of elements that will change, as self.dragged_element is dragged.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">elts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">,</span> <span class="n">SelectBox</span><span class="p">):</span>
            <span class="n">elts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">)</span>
            <span class="c1"># all the nodes that move along with the select box</span>
            <span class="n">node_idc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="o">.</span><span class="n">nodes</span><span class="p">],</span>
                <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="o">.</span><span class="n">peripheral_nodes</span><span class="p">]))</span>
            <span class="n">rxn_idc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_to_rxn</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span> <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="n">node_idc</span><span class="p">))</span>
            <span class="n">comp_idc</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span>

            <span class="n">elts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="n">CanvasElement</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_elements</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">node_idc</span><span class="p">]</span>
            <span class="n">elts</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="n">CanvasElement</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartment_elements</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">comp_idc</span><span class="p">]</span>

            <span class="c1"># add reactions</span>
            <span class="n">rxn_elts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">rxn_idc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rxn_elt</span> <span class="ow">in</span> <span class="n">rxn_elts</span><span class="p">:</span>
                <span class="n">elts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_elt</span><span class="p">)</span>
                <span class="n">elts</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetReactionWidgets</span><span class="p">(</span><span class="n">rxn_elt</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">,</span> <span class="n">ReactionCenter</span><span class="p">):</span>
            <span class="n">rxn_elt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">elts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_elt</span><span class="p">)</span>
            <span class="n">elts</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetReactionWidgets</span><span class="p">(</span><span class="n">rxn_elt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="p">,</span> <span class="n">BezierHandle</span><span class="p">):</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span>
            <span class="n">rxn_elts</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">ri</span><span class="p">]</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rxn_elts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">rxn_elt</span> <span class="o">=</span> <span class="n">rxn_elts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">elts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rxn_elt</span><span class="p">)</span>
            <span class="n">elts</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetReactionWidgets</span><span class="p">(</span><span class="n">rxn_elt</span><span class="p">)</span>
            <span class="c1"># TODO add</span>
            <span class="c1"># if isinstance(self.dragged_element, ReactionElement):</span>
            <span class="c1">#     rxn_elt = self.dragged_element</span>
            <span class="c1"># elif isinstance(self.dragged_element, ReactionCenter):</span>
            <span class="c1">#     rxn_elt = self.dragged_element.parent</span>
            <span class="c1"># elif isinstance(self.dragged_element, BezierHandle):</span>
            <span class="c1">#     # TODO add twin</span>
            <span class="c1">#     rxn_elt = self.dragged_element.reaction</span>

            <span class="c1"># if rxn_elt is not None:</span>
            <span class="c1">#     elts.append(rxn_elt)</span>
            <span class="c1">#     elts += rxn_elt.bhandles</span>
            <span class="c1">#     elts.append(rxn_elt.center_el)</span>

        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">elts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_RedrawDynamicToBuffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetDynamicElements</span><span class="p">()</span>
        <span class="c1"># No dynamic elements; simply redraw everything by not populating _static_bitmap</span>

        <span class="n">temp_bitmap</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Bitmap</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">realsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">dc</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">MemoryDC</span><span class="p">()</span>
        <span class="n">dc</span><span class="o">.</span><span class="n">SelectObject</span><span class="p">(</span><span class="n">temp_bitmap</span><span class="p">)</span>
        <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">dc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">DrawBackgroundToGC</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">PushState</span><span class="p">()</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">Scale</span><span class="p">(</span><span class="n">cstate</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ElementsLowToHigh</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">elt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_elements</span> <span class="ow">and</span> <span class="n">elt</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="c1"># draw to static buffer</span>
                <span class="n">elt</span><span class="o">.</span><span class="n">on_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">PopState</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_static_bitmap</span> <span class="o">=</span> <span class="n">temp_bitmap</span>

    <span class="k">def</span> <span class="nf">_DrawCompartmentHighlight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="c1"># TODO this is not model</span>
        <span class="n">within_comp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">ADD_NODES</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_logical_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_width&#39;</span><span class="p">),</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_height&#39;</span><span class="p">))</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cursor_logical_pos</span> <span class="o">-</span> <span class="n">size</span><span class="o">/</span><span class="mi">2</span>
            <span class="n">within_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RectInWhichCompartment</span><span class="p">(</span><span class="n">Rect</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">special_mode</span> <span class="o">==</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">SMode</span><span class="o">.</span><span class="n">NODES_IN_ONE</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">dragged_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">within_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InWhichCompartment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">within_comp</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">within_comp</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartment_elements</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">elt</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">within_comp</span><span class="p">:</span>
                <span class="n">elt</span><span class="o">.</span><span class="n">highlight_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Should not reach here&#39;</span>


    <span class="k">def</span> <span class="nf">_DrawDragSelectionRect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_selecting</span><span class="p">:</span>
            <span class="n">fill</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span>
            <span class="n">border</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">]</span>
            <span class="n">bwidth</span><span class="p">:</span> <span class="nb">int</span>
            <span class="k">if</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">:</span>
                <span class="n">fill</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;drag_fill&#39;</span><span class="p">)</span>
                <span class="n">border</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;drag_border&#39;</span><span class="p">)</span>
                <span class="n">bwidth</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;drag_border_width&#39;</span><span class="p">)</span>
                <span class="n">corner_radius</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">elif</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">==</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">ADD_COMPARTMENTS</span><span class="p">:</span>
                <span class="n">fill</span> <span class="o">=</span> <span class="n">opacity_mul</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;comp_fill&#39;</span><span class="p">),</span> <span class="mf">0.3</span><span class="p">)</span>
                <span class="n">border</span> <span class="o">=</span> <span class="n">opacity_mul</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;comp_border&#39;</span><span class="p">),</span> <span class="mf">0.3</span><span class="p">)</span>
                <span class="n">bwidth</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;comp_border_width&#39;</span><span class="p">)</span>
                <span class="n">corner_radius</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;comp_corner_radius&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;Should not be _drag_selecting in any other input mode.&quot;</span>

            <span class="k">if</span> <span class="n">bwidth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">border</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">draw_rect</span><span class="p">(</span>
                <span class="n">gc</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rect</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span>
                <span class="n">border</span><span class="o">=</span><span class="n">border</span><span class="p">,</span>
                <span class="n">border_width</span><span class="o">=</span><span class="n">bwidth</span><span class="p">,</span>
                <span class="n">corner_radius</span><span class="o">=</span><span class="n">corner_radius</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">DrawVisualCuesToGC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Visual cues include reactant/product outlines, drag-selection rectangle, and</span>
<span class="sd">        compartment highlight.&#39;&#39;&#39;</span>
        <span class="c1"># TODO Put this in SelectionChanged</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ElementsLowToHigh</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">el</span><span class="o">.</span><span class="n">enabled</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">el</span><span class="o">.</span><span class="n">on_paint_cue</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_DrawCompartmentHighlight</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>

        <span class="n">sel_rects</span> <span class="o">=</span> <span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">rect</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span><span class="p">]</span> <span class="o">+</span>
                     <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">rect</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_comps</span><span class="p">])</span>

        <span class="c1"># If we are not drag-selecting, don&#39;t draw selection outlines if there is only one rect</span>
        <span class="c1"># selected (for aesthetics); but do draw outlines if drawing_drag is True (as</span>
        <span class="c1"># documented in _UpdateSelectedLists())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_rects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawing_drag</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rect</span> <span class="ow">in</span> <span class="n">sel_rects</span><span class="p">:</span>
                <span class="n">rect</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">aligned</span><span class="p">()</span>
                <span class="c1"># Draw selection outlines</span>
                <span class="n">rect</span> <span class="o">=</span> <span class="n">padded_rect</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;select_outline_padding&#39;</span><span class="p">))</span>
                <span class="c1"># draw rect</span>
                <span class="n">draw_rect</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;handle_color&#39;</span><span class="p">),</span>
                          <span class="n">border_width</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;select_outline_width&#39;</span><span class="p">),</span>
                          <span class="n">corner_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Draw reactant and product marker outlines</span>
        <span class="k">def</span> <span class="nf">draw_reaction_outline</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">,</span> <span class="n">padding</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">draw_rect</span><span class="p">(</span>
                <span class="n">gc</span><span class="p">,</span>
                <span class="n">padded_rect</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">s_rect</span><span class="o">.</span><span class="n">aligned</span><span class="p">(),</span> <span class="n">padding</span><span class="p">),</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">border</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">border_width</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">even_round</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;react_node_border_width&#39;</span><span class="p">)),</span> <span class="mi">2</span><span class="p">),</span>
                <span class="n">border_style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">PENSTYLE_LONG_DASH</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">reactants</span> <span class="o">=</span> <span class="n">get_nodes_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">reactants</span><span class="p">:</span>
            <span class="n">draw_reaction_outline</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;reactant_border&#39;</span><span class="p">),</span>
                                  <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;react_node_padding&#39;</span><span class="p">))</span>

        <span class="n">products</span> <span class="o">=</span> <span class="n">get_nodes_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">products</span><span class="p">:</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;react_node_border_width&#39;</span><span class="p">)</span> <span class="o">+</span> \
                <span class="mi">3</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">draw_reaction_outline</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;product_border&#39;</span><span class="p">),</span>
                                  <span class="n">pad</span> <span class="o">+</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;react_node_padding&#39;</span><span class="p">))</span>

        <span class="c1"># Draw drag-selection rect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_DrawDragSelectionRect</span><span class="p">(</span><span class="n">gc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ResetLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elt</span><span class="p">:</span> <span class="n">CanvasElement</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Layer</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_elements</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model_elements</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
            <span class="n">elt</span><span class="o">.</span><span class="n">set_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model_elements</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget_elements</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_widget_elements</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>
            <span class="n">elt</span><span class="o">.</span><span class="n">set_layers</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_widget_elements</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">elt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetSelectedNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the list of selected nodes using self.sel_nodes_idx.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">OnScroll</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="c1"># Need to use wx.CallAfter() to ensure the scroll event is finished before we update the</span>
        <span class="c1"># position of the dragged node</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetOverlayPositions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LazyRefresh</span><span class="p">()</span>
        <span class="c1"># self.FullRedraw()</span>

    <span class="k">def</span> <span class="nf">OnMouseWheel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetWheelRotation</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wx</span><span class="o">.</span><span class="n">GetKeyState</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">WXK_CONTROL</span><span class="p">):</span>
            <span class="c1"># zooming in or out</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">IncrementZoom</span><span class="p">(</span><span class="n">rot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">GetPosition</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># dispatch a horizontal scroll event in this case</span>
            <span class="k">if</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetWheelAxis</span><span class="p">()</span> <span class="o">==</span> <span class="n">wx</span><span class="o">.</span><span class="n">MOUSE_WHEEL_VERTICAL</span> <span class="ow">and</span> \
                    <span class="n">wx</span><span class="o">.</span><span class="n">GetKeyState</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">WXK_SHIFT</span><span class="p">):</span>
                <span class="n">evt</span><span class="o">.</span><span class="n">SetWheelAxis</span><span class="p">(</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">MOUSE_WHEEL_HORIZONTAL</span><span class="p">)</span>
                <span class="c1"># need to invert rotation for more intuitive scrolling</span>
                <span class="n">evt</span><span class="o">.</span><span class="n">SetWheelRotation</span><span class="p">(</span><span class="o">-</span><span class="n">rot</span><span class="p">)</span>

            <span class="n">evt</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnSlider</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="n">level</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom_slider</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetZoomLevel</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetSize</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OnLeaveWindow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_EndDrag</span><span class="p">(</span><span class="n">evt</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">evt</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnDidCommitNodePositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update reaction Bezier handles after nodes are dragged.&quot;&quot;&quot;</span>
        <span class="n">evt</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">DidCommitDragEvent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">evt</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">SelectBox</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span><span class="p">:</span>
                <span class="n">elt</span><span class="o">.</span><span class="n">commit_node_pos</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_ElementsHighToLow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_elements</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget_elements</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ElementsLowToHigh</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_elements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_widget_elements</span><span class="p">)</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">_SelectGroupEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Context for selection event group. See docs for in_selection_group for details.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_selection_group</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">yield</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_in_selection_group</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selection_dirty</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_SelectionChanged</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selection_dirty</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_UpdateSelectedLists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper that updates the selected nodes, etc. using the selected indices.</span>

<span class="sd">        Should be called when there is an update to the indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sel_node_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="n">sel_rxn_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="n">sel_comp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="n">orig_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_node_idx</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_comp_idx</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_rxn_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawing_drag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_selecting</span><span class="p">:</span>
            <span class="n">sel_node_idx</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_nodes_idx</span>
            <span class="n">sel_rxn_idx</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_rxns_idx</span>
            <span class="n">sel_comp_idx</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drag_sel_comps_idx</span>
            <span class="c1"># Flag that indicates whether there are nodes/comps not selected but within</span>
            <span class="c1"># the drag-selection rectangle</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_node_idx</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_rxn_idx</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_comp_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="n">orig_count</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drawing_drag</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">sel_node_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">sel_rxn_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">sel_comp_idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_SelectionChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback passed to observer for when the node/reaction selection has changed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_in_selection_group</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_selection_dirty</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span>
        <span class="n">node_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="n">rxn_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="n">comp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="c1"># Directly update select_box here, instead of binding to a handler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">node_idx</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">comp_idx</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateSelectBoxLayer</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span><span class="p">:</span>
            <span class="n">rel</span><span class="o">.</span><span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">rel</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">post_event</span><span class="p">(</span><span class="n">SelectionDidUpdateEvent</span><span class="p">(</span><span class="n">node_indices</span><span class="o">=</span><span class="n">node_idx</span><span class="p">,</span> <span class="n">reaction_indices</span><span class="o">=</span><span class="n">rxn_idx</span><span class="p">,</span>
                                           <span class="n">compartment_indices</span><span class="o">=</span><span class="n">comp_idx</span><span class="p">))</span>
        <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">=</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateSelectedLists</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_UpdateSelectBoxLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper that updates the layer of the select box, depending on what is selected.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="n">CanvasElement</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_node_elements</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="p">]</span>
        <span class="n">elements</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cast</span><span class="p">(</span><span class="n">CompartmentElt</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartment_elements</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="p">]</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">layers</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elements</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">(</span><span class="n">Canvas</span><span class="o">.</span><span class="n">SELECT_BOX_LAYER</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">(</span><span class="n">Canvas</span><span class="o">.</span><span class="n">SELECT_BOX_LAYER</span><span class="p">,)</span> <span class="o">+</span> <span class="n">layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ResetLayer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_select_box</span><span class="p">,</span> <span class="n">layers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">InWhichCompartment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return which compartment the given floating rectangles are in, or -1 if not in any.</span>

<span class="sd">        This does not return which compartment the nodes currently are in. Rather, it assumes that</span>
<span class="sd">        the user is dragging the nodes (as in the nodes is floating), and tests from the highest</span>
<span class="sd">        compartment to the lowest, whether the nodes as a whole are considered inside that</span>
<span class="sd">        compartment.</span>

<span class="sd">        Right now, a group of nodes are considered to be inside a compartment iff all the nodes are</span>
<span class="sd">        entirely within in the compartment boundaries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ElementsHighToLow</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">CompartmentElt</span><span class="p">):</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">CompartmentElt</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span><span class="o">.</span><span class="n">compartment</span>
                <span class="n">comp_rect</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">rect</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">comp_rect</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">RectInWhichCompartment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rect</span><span class="p">:</span> <span class="n">Rect</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Same as InWhichCompartment but for a single rect&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ElementsHighToLow</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">el</span><span class="p">,</span> <span class="n">CompartmentElt</span><span class="p">):</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">CompartmentElt</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span><span class="o">.</span><span class="n">compartment</span>
                <span class="n">comp_rect</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">rect</span>
                <span class="k">if</span> <span class="n">comp_rect</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">rect</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">DeleteSelectedItems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># First, get the list of reaction indices IF the currently selected reactions were deleted.</span>
        <span class="n">sel_reactions_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="n">sel_nodes_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="n">rem_rxn</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">}</span> <span class="o">-</span> <span class="n">sel_reactions_idx</span>

        <span class="c1"># Second, confirm the selected nodes are free (i.e. not part of a reaction)</span>
        <span class="k">for</span> <span class="n">orig_node_idx</span> <span class="ow">in</span> <span class="n">sel_nodes_idx</span><span class="p">:</span>
            <span class="n">orig_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_idx_map</span><span class="p">[</span><span class="n">orig_node_idx</span><span class="p">]</span>
            <span class="n">is_alias</span> <span class="o">=</span> <span class="n">orig_node</span><span class="o">.</span><span class="n">original_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="c1"># don&#39;t need to worry about deleting aliases that are part of reactions</span>
            <span class="k">if</span> <span class="n">is_alias</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">original_index</span> <span class="o">==</span> <span class="n">orig_node_idx</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">node_idx</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">([</span><span class="n">orig_node_idx</span><span class="p">],</span> <span class="n">aliases</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_to_rxn</span><span class="p">[</span><span class="n">node_idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">rem_rxn</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ShowWarningDialog</span><span class="p">((</span><span class="s2">&quot;Could not delete node &#39;</span><span class="si">{}</span><span class="s2">&#39;, as one or more reactions &quot;</span>
                                            <span class="s2">&quot;depend on it or its aliases.&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orig_node</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Tried and failed to delete bound node &#39;</span><span class="si">{}</span><span class="s2">&#39; with index &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">orig_node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node_idx</span><span class="p">))</span>
                    <span class="k">return</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="n">sel_comp_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">sel_reactions_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">delete_reaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">sel_nodes_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">delete_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">sel_comp_idx</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">delete_compartment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidDeleteEvent</span><span class="p">(</span><span class="n">node_indices</span><span class="o">=</span><span class="n">sel_nodes_idx</span><span class="p">,</span> <span class="n">reaction_indices</span><span class="o">=</span><span class="n">sel_reactions_idx</span><span class="p">,</span>
                                      <span class="n">compartment_indices</span><span class="o">=</span><span class="n">sel_comp_idx</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">SelectAll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectGroupEvent</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">SelectAllNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectGroupEvent</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">SelectAllReactions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectGroupEvent</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">SelectAllCompartments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectGroupEvent</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compartments</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">ClearCurrentSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear the current highest level of selection.</span>

<span class="sd">        If there are reactants or products marked, clear those. OTherwise clear selected nodes and</span>
<span class="sd">        reactions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectGroupEvent</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">MarkSelectedAsReactants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="c1"># self.FullRedraw()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LazyRefresh</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">MarkSelectedAsProducts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">item_copy</span><span class="p">()</span>
        <span class="c1"># self.FullRedraw()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LazyRefresh</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">CreateReactionFromMarked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ShowWarningDialog</span><span class="p">(</span><span class="s1">&#39;Could not create reaction: no reactants selected!&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ShowWarningDialog</span><span class="p">(</span><span class="s1">&#39;Could not create reaction: no products selected!&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ShowWarningDialog</span><span class="p">(</span><span class="s1">&#39;Could not create reaction: reactants and products are &#39;</span>
                                   <span class="s1">&#39;identical.&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetUniqueName</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactions</span><span class="p">])</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">get_nodes_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">get_nodes_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span><span class="p">)</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">compute_centroid</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">rect</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">)])</span>
        <span class="n">reaction</span> <span class="o">=</span> <span class="n">Reaction</span><span class="p">(</span>
            <span class="nb">id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span><span class="p">),</span>
            <span class="n">targets</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span><span class="p">),</span>
            <span class="n">fill_color</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;reaction_fill&#39;</span><span class="p">),</span>
            <span class="n">line_thickness</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;reaction_line_thickness&#39;</span><span class="p">),</span>
            <span class="n">rate_law</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">center_pos</span><span class="o">=</span><span class="n">centroid</span><span class="p">,</span>
            <span class="n">handle_positions</span><span class="o">=</span><span class="n">default_handle_positions</span><span class="p">(</span><span class="n">centroid</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">reai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">add_reaction_g</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">reaction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">centroid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_idx</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_product_idx</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectGroupEvent</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel_compartments_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span><span class="nb">set</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sel_reactions_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">(</span>
                <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_reaction_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="nb">id</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FullRedraw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">CopySelected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_copied_nodes</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">GetSelectedNodes</span><span class="p">())</span>
        <span class="c1"># TODO copy reactions and compartments too</span>

    <span class="k">def</span> <span class="nf">CutSelected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CopySelected</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DeleteSelectedItems</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">Paste</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pasted_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">all_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">}</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="c1"># get unique IDs</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copied_nodes</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetUniqueName</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pasted_ids</span><span class="p">,</span> <span class="n">all_ids</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">Vec2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">pasted_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>  <span class="c1"># add this for the event handlers to see</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">add_node_g</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
        <span class="c1"># update selection *after* end_group(), so as to make sure the canvas is property reset</span>
        <span class="c1"># and updated. For example, if it is not, then the ID of some nodes may be 0 as they are</span>
        <span class="c1"># uninitialized.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_nodes_idx</span><span class="o">.</span><span class="n">set_item</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_node_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_net_index</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">pasted_ids</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">ShowWarningDialog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="s1">&#39;Warning&#39;</span><span class="p">):</span>
        <span class="n">wx</span><span class="o">.</span><span class="n">MessageBox</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">caption</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">OK</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">ICON_WARNING</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">AddPluginElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="n">CanvasElement</span><span class="p">):</span>
        <span class="c1"># TODO currently not accounting for net_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plugin_elements</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widget_elements</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RemovePluginElement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">element</span><span class="p">:</span> <span class="n">CanvasElement</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plugin_elements</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tried to remove an element that is not on canvas.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plugin_elements</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_widget_elements</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GetReactionCentroids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">net_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Helper method for ReactionForm to get access to the centroid positions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">r</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">centroid</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reaction_elements</span><span class="p">}</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2023, Jin Xu, Gary Geng, Nhan D. Nguyen, Carmen Perena-Cortes, Claire Samuels, Herbert M. Sauro

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>