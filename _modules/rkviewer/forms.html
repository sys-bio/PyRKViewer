

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rkviewer.forms &mdash; COYOTE or PyRKViewer 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> COYOTE or PyRKViewer
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../QuickStart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PluginDevelopment.html">Plugin Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PluginReference.html">Plugin Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CoreDevelopment.html">Core Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Reference.html">Core Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">COYOTE or PyRKViewer</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>rkviewer.forms</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for rkviewer.forms</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;All sorts of form widgets, mainly those used in EditPanel.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># from __future__ import annotations</span>
<span class="c1"># pylint: disable=maybe-no-member</span>
<span class="kn">import</span> <span class="nn">wx</span>
<span class="kn">from</span> <span class="nn">wx.lib.scrolledpanel</span> <span class="kn">import</span> <span class="n">ScrolledPanel</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">cast</span>
<span class="kn">from</span> <span class="nn">.config</span> <span class="kn">import</span> <span class="n">get_theme</span><span class="p">,</span> <span class="n">get_setting</span><span class="p">,</span> <span class="n">Color</span>
<span class="kn">from</span> <span class="nn">.events</span> <span class="kn">import</span> <span class="p">(</span><span class="n">DidModifyCompartmentsEvent</span><span class="p">,</span> <span class="n">DidModifyNodesEvent</span><span class="p">,</span> <span class="n">DidModifyReactionEvent</span><span class="p">,</span>
                     <span class="n">DidMoveCompartmentsEvent</span><span class="p">,</span> <span class="n">DidMoveNodesEvent</span><span class="p">,</span> <span class="n">DidMoveReactionCenterEvent</span><span class="p">,</span> <span class="n">DidResizeCompartmentsEvent</span><span class="p">,</span>
                     <span class="n">DidResizeNodesEvent</span><span class="p">,</span> <span class="n">post_event</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.mvc</span> <span class="kn">import</span> <span class="n">IController</span><span class="p">,</span> <span class="n">ModifierTipStyle</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">change_opacity</span><span class="p">,</span> <span class="n">gchain</span><span class="p">,</span> <span class="n">no_rzeros</span><span class="p">,</span> <span class="n">on_msw</span><span class="p">,</span> <span class="n">resource_path</span>
<span class="kn">from</span> <span class="nn">.canvas.canvas</span> <span class="kn">import</span> <span class="n">Canvas</span><span class="p">,</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">.canvas.data</span> <span class="kn">import</span> <span class="n">ChoiceItem</span><span class="p">,</span> <span class="n">Compartment</span><span class="p">,</span> <span class="n">FONT_FAMILY_CHOICES</span><span class="p">,</span> <span class="n">FONT_STYLE_CHOICES</span><span class="p">,</span> <span class="n">FONT_WEIGHT_CHOICES</span><span class="p">,</span> <span class="n">Reaction</span><span class="p">,</span> <span class="n">TEXT_ALIGNMENT_CHOICES</span><span class="p">,</span> <span class="n">LinePrim</span><span class="p">,</span> <span class="n">PolygonPrim</span><span class="p">,</span> <span class="n">Primitive</span><span class="p">,</span> <span class="n">TEXT_POSITION_CHOICES</span><span class="p">,</span> <span class="n">compute_centroid</span>
<span class="kn">from</span> <span class="nn">.canvas.geometry</span> <span class="kn">import</span> <span class="n">Rect</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">,</span> <span class="n">clamp_rect_pos</span><span class="p">,</span> <span class="n">clamp_rect_size</span><span class="p">,</span> <span class="n">get_bounding_rect</span><span class="p">,</span> <span class="n">calc_node_dimensions</span>
<span class="kn">from</span> <span class="nn">.canvas.utils</span> <span class="kn">import</span> <span class="n">get_nodes_by_idx</span><span class="p">,</span> <span class="n">get_rxns_by_idx</span>
<span class="kn">from</span> <span class="nn">.canvas.data</span> <span class="kn">import</span> <span class="n">CirclePrim</span><span class="p">,</span> <span class="n">RectanglePrim</span><span class="p">,</span> <span class="n">CompositeShape</span>


<span class="n">ColorCallback</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">FloatCallback</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>


<div class="viewcode-block" id="GetMultiEnum"><a class="viewcode-back" href="../../rkviewer/rkviewer.html#rkviewer.forms.GetMultiEnum">[docs]</a><span class="k">def</span> <span class="nf">GetMultiEnum</span><span class="p">(</span><span class="n">entries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">fallback</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Similar to _GetMultiColor, but for enums.</span>

<span class="sd">    Need to specify a fallback value in case the entries are different.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entries_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">entries_set</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fallback</span></div>


<div class="viewcode-block" id="GetMultiFloatText"><a class="viewcode-back" href="../../rkviewer/rkviewer.html#rkviewer.forms.GetMultiFloatText">[docs]</a><span class="k">def</span> <span class="nf">GetMultiFloatText</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">precision</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Returns the common float value if the set has only one element, otherwise return &quot;?&quot;.</span>

<span class="sd">    See _GetMultiColor for more detail.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">no_rzeros</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">values</span><span class="p">)),</span> <span class="n">precision</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;?&#39;</span></div>


<div class="viewcode-block" id="GetMultiInt"><a class="viewcode-back" href="../../rkviewer/rkviewer.html#rkviewer.forms.GetMultiInt">[docs]</a><span class="k">def</span> <span class="nf">GetMultiInt</span><span class="p">(</span><span class="n">values</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Returns the common float value if the set has only one element, otherwise return &quot;?&quot;.</span>

<span class="sd">    See _GetMultiColor for more detail.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">values</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="GetMultiColor"><a class="viewcode-back" href="../../rkviewer/rkviewer.html#rkviewer.forms.GetMultiColor">[docs]</a><span class="k">def</span> <span class="nf">GetMultiColor</span><span class="p">(</span><span class="n">colors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Helper method for producing one single color from a list of colors.</span>

<span class="sd">    Editing programs that allows selection of multiple entities usually support editing all of</span>
<span class="sd">    the selected entities at once. When a property of all the selected entities are the same,</span>
<span class="sd">    the displayed value of that property is that single value precisely. However, if they are</span>
<span class="sd">    not the same, usually a &quot;null&quot; or default value is shown on the form. Following this scheme,</span>
<span class="sd">    this helper returns the common color/alpha if all values are the same, or a default value</span>
<span class="sd">    if not.</span>

<span class="sd">    Note:</span>
<span class="sd">        On Windows the RGB and the alpha are treated as different fields due to the lack of</span>
<span class="sd">        alpha field in the color picker screen. Therefore, the RGB and the alpha fields are</span>
<span class="sd">        considered different fields as far as uniqueness is considered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">on_msw</span><span class="p">():</span>
        <span class="n">rgbset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">GetRGB</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">)</span>
        <span class="n">rgb</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgbset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rgb</span><span class="o">.</span><span class="n">SetRGB</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">rgbset</span><span class="p">)))</span>

        <span class="n">alphaset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">Alpha</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">alphaset</span><span class="p">))</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">alphaset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">rgb</span><span class="p">,</span> <span class="n">alpha</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rgbaset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">GetRGBA</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">)</span>
        <span class="n">rgba</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgbaset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">rgba</span><span class="o">.</span><span class="n">SetRGBA</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">rgbaset</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">rgba</span><span class="p">,</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="AlphaToText"><a class="viewcode-back" href="../../rkviewer/rkviewer.html#rkviewer.forms.AlphaToText">[docs]</a><span class="k">def</span> <span class="nf">AlphaToText</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">prec</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Simple helper for converting an alpha value ~[0, 255] to the range [0, 1].</span>

<span class="sd">    Args:</span>
<span class="sd">        alpha: The alpha value in range 0-255. If None, &quot;?&quot; will be returned.</span>
<span class="sd">        precision: The precision of the float string returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;?&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">no_rzeros</span><span class="p">(</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">255</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_SetBestInsertion</span><span class="p">(</span><span class="n">ctrl</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">,</span> <span class="n">orig_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">orig_insertion</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the most natural insertion point for a paired-number text control.</span>

<span class="sd">    The format of the text control must be &quot;X,Y&quot; where X, Y are numbers, allowing whitespace.</span>
<span class="sd">    This should be called after the text control is autoly changed by View during user&#39;s</span>
<span class="sd">    editing. Normally if the text changes the caret will be reset to the 0th position, but this</span>
<span class="sd">    calculates a smarter position to place the caret to produce a more natural behavior.</span>

<span class="sd">    Args:</span>
<span class="sd">        ctrl: The text control, whose value is already programmatically changed.</span>
<span class="sd">        orig_text: The value of the text control before it was changed.</span>
<span class="sd">        orig_insertion: The original caret position from GetInsertionPoint().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">new_text</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">orig_text</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># can&#39;t find comma; directly return</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">orig_insertion</span> <span class="o">&gt;</span> <span class="n">mid</span><span class="p">:</span>
        <span class="n">ctrl</span><span class="o">.</span><span class="n">SetInsertionPoint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_text</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">new_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

        <span class="n">left</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">lstart</span> <span class="o">=</span> <span class="n">new_text</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
        <span class="n">lend</span> <span class="o">=</span> <span class="n">lstart</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
        <span class="n">ctrl</span><span class="o">.</span><span class="n">SetInsertionPoint</span><span class="p">(</span><span class="n">lend</span><span class="p">)</span>


<div class="viewcode-block" id="ChangePairValue"><a class="viewcode-back" href="../../rkviewer/rkviewer.html#rkviewer.forms.ChangePairValue">[docs]</a><span class="k">def</span> <span class="nf">ChangePairValue</span><span class="p">(</span><span class="n">ctrl</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">,</span> <span class="n">new_val</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">,</span> <span class="n">prec</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper for updating the value of a paired number TextCtrl.</span>

<span class="sd">    The TextCtrl accepts text in the format &quot;X, Y&quot; where X and Y are floats. The control is</span>
<span class="sd">    not updated if the new and old values are identical (considering precision).</span>

<span class="sd">    Args:</span>
<span class="sd">        ctrl: The TextCtrl widget.</span>
<span class="sd">        new_val: The new pair of floats to update the control with.</span>
<span class="sd">        prec: The precision of the numbers. The new value is rounded to this precision.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">old_text</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
    <span class="n">old_val</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">parse_num_pair</span><span class="p">(</span><span class="n">old_text</span><span class="p">))</span>

    <span class="c1"># round old_val to desired precision. We don&#39;t want to refresh value when user is typing,</span>
    <span class="c1"># even if their value exceeded our precision</span>
    <span class="k">if</span> <span class="n">old_val</span> <span class="o">!=</span> <span class="n">new_val</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">HasFocus</span><span class="p">():</span>
            <span class="n">orig_insertion</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">GetInsertionPoint</span><span class="p">()</span>
            <span class="n">wx</span><span class="o">.</span><span class="n">CallAfter</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">_SetBestInsertion</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">old_text</span><span class="p">,</span> <span class="n">orig_insertion</span><span class="p">))</span>
        <span class="n">ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> , </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">no_rzeros</span><span class="p">(</span><span class="n">new_val</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">prec</span><span class="p">),</span> <span class="n">no_rzeros</span><span class="p">(</span><span class="n">new_val</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">prec</span><span class="p">)))</span></div>


<div class="viewcode-block" id="parse_num_pair"><a class="viewcode-back" href="../../rkviewer/rkviewer.html#rkviewer.forms.parse_num_pair">[docs]</a><span class="k">def</span> <span class="nf">parse_num_pair</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Parse a pair of floats from a string with form &quot;X,Y&quot; and return a tuple.</span>

<span class="sd">    Returns None if failed to parse.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">xstr</span><span class="p">,</span> <span class="n">ystr</span> <span class="o">=</span> <span class="n">nums</span>
    <span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xstr</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ystr</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_precisions"><a class="viewcode-back" href="../../rkviewer/rkviewer.html#rkviewer.forms.parse_precisions">[docs]</a><span class="k">def</span> <span class="nf">parse_precisions</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Given a string in format &#39;X, Y&#39; of floats, return the decimal precisions of X and Y.&quot;&quot;&quot;</span>
    <span class="n">nums</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>

    <span class="n">xstr</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">ystr</span> <span class="o">=</span> <span class="n">nums</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">x_prec</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">x_prec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xstr</span><span class="p">)</span> <span class="o">-</span> <span class="n">xstr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">x_prec</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">y_prec</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">y_prec</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xstr</span><span class="p">)</span> <span class="o">-</span> <span class="n">ystr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">y_prec</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">x_prec</span><span class="p">,</span> <span class="n">y_prec</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">FieldGrid</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Window</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">form</span><span class="p">:</span> <span class="s1">&#39;EditPanelForm&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetForegroundColour</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;toolbar_fg&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;toolbar_bg&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="n">form</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">badges</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_label_font</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">FontInfo</span><span class="p">()</span><span class="o">.</span><span class="n">Bold</span><span class="p">())</span>
        <span class="n">info_image</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">resource_path</span><span class="p">(</span><span class="s1">&#39;info-2-16.png&#39;</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">BITMAP_TYPE_PNG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info_bitmap</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Bitmap</span><span class="p">(</span><span class="n">info_image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_info_length</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="n">sizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">InitAndGetSizer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">sizer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">InitAndGetSizer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">wx</span><span class="o">.</span><span class="n">GridSizer</span><span class="p">:</span>
        <span class="n">VGAP</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">HGAP</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">MORE_LEFT_PADDING</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Left padding in addition to vgap</span>
        <span class="n">MORE_TOP_PADDING</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># Top padding in addition to hgap</span>
        <span class="n">MORE_RIGHT_PADDING</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">sizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">GridBagSizer</span><span class="p">(</span><span class="n">vgap</span><span class="o">=</span><span class="n">VGAP</span><span class="p">,</span> <span class="n">hgap</span><span class="o">=</span><span class="n">HGAP</span><span class="p">)</span>

        <span class="c1"># Set paddings</span>
        <span class="c1"># Add spacer of width w on the 0th column; add spacer of height h on the 0th row.</span>
        <span class="c1"># This results in a left padding of w + hgap and a top padding of h + vgap</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">MORE_LEFT_PADDING</span><span class="p">,</span> <span class="n">MORE_TOP_PADDING</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Add spacer on column 3 to reserve space for info badge</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_info_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="c1"># Add spacer of width 5 on the 3rd column. This results in a right padding of 5 + hgap</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">MORE_RIGHT_PADDING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Ensure the input field takes up some percentage of width</span>
        <span class="c1"># Note that we might want to adjust this when scrollbars are displayed, but only in case</span>
        <span class="c1"># there is not enough width to display everything</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSize</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">right_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">VGAP</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">MORE_LEFT_PADDING</span> <span class="o">-</span> <span class="n">MORE_RIGHT_PADDING</span> <span class="o">-</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">_info_length</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.7</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">right_width</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">AddGrowableCol</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">AddGrowableCol</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sizer</span>

    <span class="k">def</span> <span class="nf">AppendControl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Control</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a control, its label, and its info badge to the last row of the sizer.</span>

<span class="sd">        Returns the automaticaly created label and info badge (wx.StaticText for now).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSizer</span><span class="p">()</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label_str</span><span class="p">)</span>
        <span class="n">label</span><span class="o">.</span><span class="n">SetFont</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_font</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">sizer</span><span class="o">.</span><span class="n">GetRows</span><span class="p">()</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                  <span class="n">flag</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_RIGHT</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                  <span class="n">flag</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER_VERTICAL</span> <span class="o">|</span> <span class="n">wx</span><span class="o">.</span><span class="n">EXPAND</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info_length</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">info_badge</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticBitmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bitmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_info_bitmap</span><span class="p">)</span>
        <span class="n">info_badge</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">info_badge</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">flag</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">badges</span><span class="p">[</span><span class="n">ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span> <span class="o">=</span> <span class="n">info_badge</span>

    <span class="k">def</span> <span class="nf">AppendSpacer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sizer</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a horizontal spacer with the given height.</span>

<span class="sd">        Note:</span>
<span class="sd">            The VGAP value still applies, i.e. there is an additional gap between the spacer and</span>
<span class="sd">            the next row.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSizer</span><span class="p">()</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">sizer</span><span class="o">.</span><span class="n">GetRows</span><span class="p">()</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">AppendLine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a horizontal spacer with the given height.</span>

<span class="sd">        Note:</span>
<span class="sd">            The VGAP value still applies, i.e. there is an additional gap between the spacer and</span>
<span class="sd">            the next row.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSizer</span><span class="p">()</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">sizer</span><span class="o">.</span><span class="n">GetRows</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticLine</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">AppendSubtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">add_spacers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">:</span>
        <span class="n">sizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSizer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">add_spacers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AppendSpacer</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="n">sizer</span><span class="o">.</span><span class="n">GetRows</span><span class="p">(),</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">statictext</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
        <span class="n">font</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">FontInfo</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
        <span class="n">statictext</span><span class="o">.</span><span class="n">SetFont</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">statictext</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">GBPosition</span><span class="p">(</span><span class="n">sizer</span><span class="o">.</span><span class="n">GetRows</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
                  <span class="n">wx</span><span class="o">.</span><span class="n">GBSpan</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">flag</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">add_spacers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AppendSpacer</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">statictext</span>

    <span class="k">def</span> <span class="nf">SetValidationState</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">good</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the validation state for a control.</span>

<span class="sd">        Args:</span>
<span class="sd">            good: Whether the control is currently valid.</span>
<span class="sd">            ctrl_id: The ID of the control.</span>
<span class="sd">            message: The message displayed, if the control is not valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.Freeze()</span>
        <span class="n">badge</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">badges</span><span class="p">[</span><span class="n">ctrl_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">good</span><span class="p">:</span>
            <span class="n">badge</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">badge</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">badge</span><span class="o">.</span><span class="n">SetToolTip</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Layout</span><span class="p">()</span>
        <span class="c1"># self.Thaw()</span>

    <span class="k">def</span> <span class="nf">CreateTextCtrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a text control that confirms to the theme.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;text_field_border&#39;</span><span class="p">):</span>
            <span class="n">style</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BORDER_NONE</span>
        <span class="n">ctrl</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ctrl</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;text_field_bg&#39;</span><span class="p">))</span>
        <span class="n">ctrl</span><span class="o">.</span><span class="n">SetForegroundColour</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;text_field_fg&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ctrl</span>

    <span class="k">def</span> <span class="nf">CreateSpinCtrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a text control that confirms to the theme.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;text_field_border&#39;</span><span class="p">):</span>
            <span class="n">style</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">style</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BORDER_NONE</span>
        <span class="n">ctrl</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SpinCtrl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ctrl</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;text_field_bg&#39;</span><span class="p">))</span>
        <span class="n">ctrl</span><span class="o">.</span><span class="n">SetForegroundColour</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;text_field_fg&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">ctrl</span>

    <span class="k">def</span> <span class="nf">CreateColorControl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alpha_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">color_callback</span><span class="p">:</span> <span class="n">ColorCallback</span><span class="p">,</span> <span class="n">alpha_callback</span><span class="p">:</span> <span class="n">FloatCallback</span><span class="p">,</span>
                           <span class="n">alpha_range</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                           <span class="n">placeholder</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">),</span> <span class="n">placeholder_alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> \
            <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">wx</span><span class="o">.</span><span class="n">ColourPickerCtrl</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Helper method for creating a color control and adding it to the form.</span>

<span class="sd">        Args:</span>
<span class="sd">            label: The label text for the color control.</span>
<span class="sd">            alpha_label: The label text for the alpha control. Relevant only on Windows.</span>
<span class="sd">            color_callback: Callback called when the color changes.</span>
<span class="sd">            alpha_callback: Callback called when the alpha changes. Relevant only on Windows.</span>
<span class="sd">            sizer: The sizer to which widgets should be added.</span>
<span class="sd">            alpha_range: The inclusive range for the alpha value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple of the color control and the alpha control.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Update placeholder to include alpha</span>
        <span class="k">if</span> <span class="n">placeholder_alpha</span><span class="p">:</span>
            <span class="n">placeholder</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="n">placeholder</span><span class="o">.</span><span class="n">Red</span><span class="p">(),</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">Green</span><span class="p">(),</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">Blue</span><span class="p">(),</span>
                                    <span class="n">placeholder_alpha</span><span class="p">)</span>

        <span class="n">ctrl</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ColourPickerCtrl</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ctrl</span><span class="o">.</span><span class="n">SetColour</span><span class="p">(</span><span class="n">placeholder</span><span class="p">)</span>
        <span class="n">ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COLOURPICKER_CHANGED</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">color_callback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">GetColour</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">)</span>

        <span class="n">alpha_ctrl</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">on_msw</span><span class="p">():</span>
            <span class="c1"># Windows does not support picking alpha in color picker. So we add an additional</span>
            <span class="c1"># field for that</span>
            <span class="n">alpha_text</span> <span class="o">=</span> <span class="n">AlphaToText</span><span class="p">(</span><span class="n">placeholder_alpha</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">alpha_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">alpha_text</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="n">alpha_label</span><span class="p">,</span> <span class="n">alpha_ctrl</span><span class="p">)</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MakeFloatCtrlFunction</span><span class="p">(</span><span class="n">alpha_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">(),</span> <span class="n">alpha_callback</span><span class="p">,</span> <span class="n">alpha_range</span><span class="p">)</span>
            <span class="n">alpha_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">alpha_ctrl</span>

    <span class="k">def</span> <span class="nf">MakeFloatCtrlFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">FloatCallback</span><span class="p">,</span>
                              <span class="n">range_</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
                              <span class="n">left_incl</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right_incl</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper method that creates a validation function for a TextCtrl that only allows floats.</span>

<span class="sd">        Args:</span>
<span class="sd">            ctrl_id: ID of the TextCtrl, for which this validation function is created.</span>
<span class="sd">            callback: Callback for when the float is changed and passes the validation tests.</span>
<span class="sd">            range_: Inclusive range for the allowed floats.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The validation function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">range_</span>

        <span class="k">def</span> <span class="nf">float_ctrl_fn</span><span class="p">(</span><span class="n">evt</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
            <span class="n">value</span><span class="p">:</span> <span class="nb">float</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s2">&quot;Value must be a number&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">good</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">left_incl</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">lo</span><span class="p">:</span>
                    <span class="n">good</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">lo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="n">lo</span><span class="p">:</span>
                    <span class="n">good</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">right_incl</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">hi</span><span class="p">:</span>
                    <span class="n">good</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">hi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="n">hi</span><span class="p">:</span>
                    <span class="n">good</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">good</span><span class="p">:</span>
                <span class="n">err_msg</span><span class="p">:</span> <span class="nb">str</span>
                <span class="k">if</span> <span class="n">lo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span> <span class="k">if</span> <span class="n">left_incl</span> <span class="k">else</span> <span class="s1">&#39;(&#39;</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="s1">&#39;]&#39;</span> <span class="k">if</span> <span class="n">right_incl</span> <span class="k">else</span> <span class="s1">&#39;)&#39;</span>
                    <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Value must be in range </span><span class="si">{}{}</span><span class="s2">, </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">incl_text</span> <span class="o">=</span> <span class="s1">&#39;or equal to &#39;</span> <span class="k">if</span> <span class="n">left_incl</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Value must greater than </span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">incl_text</span><span class="p">,</span> <span class="n">lo</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">incl_text</span> <span class="o">=</span> <span class="s1">&#39;or equal to&#39;</span> <span class="k">if</span> <span class="n">right_incl</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Value must less than </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">incl_text</span><span class="p">,</span> <span class="n">hi</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">callback</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">float_ctrl_fn</span>

<span class="k">class</span> <span class="nc">PrimitiveGrid</span><span class="p">(</span><span class="n">FieldGrid</span><span class="p">):</span>
    <span class="n">form</span><span class="p">:</span> <span class="s1">&#39;NodeForm&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">form</span><span class="p">:</span> <span class="s1">&#39;NodeForm&#39;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_callbacks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">UpdateValues</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update the values in the primitive fields.</span>

<span class="sd">        Requires:</span>
<span class="sd">            The FieldGrid contains the up-to-date field widgets for the given composite shape.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_callbacks</span><span class="p">:</span>
            <span class="n">callback</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">ColorPrimitiveControl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">alpha_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">prim_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a control for a color property.</span>

<span class="sd">        If prim_index is -1, then update the text primitive instead.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">color_callback</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">):</span>
            <span class="n">node_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_idx</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_nodes</span>
            <span class="n">prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetPrimitives</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">)</span>
            <span class="n">old_colors</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_wxcolour</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prims</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nodei</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node_indices</span><span class="p">):</span>
                    <span class="c1"># only update the RGB, not alpha</span>
                    <span class="n">old_color</span> <span class="o">=</span> <span class="n">old_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">new_color</span> <span class="o">=</span> <span class="n">Color</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">Red</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="n">Green</span><span class="p">(),</span> <span class="n">value</span><span class="o">.</span><span class="n">Blue</span><span class="p">(),</span> <span class="n">old_color</span><span class="o">.</span><span class="n">Alpha</span><span class="p">())</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_primitive_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">,</span>
                                                                    <span class="n">prop_name</span><span class="p">,</span> <span class="n">new_color</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">alpha_callback</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">node_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_idx</span>
            <span class="n">prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetPrimitives</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_nodes</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">)</span>
            <span class="n">old_colors</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_wxcolour</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prims</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nodei</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node_indices</span><span class="p">):</span>
                    <span class="n">old_color</span> <span class="o">=</span> <span class="n">old_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">new_color</span> <span class="o">=</span> <span class="n">Color</span><span class="p">(</span><span class="n">old_color</span><span class="o">.</span><span class="n">Red</span><span class="p">(),</span> <span class="n">old_color</span><span class="o">.</span><span class="n">Green</span><span class="p">(),</span>
                                    <span class="n">old_color</span><span class="o">.</span><span class="n">Blue</span><span class="p">(),</span> <span class="nb">int</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">value</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_primitive_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">,</span>
                                                                    <span class="n">prop_name</span><span class="p">,</span> <span class="n">new_color</span><span class="p">)</span>

        <span class="n">ctrl</span><span class="p">,</span> <span class="n">alpha_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CreateColorControl</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">alpha_label</span><span class="p">,</span> <span class="n">color_callback</span><span class="p">,</span> <span class="n">alpha_callback</span><span class="p">)</span>

        <span class="c1"># callback for when the canvs is upated by user input</span>
        <span class="k">def</span> <span class="nf">update_cb</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
            <span class="n">prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetPrimitives</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">)</span>
            <span class="n">old_colors</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">)</span><span class="o">.</span><span class="n">to_wxcolour</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prims</span><span class="p">]</span>
            <span class="n">color_union</span><span class="p">,</span> <span class="n">alpha_union</span> <span class="o">=</span> <span class="n">GetMultiColor</span><span class="p">(</span><span class="n">old_colors</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ctrl</span><span class="o">.</span><span class="n">SetColour</span><span class="p">(</span><span class="n">color_union</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">alpha_ctrl</span><span class="p">:</span>
                <span class="n">alpha_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">AlphaToText</span><span class="p">(</span><span class="n">alpha_union</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update_cb</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">FloatPrimitiveControl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a control for a floating point property.</span>

<span class="sd">        If prim_index is -1, then update the text primitive instead.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">node_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_idx</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">nodei</span> <span class="ow">in</span> <span class="n">node_indices</span><span class="p">:</span>
                    <span class="c1"># only update the RGB, not alpha</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_primitive_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">,</span>
                                                                    <span class="n">prop_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># TODO update values not here</span>
        <span class="n">text_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="n">outer_callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MakeFloatCtrlFunction</span><span class="p">(</span><span class="n">text_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">(),</span>
                                                    <span class="n">callback</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">left_incl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">text_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="n">outer_callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">text_ctrl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">update_cb</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
            <span class="n">prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetPrimitives</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">)</span>
            <span class="n">old_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prims</span><span class="p">]</span>
            <span class="n">update_value</span> <span class="o">=</span> <span class="n">GetMultiFloatText</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">old_values</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">text_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">update_value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update_cb</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">IntPrimitiveControl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">prim_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">min_</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a control for a floating point property.</span>

<span class="sd">        If prim_index is -1, then update the text primitive instead.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">spin_callback</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">node_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_idx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">nodei</span> <span class="ow">in</span> <span class="n">node_indices</span><span class="p">:</span>
                    <span class="c1"># only update the RGB, not alpha</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_primitive_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">,</span>
                                                                    <span class="n">prop_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">text_callback</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">spin_callback</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>


        <span class="n">int_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CreateSpinCtrl</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">min_</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">max_</span><span class="p">)</span>
        <span class="n">int_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_SPINCTRL</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">spin_callback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">GetInt</span><span class="p">()))</span>
        <span class="n">int_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">text_callback</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">GetString</span><span class="p">()))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">int_ctrl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">update_cb</span><span class="p">(</span><span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
            <span class="n">prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetPrimitives</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_nodes</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">)</span>
            <span class="n">old_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">prims</span><span class="p">]</span>
            <span class="n">updated_value</span> <span class="o">=</span> <span class="n">GetMultiInt</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">old_values</span><span class="p">))</span> <span class="ow">or</span> <span class="mi">0</span>
            <span class="n">int_ctrl</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">updated_value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update_cb</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ChoicePrimitiveControl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                               <span class="n">choice_items</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ChoiceItem</span><span class="p">]):</span>
        <span class="c1"># TODO set original value</span>
        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
            <span class="n">node_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_idx</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">GetInt</span><span class="p">()</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">choice_items</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">nodei</span> <span class="ow">in</span> <span class="n">node_indices</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_primitive_property</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">,</span>
                                                                    <span class="n">prop_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">choice_items</span><span class="p">]</span>
        <span class="n">choice_ctrl</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Choice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">texts</span><span class="p">)</span>

        <span class="n">choice_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHOICE</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">choice_ctrl</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">update_cb</span><span class="p">(</span><span class="n">nodes</span><span class="p">):</span>
            <span class="n">prims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetPrimitives</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">)</span>
            <span class="n">old_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">prim</span><span class="p">,</span> <span class="n">prop_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">prim</span> <span class="ow">in</span> <span class="n">prims</span><span class="p">)</span>

            <span class="c1"># Set commonly selected item</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Find choice item with given value</span>
                <span class="n">sel_ind</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">old_value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">old_values</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">choice_items</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">old_value</span><span class="p">:</span>
                        <span class="n">sel_ind</span> <span class="o">=</span> <span class="n">index</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;This should never happen&quot;</span>
                <span class="n">choice_ctrl</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="n">sel_ind</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Different values; set dropdown to none</span>
                <span class="n">choice_ctrl</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">NOT_FOUND</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">update_cb</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_GetPrimitives</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">prim_index</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">prim_index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">composite_shape</span><span class="o">.</span><span class="n">text_item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">composite_shape</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">prim_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">PrimitiveSection</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Window</span><span class="p">):</span>
    <span class="n">subsections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">PrimitiveGrid</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_form</span><span class="p">:</span> <span class="s1">&#39;NodeForm&#39;</span><span class="p">,</span> <span class="n">com_shape</span><span class="p">:</span> <span class="n">CompositeShape</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">node_form</span><span class="p">)</span>
        <span class="n">sizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">sizerflags</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SizerFlags</span><span class="p">()</span><span class="o">.</span><span class="n">Expand</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_callbacks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="n">node_form</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">subsections</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># self._primitives_heading = self.main_section.AppendSubtitle(&#39;Shape properties&#39;)</span>
        <span class="c1"># self.main_section.AppendSpacer(0)</span>
        <span class="c1"># node_indices = [n.index for n in nodes]</span>
        <span class="k">for</span> <span class="n">prim_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">com_shape</span><span class="o">.</span><span class="n">items</span><span class="p">)):</span>
            <span class="c1"># primitives = [cs.items[prim_index][0] for cs in com_shapes]</span>
            <span class="n">one_prim</span> <span class="o">=</span> <span class="n">com_shape</span><span class="o">.</span><span class="n">items</span><span class="p">[</span><span class="n">prim_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">subtitle_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{name}</span><span class="s1"> (</span><span class="si">{idx}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx</span><span class="o">=</span><span class="n">prim_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">one_prim</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">subsection</span> <span class="o">=</span> <span class="n">PrimitiveGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_form</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subsections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subsection</span><span class="p">)</span>
            <span class="n">subsection</span><span class="o">.</span><span class="n">AppendSubtitle</span><span class="p">(</span><span class="n">subtitle_text</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">one_prim</span><span class="p">,</span> <span class="n">RectanglePrim</span><span class="p">):</span>
                <span class="n">subsection</span><span class="o">.</span><span class="n">ColorPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;fill color&#39;</span><span class="p">,</span> <span class="s1">&#39;fill opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_color&#39;</span><span class="p">,</span>
                                                 <span class="n">prim_index</span><span class="p">)</span>
                <span class="n">subsection</span><span class="o">.</span><span class="n">ColorPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;border color&#39;</span><span class="p">,</span> <span class="s1">&#39;border opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;border_color&#39;</span><span class="p">,</span>
                                                 <span class="n">prim_index</span><span class="p">)</span>
                <span class="n">subsection</span><span class="o">.</span><span class="n">FloatPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;border width&#39;</span><span class="p">,</span> <span class="s1">&#39;border_width&#39;</span><span class="p">,</span>
                                                 <span class="n">prim_index</span><span class="p">)</span>
                <span class="n">subsection</span><span class="o">.</span><span class="n">FloatPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;corner radius&#39;</span><span class="p">,</span> <span class="s1">&#39;corner_radius&#39;</span><span class="p">,</span>
                                                 <span class="n">prim_index</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">one_prim</span><span class="p">,</span> <span class="n">LinePrim</span><span class="p">):</span>
                <span class="n">subsection</span><span class="o">.</span><span class="n">ColorPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;line color&#39;</span><span class="p">,</span> <span class="s1">&#39;line opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;border_color&#39;</span><span class="p">,</span>
                                                 <span class="n">prim_index</span><span class="p">)</span>
                <span class="n">subsection</span><span class="o">.</span><span class="n">FloatPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;line width&#39;</span><span class="p">,</span> <span class="s1">&#39;border_width&#39;</span><span class="p">,</span>
                                                 <span class="n">prim_index</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">one_prim</span><span class="p">,</span> <span class="n">CirclePrim</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">one_prim</span><span class="p">,</span> <span class="n">PolygonPrim</span><span class="p">):</span>
                <span class="n">subsection</span><span class="o">.</span><span class="n">ColorPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;fill color&#39;</span><span class="p">,</span> <span class="s1">&#39;fill opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_color&#39;</span><span class="p">,</span>
                                                 <span class="n">prim_index</span><span class="p">)</span>
                <span class="n">subsection</span><span class="o">.</span><span class="n">ColorPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;border color&#39;</span><span class="p">,</span> <span class="s1">&#39;border opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;border_color&#39;</span><span class="p">,</span>
                                                 <span class="n">prim_index</span><span class="p">)</span>
                <span class="n">subsection</span><span class="o">.</span><span class="n">FloatPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;border width&#39;</span><span class="p">,</span> <span class="s1">&#39;border_width&#39;</span><span class="p">,</span>
                                                 <span class="n">prim_index</span><span class="p">)</span>

        <span class="n">subtitle_text</span> <span class="o">=</span> <span class="s1">&#39;Text&#39;</span>
        <span class="n">subsection</span> <span class="o">=</span> <span class="n">PrimitiveGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_form</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subsections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subsection</span><span class="p">)</span>
        <span class="n">subsection</span><span class="o">.</span><span class="n">AppendSubtitle</span><span class="p">(</span><span class="n">subtitle_text</span><span class="p">)</span>
        <span class="c1"># Create text primitive</span>
        <span class="n">subsection</span><span class="o">.</span><span class="n">IntPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;font size&#39;</span><span class="p">,</span> <span class="s1">&#39;font_size&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">subsection</span><span class="o">.</span><span class="n">ColorPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;font color&#39;</span><span class="p">,</span> <span class="s1">&#39;font opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;font_color&#39;</span><span class="p">,</span>
                                         <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">subsection</span><span class="o">.</span><span class="n">ColorPrimitiveControl</span><span class="p">(</span><span class="s1">&#39;highlight color&#39;</span><span class="p">,</span> <span class="s1">&#39;highlight opacity&#39;</span><span class="p">,</span> <span class="s1">&#39;bg_color&#39;</span><span class="p">,</span>
                                         <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">subsection</span><span class="o">.</span><span class="n">ChoicePrimitiveControl</span><span class="p">(</span><span class="s1">&#39;font family&#39;</span><span class="p">,</span> <span class="s1">&#39;font_family&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">FONT_FAMILY_CHOICES</span><span class="p">)</span>
        <span class="n">subsection</span><span class="o">.</span><span class="n">ChoicePrimitiveControl</span><span class="p">(</span><span class="s1">&#39;font style&#39;</span><span class="p">,</span> <span class="s1">&#39;font_style&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">FONT_STYLE_CHOICES</span><span class="p">)</span>
        <span class="n">subsection</span><span class="o">.</span><span class="n">ChoicePrimitiveControl</span><span class="p">(</span><span class="s1">&#39;font weight&#39;</span><span class="p">,</span> <span class="s1">&#39;font_weight&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">FONT_WEIGHT_CHOICES</span><span class="p">)</span>
        <span class="n">subsection</span><span class="o">.</span><span class="n">ChoicePrimitiveControl</span><span class="p">(</span><span class="s1">&#39;alignment&#39;</span><span class="p">,</span> <span class="s1">&#39;alignment&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">TEXT_ALIGNMENT_CHOICES</span><span class="p">)</span>
        <span class="n">subsection</span><span class="o">.</span><span class="n">ChoicePrimitiveControl</span><span class="p">(</span><span class="s1">&#39;text position&#39;</span><span class="p">,</span> <span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">TEXT_POSITION_CHOICES</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsections</span><span class="p">:</span>
            <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">subsection</span><span class="p">,</span> <span class="n">sizerflags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">sizer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">UpdatePrimitiveValues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">selected_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_nodes</span>
        <span class="k">for</span> <span class="n">subsection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subsections</span><span class="p">:</span>
            <span class="n">subsection</span><span class="o">.</span><span class="n">UpdateValues</span><span class="p">(</span><span class="n">selected_nodes</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EditPanelForm</span><span class="p">(</span><span class="n">ScrolledPanel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for a form to be displayed on the edit panel.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ColorCallback: Callback type for when a color input is changed.</span>
<span class="sd">        FloatCallback: Callback type for when a float input is changed.</span>
<span class="sd">        canvas: The associated canvas.</span>
<span class="sd">        controller: The associated controller.</span>
<span class="sd">        net_index: The current network index. For now it is 0 since there is only one tab.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">canvas</span><span class="p">:</span> <span class="n">Canvas</span>
    <span class="n">controller</span><span class="p">:</span> <span class="n">IController</span>
    <span class="n">net_index</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">Window</span><span class="p">]</span>
    <span class="n">badges</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">Window</span><span class="p">]</span>
    <span class="n">sections</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FieldGrid</span><span class="p">]</span>
    <span class="n">_label_font</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Font</span>  <span class="c1">#: font for the form input label.</span>
    <span class="n">_info_bitmap</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Bitmap</span>  <span class="c1"># :  bitmap for the info badge (icon), for when an input is invalid.</span>
    <span class="n">_info_length</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1">#: length of the square reserved for _info_bitmap</span>
    <span class="n">_title</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span>  <span class="c1">#: title of the form</span>
    <span class="n">self_changes</span><span class="p">:</span> <span class="nb">bool</span>  <span class="c1">#: flag for if edits were made but the controller hasn&#39;t updated the view yet</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">canvas</span><span class="p">:</span> <span class="n">Canvas</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">IController</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">VSCROLL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetForegroundColour</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;toolbar_fg&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetBackgroundColour</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;toolbar_bg&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_title</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">StaticText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">ALIGN_CENTER</span><span class="p">)</span>  <span class="c1"># only displayed when node(s) are selected</span>
        <span class="n">title_font</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">FontInfo</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_title</span><span class="o">.</span><span class="n">SetFont</span><span class="p">(</span><span class="n">title_font</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="c1"># OVerride the ScrolledPanel behavior of jumping to the child that has the focus</span>
    <span class="k">def</span> <span class="nf">OnChildFocus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected_idx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span>

    <span class="k">def</span> <span class="nf">CreateChildren</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sizer</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BoxSizer</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">)</span>
        <span class="n">sizerflags</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SizerFlags</span><span class="p">()</span><span class="o">.</span><span class="n">Expand</span><span class="p">()</span>

        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_title</span><span class="p">,</span> <span class="n">sizerflags</span><span class="o">.</span><span class="n">Border</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">BOTTOM</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">StaticLine</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">sizerflags</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">sizerflags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CreateControls</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">SetSizer</span><span class="p">(</span><span class="n">sizer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SetupScrolling</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">UpdateAllFields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">CreateControls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">ExternalUpdate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UpdateAllFields</span><span class="p">()</span>

        <span class="c1"># clear validation errors</span>
        <span class="c1"># TODO</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">section</span><span class="o">.</span><span class="n">badges</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">class</span> <span class="nc">NodeForm</span><span class="p">(</span><span class="n">EditPanelForm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Form for editing one or multiple nodes.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">contiguous</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">id_ctrl</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span>
    <span class="n">conc_ctrl</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span>
    <span class="n">pos_ctrl</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span>
    <span class="n">size_ctrl</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">TextCtrl</span>
    <span class="n">nodeStatusDropDown</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Choice</span>
    <span class="n">compositeShapesDropDown</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Choice</span>
    <span class="n">lockNodeCheckBox</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span>

    <span class="n">_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]</span>  <span class="c1">#: current list of nodes in canvas.</span>
    <span class="n">_selected_idx</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>  <span class="c1">#: current list of selected indices in canvas.</span>
    <span class="n">_bounding_rect</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Rect</span><span class="p">]</span>  <span class="c1">#: the exact bounding rectangle of the selected nodes</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">canvas</span><span class="p">:</span> <span class="n">Canvas</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">IController</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">controller</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span> <span class="o">=</span> <span class="n">FieldGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># No padding</span>
        <span class="c1"># boolean to indicate whether only nodes are selected, and only nodes from the same</span>
        <span class="c1"># compartment are selected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_prim_section</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prim_section_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CreateChildren</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_idx</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">UpdateNodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Function called after the list of nodes have been updated.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateBoundingRect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ExternalUpdate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">NodesMovedOrResized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when nodes are moved or resized by dragging&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">evt</span><span class="o">.</span><span class="n">dragged</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># Possibly no nodes are selected because they are moved along with the compartments</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateBoundingRect</span><span class="p">()</span>
            <span class="n">prec</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">ChangePairValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
            <span class="n">ChangePairValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_UpdateBoundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update bounding rectangle; mixed indicates whether both nodes and comps are selected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">rect</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="c1"># It could be that compartments have been updated but selected indices have not.</span>
        <span class="c1"># In that case rects can be empty</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span> <span class="o">=</span> <span class="n">get_bounding_rect</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">UpdateSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_idx</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">comps_selected</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Function called after the list of selected nodes have been updated.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span> <span class="o">=</span> <span class="n">selected_idx</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateBoundingRect</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">comps_selected</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_nodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">comp_idx</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># clear position value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UpdateAllFields</span><span class="p">()</span>

            <span class="n">title_label</span> <span class="o">=</span> <span class="s1">&#39;Edit Node&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Edit Multiple Nodes&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_title</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>

            <span class="n">id_text</span> <span class="o">=</span> <span class="s1">&#39;identifier&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;identifiers&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">id_text</span><span class="p">)</span>

            <span class="n">concentration_text</span> <span class="o">=</span> <span class="s1">&#39;concentration&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;concentrations&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">conc_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">concentration_text</span><span class="p">)</span>

            <span class="n">size_text</span> <span class="o">=</span> <span class="s1">&#39;size&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;total span&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">size_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ExternalUpdate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">CreateControls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OnIdText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">conc_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conc_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OnConcText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;concentration&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc_ctrl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OnPosText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OnSizeText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodeStates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Floating Node&#39;</span><span class="p">,</span> <span class="s1">&#39;Boundary Node&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeStatusDropDown</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nodeStates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;node status&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeStatusDropDown</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodeStatusDropDown</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHOICE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnNodeStatusChoice</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lockNodeCheckBox</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;lock node&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lockNodeCheckBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lockNodeCheckBox</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnNodeLockCheckBox</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compShapeNames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_composite_shape_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compositeShapesDropDown</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compShapeNames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;shape&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compositeShapesDropDown</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compositeShapesDropDown</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHOICE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnCompositeShapes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_OnIdText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the ID control.&quot;&quot;&quot;</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">[</span><span class="n">nodei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span>
        <span class="n">ctrl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s2">&quot;ID cannot be empty&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">new_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s2">&quot;Not saved: Duplicate ID&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># loop terminated fine. There is no duplicate ID</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">rename_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">new_id</span><span class="p">)</span>
                    <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyNodesEvent</span><span class="p">([</span><span class="n">nodei</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_OnConcText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Callback for the concentration control. &quot;&quot;&quot;</span>
        <span class="n">new_conc</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1"># TODO should work for multiple nodes</span>
        <span class="p">[</span><span class="n">nodei</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span>
        <span class="n">ctrl_conc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_conc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_conc</span><span class="p">,</span> <span class="s2">&quot;Concentration cannot be empty&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_conc_float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">new_conc</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_conc</span><span class="p">,</span> <span class="s2">&quot;Concentration must be a numerical value&quot;</span><span class="p">)</span> <span class="c1"># TODO good message?</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">new_conc_float</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_conc</span><span class="p">,</span> <span class="s2">&quot;Concentration cannot be negative&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_concentration</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">new_conc_float</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyNodesEvent</span><span class="p">([</span><span class="n">nodei</span><span class="p">]))</span>
            <span class="c1"># TODO should have an event for this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conc_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_OnPosText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the position control.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">parse_num_pair</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">ctrl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">xy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s1">&#39;Should be in the form &quot;X, Y&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s1">&#39;Position coordinates should be non-negative&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">get_nodes_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="c1"># limit position to within the compartment</span>
        <span class="n">compi</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">comp_idx</span>
        <span class="k">if</span> <span class="n">compi</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">realsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">comp_idx_map</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">clamped</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">index_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
            <span class="n">clamped</span> <span class="o">=</span> <span class="n">clamp_rect_pos</span><span class="p">(</span><span class="n">Rect</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">bounds</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">!=</span> <span class="n">clamped</span> <span class="ow">or</span> <span class="n">pos</span> <span class="o">!=</span> <span class="n">clamped</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">clamped</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                    <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveNodesEvent</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span> <span class="n">clamped</span> <span class="o">-</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">clamped</span> <span class="o">=</span> <span class="n">clamp_rect_pos</span><span class="p">(</span><span class="n">Rect</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">bounds</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">!=</span> <span class="n">pos</span> <span class="ow">or</span> <span class="n">pos</span> <span class="o">!=</span> <span class="n">clamped</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">clamped</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">offset</span>
                    <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveNodesEvent</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_OnSizeText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the size control.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span>
        <span class="n">ctrl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
        <span class="n">wh</span> <span class="o">=</span> <span class="n">parse_num_pair</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s1">&#39;Should be in the form &quot;width, height&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">get_nodes_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="n">min_width</span> <span class="o">=</span> <span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;min_node_width&#39;</span><span class="p">)</span>
        <span class="n">min_height</span> <span class="o">=</span> <span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;min_node_height&#39;</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">wh</span><span class="p">)</span>
        <span class="c1"># limit size to be smaller than the compartment</span>
        <span class="n">compi</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">comp_idx</span>
        <span class="n">bounds</span><span class="p">:</span> <span class="n">Rect</span>
        <span class="k">if</span> <span class="n">compi</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">realsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">comp_idx_map</span><span class="p">[</span><span class="n">compi</span><span class="p">]</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">rect</span>

        <span class="n">min_nw</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="n">min_nh</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="n">min_ratio</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">min_width</span> <span class="o">/</span> <span class="n">min_nw</span><span class="p">,</span> <span class="n">min_height</span> <span class="o">/</span> <span class="n">min_nh</span><span class="p">)</span>
        <span class="n">min_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">min_ratio</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">size</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="o">.</span><span class="n">x</span> <span class="ow">or</span> <span class="n">size</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">min_size</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;The size of </span><span class="si">{}</span><span class="s1"> needs to be at least (</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;bounding box&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span>
                <span class="n">no_rzeros</span><span class="p">(</span><span class="n">min_size</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">no_rzeros</span><span class="p">(</span><span class="n">min_size</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># if size.x &gt; max_size.x or size.y &gt; max_size.y:</span>
        <span class="c1">#     message = &#39;The size of bounding box cannot exceed ({}, {})&#39;.format(</span>
        <span class="c1">#         no_rzeros(max_size.x, 2), no_rzeros(max_size.y, 2))</span>
        <span class="c1">#     self.main_section.SetValidationState(False, ctrl_id, message)</span>
        <span class="c1">#     return</span>

        <span class="c1"># NOTE clamp max size automatically rather than show error</span>
        <span class="n">clamped</span> <span class="o">=</span> <span class="n">size</span><span class="o">.</span><span class="n">reduce2</span><span class="p">(</span><span class="nb">min</span><span class="p">,</span> <span class="n">bounds</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">clamped</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">clamped</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">clamped</span><span class="o">.</span><span class="n">elem_div</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="n">rel_pos</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span>
                    <span class="n">new_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">rel_pos</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
                    <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">-</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">new_pos</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
                    <span class="c1"># clamp so that nodes are always within compartment/bounds</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">clamp_rect_pos</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>

                <span class="n">idx_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveNodesEvent</span><span class="p">(</span><span class="n">idx_list</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidResizeNodesEvent</span><span class="p">(</span><span class="n">idx_list</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">ratio</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">OnNodeStatusChoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the change node status, floating or boundary.&quot;&quot;&quot;</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodeStatusDropDown</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">selected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">floatingStatus</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">floatingStatus</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">get_nodes_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_floating_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">floatingStatus</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyNodesEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">OnCompositeShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compositeShapesDropDown</span><span class="o">.</span><span class="n">GetStringSelection</span><span class="p">()</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">get_nodes_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="n">shapei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compShapeNames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">shapei</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">shape_index</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_shape_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">shapei</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">shapei</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># changing node to circle</span>
                    <span class="c1"># if shape is being changed to circle, make bounding box sides equal</span>
                        <span class="n">dim</span> <span class="o">=</span> <span class="n">calc_node_dimensions</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">shape_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># if node was a circle previously, but not anymore, restore to default ratio</span>
                        <span class="n">default_ratio</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_height&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;node_width&#39;</span><span class="p">)</span>
                        <span class="n">dim</span> <span class="o">=</span> <span class="n">calc_node_dimensions</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">default_ratio</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_shape_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">shapei</span><span class="p">)</span>

            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyNodesEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdatePrimitiveFields</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">OnNodeLockCheckBox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the change node status, floating or boundary.&quot;&quot;&quot;</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetEventObject</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cb</span><span class="o">.</span><span class="n">GetValue</span><span class="p">():</span>
            <span class="n">nodeLocked</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nodeLocked</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="n">get_nodes_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_locked_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">nodeLocked</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyNodesEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_UpdatePrimitiveFields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sizer</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Sizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSizer</span><span class="p">()</span>
        <span class="n">sizerflags</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SizerFlags</span><span class="p">()</span><span class="o">.</span><span class="n">Expand</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Freeze</span><span class="p">()</span>

        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_nodes</span>
        <span class="n">shape_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">composite_shape</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_prim_section</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sizer</span><span class="o">.</span><span class="n">Detach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_prim_section</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_prim_section</span><span class="o">.</span><span class="n">Hide</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape_names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shape_index</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape_index</span>

            <span class="k">if</span> <span class="n">shape_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">prim_section_cache</span><span class="p">:</span>
                <span class="c1"># already created form for this shape before; restore the cached one</span>
                <span class="n">prim_section</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prim_section_cache</span><span class="p">[</span><span class="n">shape_index</span><span class="p">]</span>
                <span class="n">prim_section</span><span class="o">.</span><span class="n">Show</span><span class="p">()</span>
                <span class="c1"># self.AddChild(prim_section)</span>
                <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">prim_section</span><span class="p">,</span> <span class="n">sizerflags</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># need to create new one</span>
                <span class="k">assert</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">composite_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">prim_section</span> <span class="o">=</span> <span class="n">PrimitiveSection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">composite_shape</span><span class="p">)</span>
                <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">prim_section</span><span class="p">,</span> <span class="n">sizerflags</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prim_section_cache</span><span class="p">[</span><span class="n">shape_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">prim_section</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">last_prim_section</span> <span class="o">=</span> <span class="n">prim_section</span>

            <span class="n">prim_section</span><span class="o">.</span><span class="n">UpdatePrimitiveValues</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># don&#39;t need to do anything since this whole section is hidden</span>

        <span class="c1"># need to tell parent to adjust height as well</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GetParent</span><span class="p">()</span><span class="o">.</span><span class="n">Layout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Thaw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">UpdateAllFields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the form field values based on current data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">get_nodes_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="n">prec</span> <span class="o">=</span> <span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;decimal_precision&#39;</span><span class="p">)</span>
        <span class="n">id_text</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">conc_text</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">floatingNode</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="n">lockNode</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="n">shape_name</span><span class="p">:</span> <span class="nb">str</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ChangePairValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
            <span class="n">ChangePairValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">id_text</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conc_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">conc_text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span>
            <span class="n">floatingNode</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">floatingNode</span>
            <span class="n">lockNode</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">lockNode</span>
            <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">composite_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">shape_name</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">composite_shape</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">id_text</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conc_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">conc_text</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">concentration</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)))</span>
            <span class="n">floatingNode</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">floatingNode</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>
            <span class="n">lockNode</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">lockNode</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>
            <span class="n">shape_name_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">composite_shape</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape_name_set</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">shape_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">shape_name_set</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shape_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdatePrimitiveFields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">id_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conc_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">conc_text</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">floatingNode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeStatusDropDown</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodeStatusDropDown</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">lockNode</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lockNodeCheckBox</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lockNodeCheckBox</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">shape_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compositeShapesDropDown</span><span class="o">.</span><span class="n">SetStringSelection</span><span class="p">(</span><span class="n">shape_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compositeShapesDropDown</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">NOT_FOUND</span><span class="p">)</span>


<div class="viewcode-block" id="StoichInfo"><a class="viewcode-back" href="../../rkviewer/rkviewer.html#rkviewer.forms.StoichInfo">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">StoichInfo</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Helper class that stores node stoichiometry info for reaction form&quot;&quot;&quot;</span>
    <span class="n">nodei</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">stoich</span><span class="p">:</span> <span class="nb">float</span></div>


<span class="sd">&#39;&#39;&#39;Section for editing stoichiometry, includes only reactants or only products,</span>
<span class="sd">so there are two of this.&#39;&#39;&#39;</span>
<span class="k">class</span> <span class="nc">StoichSection</span><span class="p">(</span><span class="n">FieldGrid</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">form</span><span class="p">:</span> <span class="s1">&#39;ReactionForm&#39;</span><span class="p">,</span> <span class="n">stoichs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StoichInfo</span><span class="p">],</span> <span class="n">reai</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">is_reactants</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">form</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_subtitle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AppendSubtitle</span><span class="p">(</span><span class="s1">&#39;Reactants&#39;</span> <span class="k">if</span> <span class="n">is_reactants</span> <span class="k">else</span> <span class="s1">&#39;Products&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">stoich</span> <span class="ow">in</span> <span class="n">stoichs</span><span class="p">:</span>
            <span class="n">stoich_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">no_rzeros</span><span class="p">(</span><span class="n">stoich</span><span class="o">.</span><span class="n">stoich</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">node_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_node_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">stoich</span><span class="o">.</span><span class="n">nodei</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">stoich_ctrl</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_reactants</span><span class="p">:</span>
                <span class="n">inner_callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MakeSetSrcStoichFunction</span><span class="p">(</span><span class="n">reai</span><span class="p">,</span> <span class="n">stoich</span><span class="o">.</span><span class="n">nodei</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inner_callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MakeSetDestStoichFunction</span><span class="p">(</span><span class="n">reai</span><span class="p">,</span> <span class="n">stoich</span><span class="o">.</span><span class="n">nodei</span><span class="p">)</span>
            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MakeFloatCtrlFunction</span><span class="p">(</span><span class="n">stoich_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">(),</span> <span class="n">inner_callback</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                                    <span class="n">left_incl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">stoich_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">MakeSetSrcStoichFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reai</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nodei</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">ret</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_src_node_stoich</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyReactionEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_idx</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">MakeSetDestStoichFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reai</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nodei</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">ret</span><span class="p">(</span><span class="n">val</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_dest_node_stoich</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyReactionEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">selected_idx</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">ret</span>


<span class="k">class</span> <span class="nc">ReactionForm</span><span class="p">(</span><span class="n">EditPanelForm</span><span class="p">):</span>
    <span class="n">auto_center_ctrl</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">canvas</span><span class="p">:</span> <span class="n">Canvas</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">IController</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">controller</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span> <span class="o">=</span> <span class="n">FieldGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CreateChildren</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">CreateControls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OnIdText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ratelaw_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratelaw_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OnRateLawText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;rate law&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ratelaw_ctrl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fill_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_alpha_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateColorControl</span><span class="p">(</span>
            <span class="s1">&#39;fill color&#39;</span><span class="p">,</span> <span class="s1">&#39;fill opacity&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_OnFillColorChanged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FillAlphaCallback</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stroke_width_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="n">stroke_cb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">MakeFloatCtrlFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stroke_width_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">(),</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">_StrokeWidthCallback</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stroke_width_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="n">stroke_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;line width&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stroke_width_ctrl</span><span class="p">)</span>

        <span class="c1"># Whether the center position should be autoly set?</span>
        <span class="c1">#self.auto_center_ctrl = wx.CheckBox(self.main_section)</span>
        <span class="c1">#self.auto_center_ctrl.SetValue(True)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckBox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKBOX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_AutoCenterCallback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;auto center pos&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CenterPosCallback</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;center position&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reactant_subtitle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_product_subtitle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactant_stoich_ctrls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">product_stoich_ctrls</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="n">states</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bezier curve&#39;</span><span class="p">,</span> <span class="s1">&#39;straight line&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxnStatusDropDown</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">states</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;reaction status&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxnStatusDropDown</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rxnStatusDropDown</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHOICE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnRxnStatusChoice</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mod_tip_dropdown</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">ComboBox</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ModifierTipStyle</span><span class="p">],</span> <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">CB_READONLY</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;modifier tip&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_tip_dropdown</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod_tip_dropdown</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_COMBOBOX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ModifierTipCallback</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_modifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modifiers_ctrl</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">CheckListBox</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="n">wx</span><span class="o">.</span><span class="n">LB_NEEDED_SB</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;modifiers&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modifiers_ctrl</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modifiers_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_CHECKLISTBOX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">OnModifierCheck</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactants_section</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">products_section</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_OnIdText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the ID control.&quot;&quot;&quot;</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Reaction ID field should be disabled when &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;multiple are selected&#39;</span>
        <span class="p">[</span><span class="n">reai</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span>
        <span class="n">ctrl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s2">&quot;ID cannot be empty&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rxn</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">new_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s2">&quot;Not saved: Duplicate ID&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># loop terminated fine. There is no duplicate ID</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">rename_reaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">new_id</span><span class="p">)</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyReactionEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_StrokeWidthCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="n">reactions</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_line_thickness</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyReactionEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">OnRxnStatusChoice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the change reaction status, bezier curve or straight line.&quot;&quot;&quot;</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rxnStatusDropDown</span><span class="o">.</span><span class="n">GetSelection</span><span class="p">()</span>
        <span class="c1"># TODO this is hardcoded. If the text changes this wouldn&#39;t work</span>
        <span class="k">if</span> <span class="n">selection</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bezierCurves</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bezierCurves</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">rxns</span> <span class="o">=</span> <span class="n">get_rxns_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">rxns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_bezier_curves</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bezierCurves</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyReactionEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">ModifierTipCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the change reaction status, bezier curve or straight line.&quot;&quot;&quot;</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_tip_dropdown</span><span class="o">.</span><span class="n">GetValue</span><span class="p">()</span>
        <span class="n">entry</span><span class="p">:</span> <span class="n">ModifierTipStyle</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ModifierTipStyle</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">status</span><span class="p">:</span>
                <span class="n">entry</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;Unable to find corresponding enum entry to dropdown selection. &#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;This is not supposed to happen.&#39;</span><span class="p">)</span>

        <span class="n">rxns</span> <span class="o">=</span> <span class="n">get_rxns_by_idx</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">rxns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_modifier_tip_style</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyReactionEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_AutoCenterCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>

        <span class="n">checked</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetInt</span><span class="p">()</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">prec</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">reaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">reaction_idx_map</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">))]</span>
        <span class="n">centroid_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">GetReactionCentroids</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">)</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="n">centroid_map</span><span class="p">[</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">checked</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># Move centroid handle along if centroid changed.</span>
                <span class="k">if</span> <span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="n">centroid</span> <span class="o">-</span> <span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span>
                    <span class="k">if</span> <span class="n">offset</span> <span class="o">!=</span> <span class="n">Vec2</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_center_handle</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">src_c_handle</span><span class="o">.</span><span class="n">tip</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">no_rzeros</span><span class="p">(</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">prec</span><span class="p">),</span> <span class="n">no_rzeros</span><span class="p">(</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
            <span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">centroid</span><span class="p">)</span>
        

    <span class="k">def</span> <span class="nf">_CenterPosCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">parse_num_pair</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">ctrl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">xy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s1">&#39;Should be in the form &quot;X, Y&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s1">&#39;Position coordinates should be non-negative&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">reaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">reaction_idx_map</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">))]</span>
        <span class="k">if</span> <span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_center</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveReactionCenterEvent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_OnFillColorChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the fill color control.&quot;&quot;&quot;</span>
        <span class="n">reactions</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">on_msw</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_fill_rgb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we can set both the RGB and the alpha at the same time</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_fill_rgb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_fill_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fill</span><span class="o">.</span><span class="n">Alpha</span><span class="p">())</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyReactionEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_FillAlphaCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for when the fill alpha changes.&quot;&quot;&quot;</span>
        <span class="n">reactions</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">rxn</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_fill_alpha</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">rxn</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyReactionEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_OnRateLawText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">CommandEvent</span><span class="p">):</span>
        <span class="n">ratelaw</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Reaction rate law field should be disabled when &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;multiple are selected&#39;</span>
        <span class="p">[</span><span class="n">reai</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyReactionEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_ratelaw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">ratelaw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">OnModifierCheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">CommandEvent</span><span class="p">):</span>
        <span class="n">evt</span><span class="o">.</span><span class="n">Skip</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">reactions</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">reactions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">reaction</span> <span class="o">=</span> <span class="n">reactions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">new_modifiers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modifiers_ctrl</span><span class="o">.</span><span class="n">GetCheckedItems</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_reaction_modifiers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">new_modifiers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CanvasUpdated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reactions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Reaction</span><span class="p">],</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Function called after the canvas has been updated.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span> <span class="o">=</span> <span class="n">reactions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="n">new_node_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="c1"># if new_node_indices != self.node_indices:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_indices</span> <span class="o">=</span> <span class="n">new_node_indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateModifierList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ExternalUpdate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">UpdateSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_idx</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Function called after the list of selected reactions have been updated.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span> <span class="o">=</span> <span class="n">selected_idx</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">title_label</span> <span class="o">=</span> <span class="s1">&#39;Edit Reaction&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> \
                <span class="k">else</span> <span class="s1">&#39;Edit Multiple Reactions&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_title</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>

            <span class="n">id_text</span> <span class="o">=</span> <span class="s1">&#39;identifier&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;identifiers&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">id_text</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UpdateAllFields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ExternalUpdate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_UpdateModifierList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># NOTE if slightly better performance is wanted, we don&#39;t have to update this widget</span>
        <span class="c1"># immediately. Rather we can have a dirty flag and update only when displaying</span>
        <span class="n">node_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">id</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">original_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">+=</span> <span class="s1">&#39; (alias)&#39;</span>
            <span class="n">node_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">modifiers_ctrl</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">node_names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateModifierSelection</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_UpdateModifierSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">checked_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_nodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modifiers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modifiers_ctrl</span><span class="o">.</span><span class="n">SetCheckedItems</span><span class="p">(</span><span class="n">checked_indices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_UpdateStoichFields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reai</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reactants</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StoichInfo</span><span class="p">],</span> <span class="n">products</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">StoichInfo</span><span class="p">]):</span>
        <span class="n">sizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSizer</span><span class="p">()</span>
        <span class="n">sizerflags</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">SizerFlags</span><span class="p">()</span><span class="o">.</span><span class="n">Expand</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Freeze</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactants_section</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sizer</span><span class="o">.</span><span class="n">Detach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactants_section</span><span class="p">)</span>
            <span class="n">sizer</span><span class="o">.</span><span class="n">Detach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">products_section</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reactants_section</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">products_section</span><span class="o">.</span><span class="n">Destroy</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">reactants</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">products</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reactants_section</span> <span class="o">=</span> <span class="n">StoichSection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">reactants</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">products_section</span> <span class="o">=</span> <span class="n">StoichSection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">products</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reactants_section</span><span class="p">,</span> <span class="n">sizerflags</span><span class="p">)</span>
            <span class="n">sizer</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">products_section</span><span class="p">,</span> <span class="n">sizerflags</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reactants_section</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">products_section</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Both reactants and products are empty; don&#39;t add</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">products</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Layout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Thaw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_GetSrcStoichs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reai</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_list_of_src_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reai</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">StoichInfo</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_src_node_stoich</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="nb">id</span><span class="p">))</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_GetDestStoichs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reai</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_list_of_dest_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reai</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">StoichInfo</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">get_dest_node_stoich</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="nb">id</span><span class="p">))</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">UpdateAllFields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update all reaction fields from current data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">reactions</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactions</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="n">id_text</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">)))</span>
        <span class="n">fill</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span>
        <span class="n">fill_alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
        <span class="n">ratelaw_text</span><span class="p">:</span> <span class="nb">str</span>

        <span class="n">prec</span> <span class="o">=</span> <span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;decimal_precision&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">[</span><span class="n">reaction</span><span class="p">]</span> <span class="o">=</span> <span class="n">reactions</span>
            <span class="n">reai</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">index</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">fill_color</span>
            <span class="n">fill_alpha</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">fill_color</span><span class="o">.</span><span class="n">Alpha</span><span class="p">()</span>
            <span class="n">ratelaw_text</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">rate_law</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ratelaw_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
            <span class="n">auto_set</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">auto_set</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="ow">not</span> <span class="n">auto_set</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">centroid</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">no_rzeros</span><span class="p">(</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">prec</span><span class="p">),</span> <span class="n">no_rzeros</span><span class="p">(</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
                <span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateStoichFields</span><span class="p">(</span><span class="n">reai</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetSrcStoichs</span><span class="p">(</span><span class="n">reai</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetDestStoichs</span><span class="p">(</span><span class="n">reai</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modifiers_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modifiers</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">modifiers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateModifierSelection</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>
            <span class="n">fill</span><span class="p">,</span> <span class="n">fill_alpha</span> <span class="o">=</span> <span class="n">GetMultiColor</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">fill_color</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">))</span>
            <span class="n">ratelaw_text</span> <span class="o">=</span> <span class="s1">&#39;multiple&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ratelaw_ctrl</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">auto_center_ctrl</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center_pos_ctrl</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateStoichFields</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modifiers_ctrl</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modifiers</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateModifierSelection</span><span class="p">()</span>

        <span class="n">bezierCurves</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">bezierCurves</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">)</span>
        <span class="n">mod_tip_style</span> <span class="o">=</span> <span class="n">GetMultiEnum</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">modifier_tip_style</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">),</span> <span class="n">ModifierTipStyle</span><span class="o">.</span><span class="n">CIRCLE</span><span class="p">)</span>
        <span class="n">stroke_width</span> <span class="o">=</span> <span class="n">GetMultiFloatText</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">thickness</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reactions</span><span class="p">),</span> <span class="n">prec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">id_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_ctrl</span><span class="o">.</span><span class="n">SetColour</span><span class="p">(</span><span class="n">fill</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratelaw_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">ratelaw_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stroke_width_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">stroke_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mod_tip_dropdown</span><span class="o">.</span><span class="n">SetValue</span><span class="p">(</span><span class="n">mod_tip_style</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">on_msw</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill_alpha_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">AlphaToText</span><span class="p">(</span><span class="n">fill_alpha</span><span class="p">,</span> <span class="n">prec</span><span class="p">))</span>

        <span class="c1"># HMS Replaced stings with contants</span>
        <span class="k">if</span> <span class="n">bezierCurves</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rxnStatusDropDown</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rxnStatusDropDown</span><span class="o">.</span><span class="n">SetSelection</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CompartmentForm</span><span class="p">(</span><span class="n">EditPanelForm</span><span class="p">):</span>
    <span class="n">_compartments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Compartment</span><span class="p">]</span>
    <span class="n">contiguous</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">canvas</span><span class="p">:</span> <span class="n">Canvas</span><span class="p">,</span> <span class="n">controller</span><span class="p">:</span> <span class="n">IController</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">controller</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span> <span class="o">=</span> <span class="n">FieldGrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">CreateChildren</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">CreateControls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OnIdText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OnPosText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_OnSizeText</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">volume_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_ctrl</span><span class="p">)</span>
        <span class="n">volume_callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">MakeFloatCtrlFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volume_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">(),</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_VolumeCallback</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">left_incl</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="n">volume_callback</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fill_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fill_alpha_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateColorControl</span><span class="p">(</span>
            <span class="s1">&#39;fill color&#39;</span><span class="p">,</span> <span class="s1">&#39;fill opacity&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_OnFillColorChanged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FillAlphaCallback</span><span class="p">,)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">border_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">border_alpha_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateColorControl</span><span class="p">(</span>
            <span class="s1">&#39;border color&#39;</span><span class="p">,</span> <span class="s1">&#39;border opacity&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_OnBorderColorChanged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BorderAlphaCallback</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">border_width_ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">CreateTextCtrl</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">AppendControl</span><span class="p">(</span><span class="s1">&#39;border width&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">border_width_ctrl</span><span class="p">)</span>
        <span class="n">border_callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">MakeFloatCtrlFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">border_width_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">(),</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_BorderWidthCallback</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">border_width_ctrl</span><span class="o">.</span><span class="n">Bind</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">EVT_TEXT</span><span class="p">,</span> <span class="n">border_callback</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_OnIdText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the ID control.&quot;&quot;&quot;</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Compartment ID field should be disabled when &#39;</span> <span class="o">+</span> \
            <span class="s1">&#39;multiple are selected&#39;</span>
        <span class="p">[</span><span class="n">compi</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span>
        <span class="n">ctrl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s2">&quot;ID cannot be empty&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">new_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s2">&quot;Not saved: Duplicate ID&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="c1"># loop terminated fine. There is no duplicate ID</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">rename_compartment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">compi</span><span class="p">,</span> <span class="n">new_id</span><span class="p">)</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyCompartmentsEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_OnPosText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the position control.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">parse_num_pair</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">ctrl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">xy</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s1">&#39;Should be in the form &quot;X, Y&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pos</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s1">&#39;Position coordinates should be non-negative&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">realsize</span><span class="p">)</span>
        <span class="n">clamped</span> <span class="o">=</span> <span class="n">clamp_rect_pos</span><span class="p">(</span><span class="n">Rect</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">bounds</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">!=</span> <span class="n">pos</span> <span class="ow">or</span> <span class="n">pos</span> <span class="o">!=</span> <span class="n">clamped</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">clamped</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                    <span class="n">comp</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">offset</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveCompartmentsEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">),</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_OnSizeText</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the size control.&quot;&quot;&quot;</span>
        <span class="n">ctrl_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">evt</span><span class="o">.</span><span class="n">GetString</span><span class="p">()</span>
        <span class="n">wh</span> <span class="o">=</span> <span class="n">parse_num_pair</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="s1">&#39;Should be in the form &quot;width, height&quot;&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">wh</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">comp_min_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">select_box</span><span class="o">.</span><span class="n">compute_min_ratio</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">comp_min_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">comp_min_ratio</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">size</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">.</span><span class="n">x</span> <span class="ow">or</span> <span class="n">size</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="n">limit</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Size of </span><span class="si">{}</span><span class="s1"> needs to be at least (</span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s1">&#39;bounding box&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;compartment&#39;</span><span class="p">,</span>
                <span class="n">no_rzeros</span><span class="p">(</span><span class="n">limit</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">no_rzeros</span><span class="p">(</span><span class="n">limit</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">ctrl_id</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">clamped</span> <span class="o">=</span> <span class="n">clamp_rect_size</span><span class="p">(</span><span class="n">Rect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">realsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">clamped</span> <span class="ow">or</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">clamped</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">clamped</span><span class="o">.</span><span class="n">elem_div</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">peripheral_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="n">peripheral_offsets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                    <span class="n">rel_pos</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span>
                    <span class="n">new_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">rel_pos</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>
                    <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">-</span> <span class="n">comp</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
                    <span class="n">comp</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">new_pos</span>
                    <span class="n">comp</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">ratio</span><span class="p">)</span>

                    <span class="n">pnodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">node_idx_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">pnodes</span><span class="p">:</span>
                        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">clamp_rect_pos</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new_pos</span> <span class="o">!=</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">new_pos</span>
                            <span class="n">peripheral_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                            <span class="n">peripheral_offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_pos</span> <span class="o">-</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

                <span class="n">idx_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveCompartmentsEvent</span><span class="p">(</span><span class="n">idx_list</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidResizeCompartmentsEvent</span><span class="p">(</span><span class="n">idx_list</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peripheral_nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveNodesEvent</span><span class="p">(</span><span class="n">peripheral_nodes</span><span class="p">,</span> <span class="n">peripheral_offsets</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_compartment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_compartment_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">peripheral_nodes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">SetValidationState</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_VolumeCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for when the border width changes.&quot;&quot;&quot;</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_compartment_volume</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">volume</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyCompartmentsEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_OnFillColorChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fill</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the fill color control.&quot;&quot;&quot;</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">on_msw</span><span class="p">():</span>
                    <span class="n">fill</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="n">fill</span><span class="o">.</span><span class="n">GetRGB</span><span class="p">())</span>  <span class="c1"># remove alpha channel</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_compartment_fill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">fill</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyCompartmentsEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_OnBorderColorChanged</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">border</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for the border color control.&quot;&quot;&quot;</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">on_msw</span><span class="p">():</span>
                    <span class="n">border</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="n">border</span><span class="o">.</span><span class="n">GetRGB</span><span class="p">())</span>  <span class="c1"># remove alpha channel</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_compartment_border</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyCompartmentsEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_FillAlphaCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for when the fill alpha changes.&quot;&quot;&quot;</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="n">new_fill</span> <span class="o">=</span> <span class="n">change_opacity</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">fill</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_compartment_fill</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">new_fill</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyCompartmentsEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_BorderAlphaCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for when the border alpha changes.&quot;&quot;&quot;</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="n">new_border</span> <span class="o">=</span> <span class="n">change_opacity</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">border</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="mi">255</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_compartment_border</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">new_border</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyCompartmentsEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_BorderWidthCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Callback for when the border width changes.&quot;&quot;&quot;</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_compartment_border_width</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidModifyCompartmentsEvent</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">UpdateCompartments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Compartment</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="o">=</span> <span class="n">comps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateBoundingRect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ExternalUpdate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">UpdateSelection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_idx</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">nodes_selected</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span> <span class="o">=</span> <span class="n">selected_idx</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateBoundingRect</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">nodes_selected</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># clear position value</span>
            <span class="c1"># self.pos_ctrl.ChangeValue(&#39;&#39;)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">UpdateAllFields</span><span class="p">()</span>

            <span class="n">title_label</span> <span class="o">=</span> <span class="s1">&#39;Edit Compartment&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;Edit Multiple Compartments&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_title</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">title_label</span><span class="p">)</span>

            <span class="n">id_text</span> <span class="o">=</span> <span class="s1">&#39;identifier&#39;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;identifiers&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">main_section</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">GetId</span><span class="p">()]</span><span class="o">.</span><span class="n">SetLabel</span><span class="p">(</span><span class="n">id_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ExternalUpdate</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">UpdateAllFields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">self_changes</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">comps</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span>
        <span class="n">prec</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">id_text</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">])</span>
        <span class="n">fill</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span>
        <span class="n">fill_alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
        <span class="n">border</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">)</span>
        <span class="n">border_width</span> <span class="o">=</span> <span class="n">GetMultiFloatText</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">border_width</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">),</span> <span class="n">prec</span><span class="p">)</span>
        <span class="n">volume</span> <span class="o">=</span> <span class="n">GetMultiFloatText</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">volume</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">),</span> <span class="n">prec</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">contiguous</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ChangePairValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
            <span class="n">ChangePairValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">[</span><span class="n">comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">comps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">Enable</span><span class="p">()</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">fill</span>
            <span class="n">fill_alpha</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">fill</span><span class="o">.</span><span class="n">Alpha</span><span class="p">()</span>
            <span class="n">border</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">border</span>
            <span class="n">border_alpha</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">border</span><span class="o">.</span><span class="n">Alpha</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">Disable</span><span class="p">()</span>
            <span class="n">fill</span><span class="p">,</span> <span class="n">fill_alpha</span> <span class="o">=</span> <span class="n">GetMultiColor</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fill</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">))</span>
            <span class="n">border</span><span class="p">,</span> <span class="n">border_alpha</span> <span class="o">=</span> <span class="n">GetMultiColor</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">border</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">id_text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fill_ctrl</span><span class="o">.</span><span class="n">SetColour</span><span class="p">(</span><span class="n">fill</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">border_ctrl</span><span class="o">.</span><span class="n">SetColour</span><span class="p">(</span><span class="n">border</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>

        <span class="c1"># set fill alpha if on windows</span>
        <span class="k">if</span> <span class="n">on_msw</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fill_alpha_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">AlphaToText</span><span class="p">(</span><span class="n">fill_alpha</span><span class="p">,</span> <span class="n">prec</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">border_alpha_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">AlphaToText</span><span class="p">(</span><span class="n">border_alpha</span><span class="p">,</span> <span class="n">prec</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">border_width_ctrl</span><span class="o">.</span><span class="n">ChangeValue</span><span class="p">(</span><span class="n">border_width</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">CompsMovedOrResized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when nodes are moved or resized by dragging&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">evt</span><span class="o">.</span><span class="n">dragged</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_UpdateBoundingRect</span><span class="p">()</span>
        <span class="n">prec</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">ChangePairValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>
        <span class="n">ChangePairValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_ctrl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">prec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_UpdateBoundingRect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update bounding rectangle; mixed indicates whether both nodes and comps are selected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">rect</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected_idx</span><span class="p">]</span>
        <span class="c1"># It could be that compartments have been updated but selected indices have not.</span>
        <span class="c1"># In that case rects can be empty</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bounding_rect</span> <span class="o">=</span> <span class="n">get_bounding_rect</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2022, Jin Xu, Gary Geng, Nhan D. Nguyen, Carmen Perena-Cortes, Claire Samuels, Herbert M. Sauro

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>