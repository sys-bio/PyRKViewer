

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rkviewer.canvas.elements &mdash; SBcoyote 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> SBcoyote
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../QuickStart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../PluginDevelopment.html">Plugin Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../PluginReference.html">Plugin Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../InternalJSONModelFormat.html">Internal JSON Model Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../CoreDevelopment.html">Core Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Reference.html">Core Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SBcoyote</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>rkviewer.canvas.elements</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for rkviewer.canvas.elements</h1><div class="highlight"><pre>
<span></span><span class="c1"># from __future__ import annotations</span>
<span class="c1"># pylint: disable=maybe-no-member</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">chain</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterator</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">cast</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>

<span class="kn">from</span> <span class="nn">numpy.lib.utils</span> <span class="kn">import</span> <span class="n">source</span>
<span class="kn">from</span> <span class="nn">rkviewer.canvas.data</span> <span class="kn">import</span> <span class="n">CirclePrim</span><span class="p">,</span> <span class="n">CompositeShape</span><span class="p">,</span> <span class="n">RectanglePrim</span><span class="p">,</span> <span class="n">TrianglePrim</span><span class="p">,</span> <span class="n">Transform</span><span class="p">,</span> <span class="n">TextPrim</span><span class="p">,</span> <span class="n">HexagonPrim</span><span class="p">,</span> <span class="n">LinePrim</span>

<span class="kn">import</span> <span class="nn">wx</span>

<span class="kn">from</span> <span class="nn">..config</span> <span class="kn">import</span> <span class="n">Color</span><span class="p">,</span> <span class="n">get_setting</span><span class="p">,</span> <span class="n">get_theme</span>
<span class="kn">from</span> <span class="nn">..events</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">CanvasEvent</span><span class="p">,</span> <span class="n">DidChangeCompartmentOfNodesEvent</span><span class="p">,</span> <span class="n">DidCommitDragEvent</span><span class="p">,</span> <span class="n">DidMoveBezierHandleEvent</span><span class="p">,</span> <span class="n">DidMoveReactionCenterEvent</span><span class="p">,</span> <span class="n">DidResizeCompartmentsEvent</span><span class="p">,</span> <span class="n">DidResizeNodesEvent</span><span class="p">,</span> <span class="n">DidMoveCompartmentsEvent</span><span class="p">,</span>
    <span class="n">DidMoveNodesEvent</span><span class="p">,</span> <span class="n">bind_handler</span><span class="p">,</span>
    <span class="n">post_event</span><span class="p">,</span> <span class="n">unbind_handler</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">..mvc</span> <span class="kn">import</span> <span class="n">IController</span>
<span class="kn">from</span> <span class="nn">..utils</span> <span class="kn">import</span> <span class="n">change_opacity</span><span class="p">,</span> <span class="n">even_round</span><span class="p">,</span> <span class="n">gchain</span><span class="p">,</span> <span class="n">int_round</span>
<span class="kn">from</span> <span class="nn">.data</span> <span class="kn">import</span> <span class="n">Compartment</span><span class="p">,</span> <span class="n">HandleData</span><span class="p">,</span> <span class="n">ModifierTipStyle</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">Reaction</span><span class="p">,</span> <span class="n">ReactionBezier</span><span class="p">,</span> <span class="n">RectData</span><span class="p">,</span> <span class="n">SpeciesBezier</span><span class="p">,</span> <span class="n">PolygonPrim</span><span class="p">,</span> <span class="n">TextAlignment</span><span class="p">,</span> <span class="n">TextPosition</span>
<span class="kn">from</span> <span class="nn">.geometry</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Rect</span><span class="p">,</span>
    <span class="n">Vec2</span><span class="p">,</span>
    <span class="n">clamp_point</span><span class="p">,</span> <span class="n">clamp_rect_pos</span><span class="p">,</span>
    <span class="n">get_bounding_rect</span><span class="p">,</span>
    <span class="n">padded_rect</span><span class="p">,</span>
    <span class="n">pt_in_circle</span><span class="p">,</span>
    <span class="n">pt_in_rect</span><span class="p">,</span> <span class="n">rotate_unit</span><span class="p">,</span> <span class="n">segment_rect_intersection</span><span class="p">,</span>
    <span class="n">pt_on_rect_sides</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="n">InputMode</span><span class="p">,</span> <span class="n">cstate</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">draw_rect</span>

<span class="c1"># SetCursorFn = Callable[[wx.Cursor], None]</span>
<span class="n">Layer</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]]</span>


<div class="viewcode-block" id="layer_above"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.layer_above">[docs]</a><span class="k">def</span> <span class="nf">layer_above</span><span class="p">(</span><span class="n">layer</span><span class="p">:</span> <span class="n">Layer</span><span class="p">,</span> <span class="n">count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Layer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return the next layer above this layer, without increasing the length of the layer list.</span>

<span class="sd">    count is optionally the layer number increment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Layer count must be at least 1!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">layer</span> <span class="o">+</span> <span class="n">count</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">layer</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">last</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">layer</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">+</span> <span class="n">count</span><span class="p">,)</span></div>


<div class="viewcode-block" id="CanvasElement"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement">[docs]</a><span class="k">class</span> <span class="nc">CanvasElement</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for an element positioned on the canvas.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        layers: The layer(s) number of this element.</span>
<span class="sd">        enabled: Whether the element is enabled.</span>
<span class="sd">        destroyed: Whether the object was destroyed (if this is True then you shouldn&#39;t use this)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span><span class="p">:</span> <span class="n">Layer</span>
    <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">destroyed</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Layer</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">(</span><span class="n">layers</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroyed</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="CanvasElement.set_layers"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.set_layers">[docs]</a>    <span class="k">def</span> <span class="nf">set_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Layer</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">(</span><span class="n">layers</span><span class="p">,)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">layers</span></div>

<div class="viewcode-block" id="CanvasElement.destroy"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.destroy">[docs]</a>    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Destroy this element; override this for specific implementations.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destroyed</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CanvasElement.pos_inside"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.pos_inside">[docs]</a>    <span class="k">def</span> <span class="nf">pos_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Returns whether logical_pos is inside the diplayed shape of this element.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="CanvasElement.on_paint"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.on_paint">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">on_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Paint the shape onto the given GraphicsContext.</span>

<span class="sd">        This draws onto the scrolled canvas, i.e. the position of the drawn item will respond to</span>
<span class="sd">        scrolling, so you don&#39;t need to account for that.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="CanvasElement.on_paint_cue"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.on_paint_cue">[docs]</a>    <span class="k">def</span> <span class="nf">on_paint_cue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;This is called to paint special visual cues tha tthe element may need to display&#39;&#39;&#39;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="CanvasElement.on_mouse_enter"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.on_mouse_enter">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handler for when the mouse has entered the shape.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="CanvasElement.on_mouse_leave"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.on_mouse_leave">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_leave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handler for when the mouse has exited the shape&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="CanvasElement.on_mouse_move"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.on_mouse_move">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handler for when the mouse moves inside the shape, with the left mouse button up.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="CanvasElement.on_mouse_drag"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.on_mouse_drag">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_drag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handler for when the mouse drags inside the shape, with the left mouse button down.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="CanvasElement.on_left_down"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.on_left_down">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handler for when the mouse left button is pressed down inside the shape.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="CanvasElement.on_left_up"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.on_left_up">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Handler for when the mouse left button is springs up inside the shape.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="CanvasElement.bounding_rect"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CanvasElement.bounding_rect">[docs]</a>    <span class="k">def</span> <span class="nf">bounding_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Rect</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Return the bounding rectangle of the element.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Rect</span><span class="p">(</span><span class="n">Vec2</span><span class="p">(),</span> <span class="n">Vec2</span><span class="p">())</span></div></div>


<div class="viewcode-block" id="NodeElement"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.NodeElement">[docs]</a><span class="k">class</span> <span class="nc">NodeElement</span><span class="p">(</span><span class="n">CanvasElement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;CanvasElement for nodes.&quot;&quot;&quot;</span>
    <span class="n">node</span><span class="p">:</span> <span class="n">Node</span>
    <span class="n">canvas</span><span class="p">:</span> <span class="n">Any</span>

    <span class="c1"># HACK no type specified for canvas since otherwise there would be circular dependency</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Layer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="n">node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gfont</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># In the future</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">font_scale</span> <span class="o">=</span> <span class="mi">1</span>

<div class="viewcode-block" id="NodeElement.pos_inside"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.NodeElement.pos_inside">[docs]</a>    <span class="k">def</span> <span class="nf">pos_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pt_in_rect</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">s_rect</span><span class="p">)</span></div>

<div class="viewcode-block" id="NodeElement.on_paint"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.NodeElement.on_paint">[docs]</a>    <span class="k">def</span> <span class="nf">on_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gfont</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">font_scale</span> <span class="o">!=</span> <span class="n">cstate</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
            <span class="n">font</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">FontInfo</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gfont</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreateFont</span><span class="p">(</span><span class="n">font</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">BLACK</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">SetFont</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gfont</span><span class="p">)</span>

        <span class="c1"># boundaryFactor = 1</span>
        <span class="c1"># if not self.node.floatingNode:</span>
        <span class="c1">#     boundaryFactor = 2  # Store this in a theme?</span>

        <span class="n">s_aligned_rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">s_rect</span><span class="o">.</span><span class="n">aligned</span><span class="p">()</span>
        <span class="c1"># aligned_border_width = max(even_round(</span>
        <span class="c1">#     self.node.border_width * boundaryFactor), 2)</span>
        <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">s_aligned_rect</span><span class="o">.</span><span class="n">size</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">composite_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">draw_composite_shape</span><span class="p">(</span>
            <span class="n">gc</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">lockNode</span><span class="p">:</span>
            <span class="n">lock_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">border_color</span> <span class="ow">or</span> <span class="n">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">pen</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePen</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">GraphicsPenInfo</span><span class="p">(</span>
                <span class="n">lock_color</span><span class="o">.</span><span class="n">to_wxcolour</span><span class="p">())</span><span class="o">.</span><span class="n">Width</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">SetPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePath</span><span class="p">()</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddCircle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="o">*</span><span class="n">height</span><span class="p">)</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">StrokePath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">floatingNode</span><span class="p">:</span>
            <span class="n">boundary_color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">border_color</span> <span class="ow">or</span> <span class="n">Color</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">pen</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePen</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">GraphicsPenInfo</span><span class="p">(</span>
                <span class="n">boundary_color</span><span class="o">.</span><span class="n">to_wxcolour</span><span class="p">())</span><span class="o">.</span><span class="n">Width</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">SetPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePath</span><span class="p">()</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddRectangle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="o">-</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">border_width</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="o">-</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">border_width</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                              <span class="mi">2</span><span class="o">*</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">border_width</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span>
                              <span class="mi">2</span><span class="o">*</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">border_width</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">StrokePath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="NodeElement.on_left_down"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.NodeElement.on_left_down">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="NodeElement.bounding_rect"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.NodeElement.bounding_rect">[docs]</a>    <span class="k">def</span> <span class="nf">bounding_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Rect</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">rect</span></div></div>


<div class="viewcode-block" id="BezierHandle"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.BezierHandle">[docs]</a><span class="k">class</span> <span class="nc">BezierHandle</span><span class="p">(</span><span class="n">CanvasElement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that keeps track of a Bezier control handle tip.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        HANDLE_RADIUS: radius of the control handle.</span>
<span class="sd">        data: The associated HandleData&gt;</span>
<span class="sd">        on_moved: The function called when the handle is moved.</span>
<span class="sd">        on_dropped: The function called when the handle is dropped (i.e. mouse up).</span>
<span class="sd">        reaction: The associated Reaction.</span>
<span class="sd">        twin: The twin BezierHandle; used only for the center handles.</span>
<span class="sd">        node_idx: The index of the node associated with this handle. -1 if this is a source</span>
<span class="sd">                  centroid handle, and -2 if this is a target centroid handle.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">HANDLE_RADIUS</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># Radius of the control handle</span>

    <span class="n">data</span><span class="p">:</span> <span class="n">HandleData</span>
    <span class="n">on_moved</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Vec2</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">on_dropped</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Vec2</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">reaction</span><span class="p">:</span> <span class="n">Reaction</span>
    <span class="n">twin</span> <span class="o">=</span> <span class="n">Any</span>
    <span class="n">node_idx</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">HandleData</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="n">Layer</span><span class="p">,</span> <span class="n">on_moved</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Vec2</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span>
                 <span class="n">on_dropped</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Vec2</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">reaction</span><span class="p">:</span> <span class="n">Reaction</span><span class="p">,</span> <span class="n">node_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_moved</span> <span class="o">=</span> <span class="n">on_moved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_dropped</span> <span class="o">=</span> <span class="n">on_dropped</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span> <span class="o">=</span> <span class="n">reaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">twin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_idx</span> <span class="o">=</span> <span class="n">node_idx</span>

<div class="viewcode-block" id="BezierHandle.pos_inside"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.BezierHandle.pos_inside">[docs]</a>    <span class="k">def</span> <span class="nf">pos_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">pt_in_circle</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">,</span> <span class="n">BezierHandle</span><span class="o">.</span><span class="n">HANDLE_RADIUS</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tip</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">,</span> <span class="n">handle_color</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">):</span>
        <span class="n">brush</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Brush</span><span class="p">(</span><span class="n">handle_color</span><span class="p">)</span>
        <span class="n">pen</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePen</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">GraphicsPenInfo</span><span class="p">(</span><span class="n">handle_color</span><span class="p">))</span>

        <span class="n">sbase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">base</span>
        <span class="n">stip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tip</span>

        <span class="n">gc</span><span class="o">.</span><span class="n">SetPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>

        <span class="c1"># Draw handle lines</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">StrokeLine</span><span class="p">(</span><span class="o">*</span><span class="n">sbase</span><span class="p">,</span> <span class="o">*</span><span class="n">stip</span><span class="p">)</span>

        <span class="c1"># Draw handle circles</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">SetBrush</span><span class="p">(</span><span class="n">brush</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">DrawEllipse</span><span class="p">(</span><span class="n">stip</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">BezierHandle</span><span class="o">.</span><span class="n">HANDLE_RADIUS</span><span class="p">,</span>
                        <span class="n">stip</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">BezierHandle</span><span class="o">.</span><span class="n">HANDLE_RADIUS</span><span class="p">,</span>
                        <span class="mi">2</span> <span class="o">*</span> <span class="n">BezierHandle</span><span class="o">.</span><span class="n">HANDLE_RADIUS</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">BezierHandle</span><span class="o">.</span><span class="n">HANDLE_RADIUS</span><span class="p">)</span>

<div class="viewcode-block" id="BezierHandle.on_paint"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.BezierHandle.on_paint">[docs]</a>    <span class="k">def</span> <span class="nf">on_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Paint the handle as given by its base and tip positions, highlighting it if hovering.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">bezierCurves</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;handle_color&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span></div>

<div class="viewcode-block" id="BezierHandle.on_paint_cue"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.BezierHandle.on_paint_cue">[docs]</a>    <span class="k">def</span> <span class="nf">on_paint_cue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hovering</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">bezierCurves</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;highlighted_handle_color&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span></div>

<div class="viewcode-block" id="BezierHandle.on_mouse_enter"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.BezierHandle.on_mouse_enter">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">twin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">twin</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BezierHandle.on_mouse_leave"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.BezierHandle.on_mouse_leave">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_leave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">twin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">twin</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BezierHandle.on_left_down"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.BezierHandle.on_left_down">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BezierHandle.on_mouse_drag"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.BezierHandle.on_mouse_drag">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_drag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tip</span> <span class="o">+=</span> <span class="n">rel_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_moved</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tip</span><span class="p">)</span>
        <span class="n">neti</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveBezierHandleEvent</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">node_idx</span><span class="p">,</span> <span class="n">by_user</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="BezierHandle.on_left_up"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.BezierHandle.on_left_up">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_dropped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">tip</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="ReactionCenter"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionCenter">[docs]</a><span class="k">class</span> <span class="nc">ReactionCenter</span><span class="p">(</span><span class="n">CanvasElement</span><span class="p">):</span>
    <span class="n">parent</span><span class="p">:</span> <span class="s1">&#39;ReactionElement&#39;</span>
    <span class="n">_moved</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="s1">&#39;ReactionElement&#39;</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Layer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">):</span>
        <span class="n">pen</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Pen</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="n">brush</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Brush</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">SetPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">SetBrush</span><span class="p">(</span><span class="n">brush</span><span class="p">)</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;reaction_radius&#39;</span><span class="p">)</span>
        <span class="n">center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">real_center</span> <span class="o">-</span> <span class="n">Vec2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">DrawEllipse</span><span class="p">(</span><span class="n">center</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">radius</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">radius</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="ReactionCenter.on_paint"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionCenter.on_paint">[docs]</a>    <span class="k">def</span> <span class="nf">on_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># draw centroid</span>
        <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">fill_color</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">selected</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;handle_color&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReactionCenter.on_paint_cue"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionCenter.on_paint_cue">[docs]</a>    <span class="k">def</span> <span class="nf">on_paint_cue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">selected</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">hovering</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;highlighted_handle_color&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReactionCenter.on_left_down"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionCenter.on_left_down">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># If not selected, then nothing is done to prevent accidental dragging</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ReactionCenter.on_mouse_drag"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionCenter.on_mouse_drag">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_drag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">rel_pos</span>
        <span class="n">reaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">reaction</span>
        <span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">real_center</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">center_moved</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">net_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveReactionCenterEvent</span><span class="p">(</span><span class="n">net_index</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ReactionCenter.on_left_up"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionCenter.on_left_up">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">ctrl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">controller</span>
        <span class="n">neti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">net_index</span>
        <span class="n">reai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span>
        <span class="k">with</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="n">ctrl</span><span class="o">.</span><span class="n">set_reaction_center</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span><span class="p">)</span>
            <span class="n">ctrl</span><span class="o">.</span><span class="n">set_center_handle</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">src_c_handle</span><span class="o">.</span><span class="n">tip</span><span class="p">)</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidCommitDragEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ReactionCenter.pos_inside"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionCenter.pos_inside">[docs]</a>    <span class="k">def</span> <span class="nf">pos_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># TODO works witih zoom?</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;reaction_radius&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pt_in_circle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">real_center</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReactionCenter.on_mouse_enter"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionCenter.on_mouse_enter">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ReactionCenter.on_mouse_leave"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionCenter.on_mouse_leave">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_leave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hovering</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ReactionCenter.bounding_rect"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionCenter.bounding_rect">[docs]</a>    <span class="k">def</span> <span class="nf">bounding_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Rect</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;reaction_radius&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Rect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">real_center</span> <span class="o">-</span> <span class="n">radius</span><span class="p">,</span> <span class="n">Vec2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span></div></div>


<span class="c1"># Uniquely identifies nodes in a reaction: (regular node index; whether the node is a reactant)</span>
<span class="n">RIndex</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>


<div class="viewcode-block" id="ReactionElement"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionElement">[docs]</a><span class="k">class</span> <span class="nc">ReactionElement</span><span class="p">(</span><span class="n">CanvasElement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;CanvasElement for reactions.</span>

<span class="sd">    Note that if new nodes are constructed, all ReactionBezier instances that use these nodes should</span>
<span class="sd">    be re-constructed with the new nodes. On the other hand, if the nodes are merely modified, the</span>
<span class="sd">    corresponding update methods should be called.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reaction</span><span class="p">:</span> <span class="n">Reaction</span>
    <span class="n">center_el</span><span class="p">:</span> <span class="n">ReactionCenter</span>
    <span class="n">index_to_bz</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">RIndex</span><span class="p">,</span> <span class="n">SpeciesBezier</span><span class="p">]</span>
    <span class="n">bezier</span><span class="p">:</span> <span class="n">ReactionBezier</span>
    <span class="n">bhandles</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">BezierHandle</span><span class="p">]</span>
    <span class="n">moved_handler_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="c1">#: Set of indices of the nodes that have been moved, but not committed.</span>
    <span class="n">_dirty_node_indices</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="c1">#: Works in tandem with _dirty_indices. True if all nodes of the reaction are being moved.</span>
    <span class="n">_moving_all</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">_selected</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">canvas</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># avoid circular dependency</span>
    <span class="n">controller</span><span class="p">:</span> <span class="n">IController</span>

    <span class="c1"># HACK no type for canvas since otherwise there is circular dependency</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction</span><span class="p">:</span> <span class="n">Reaction</span><span class="p">,</span> <span class="n">bezier</span><span class="p">:</span> <span class="n">ReactionBezier</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">Layer</span><span class="p">,</span>
                 <span class="n">handle_layer</span><span class="p">:</span> <span class="n">Layer</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span> <span class="o">=</span> <span class="n">reaction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">containing_node_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">reaction</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">targets</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bezier</span> <span class="o">=</span> <span class="n">bezier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">moved_handler_id</span> <span class="o">=</span> <span class="n">bind_handler</span><span class="p">(</span><span class="n">DidMoveNodesEvent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_moved</span><span class="p">)</span>
        <span class="c1"># i is 0 for source Beziers, but 1 for dest Beziers. &quot;not&quot; it to get the correct bool.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index_to_bz</span> <span class="o">=</span> <span class="p">{(</span><span class="n">bz</span><span class="o">.</span><span class="n">node_idx</span><span class="p">,</span> <span class="ow">not</span> <span class="n">gi</span><span class="p">):</span> <span class="n">bz</span>
                            <span class="k">for</span> <span class="n">gi</span><span class="p">,</span> <span class="n">bz</span> <span class="ow">in</span> <span class="n">gchain</span><span class="p">(</span><span class="n">bezier</span><span class="o">.</span><span class="n">src_beziers</span><span class="p">,</span>
                                                 <span class="n">bezier</span><span class="o">.</span><span class="n">dest_beziers</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_handle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_moving_all</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bhandles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">neti</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">net_index</span>
        <span class="n">reai</span> <span class="o">=</span> <span class="n">reaction</span><span class="o">.</span><span class="n">index</span>
        <span class="n">ctrl</span> <span class="o">=</span> <span class="n">canvas</span><span class="o">.</span><span class="n">controller</span>
        <span class="c1"># create elements for species</span>
        <span class="k">for</span> <span class="n">gi</span><span class="p">,</span> <span class="n">sb</span> <span class="ow">in</span> <span class="n">gchain</span><span class="p">(</span><span class="n">bezier</span><span class="o">.</span><span class="n">src_beziers</span><span class="p">,</span> <span class="n">bezier</span><span class="o">.</span><span class="n">dest_beziers</span><span class="p">):</span>
            <span class="n">dropped_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_drop_handle_func</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">neti</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">sb</span><span class="o">.</span><span class="n">node_idx</span><span class="p">,</span> <span class="ow">not</span> <span class="n">gi</span><span class="p">)</span>
            <span class="n">el</span> <span class="o">=</span> <span class="n">BezierHandle</span><span class="p">(</span><span class="n">sb</span><span class="o">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">handle_layer</span><span class="p">,</span>
                              <span class="n">bezier</span><span class="o">.</span><span class="n">make_handle_moved_func</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">dropped_func</span><span class="p">,</span> <span class="n">reaction</span><span class="p">,</span> <span class="n">sb</span><span class="o">.</span><span class="n">node_idx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bhandles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">centroid_handle_dropped</span><span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">ctrl</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">set_center_handle</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">reaction</span><span class="o">.</span><span class="n">src_c_handle</span><span class="o">.</span><span class="n">tip</span><span class="p">)</span>
                <span class="c1"># NOTE important to do this within the group action</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidCommitDragEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

        <span class="n">src_bh</span> <span class="o">=</span> <span class="n">BezierHandle</span><span class="p">(</span><span class="n">reaction</span><span class="o">.</span><span class="n">src_c_handle</span><span class="p">,</span> <span class="n">handle_layer</span><span class="p">,</span>
                              <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">bezier</span><span class="o">.</span><span class="n">src_handle_moved</span><span class="p">(),</span>
                              <span class="n">centroid_handle_dropped</span><span class="p">,</span> <span class="n">reaction</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dest_bh</span> <span class="o">=</span> <span class="n">BezierHandle</span><span class="p">(</span><span class="n">reaction</span><span class="o">.</span><span class="n">dest_c_handle</span><span class="p">,</span> <span class="n">handle_layer</span><span class="p">,</span>
                               <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="n">bezier</span><span class="o">.</span><span class="n">dest_handle_moved</span><span class="p">(),</span>
                               <span class="n">centroid_handle_dropped</span><span class="p">,</span> <span class="n">reaction</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">src_bh</span><span class="o">.</span><span class="n">twin</span> <span class="o">=</span> <span class="n">dest_bh</span>
        <span class="n">dest_bh</span><span class="o">.</span><span class="n">twin</span> <span class="o">=</span> <span class="n">src_bh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bhandles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">src_bh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bhandles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dest_bh</span><span class="p">)</span>
        <span class="n">center_layers</span> <span class="o">=</span> <span class="n">layer_above</span><span class="p">(</span><span class="n">layers</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_el</span> <span class="o">=</span> <span class="n">ReactionCenter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center_layers</span><span class="p">)</span>

<div class="viewcode-block" id="ReactionElement.make_drop_handle_func"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionElement.make_drop_handle_func">[docs]</a>    <span class="k">def</span> <span class="nf">make_drop_handle_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">:</span> <span class="n">IController</span><span class="p">,</span> <span class="n">neti</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reai</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nodei</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                              <span class="n">is_source</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_source</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">ret</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">set_src_node_handle</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidCommitDragEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ret</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Avoid IDE warnings</span>
            <span class="k">def</span> <span class="nf">ret1</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">set_dest_node_handle</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">nodei</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidCommitDragEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">ret1</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selected</span>

    <span class="nd">@selected</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">selected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="c1"># Enable/disable Handles based on whether the curve is selected</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">for</span> <span class="n">bz</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bhandles</span><span class="p">:</span>
            <span class="n">bz</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center_el</span><span class="o">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">val</span>

<div class="viewcode-block" id="ReactionElement.nodes_moved"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionElement.nodes_moved">[docs]</a>    <span class="k">def</span> <span class="nf">nodes_moved</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">:</span> <span class="n">CanvasEvent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handler for after a node has moved.&quot;&quot;&quot;</span>
        <span class="c1"># If already moving (i.e. self._dirty_indices is not empty), then skip forward</span>
        <span class="n">c_evt</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">DidMoveNodesEvent</span><span class="p">,</span> <span class="n">evt</span><span class="p">)</span>
        <span class="n">node_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c_evt</span><span class="o">.</span><span class="n">node_indices</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">containing_node_indices</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node_indices</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">c_evt</span><span class="o">.</span><span class="n">offset</span>
        <span class="n">rects</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">node_idx_map</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">rect</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">targets</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">nodes_moved</span><span class="p">(</span><span class="n">rects</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dirty_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_indices</span> <span class="o">=</span> <span class="n">node_indices</span>
            <span class="n">my_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">targets</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_moving_all</span> <span class="o">=</span> <span class="n">my_indices</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_indices</span>

        <span class="n">neti</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node_indices</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">in_src</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">in_src</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_bz</span><span class="p">:</span>
                    <span class="n">bz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_to_bz</span><span class="p">[(</span><span class="n">idx</span><span class="p">,</span> <span class="n">in_src</span><span class="p">)]</span>
                    <span class="n">off</span> <span class="o">=</span> <span class="n">offset</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">)</span> <span class="k">else</span> <span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">bz</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">tip</span> <span class="o">+=</span> <span class="n">off</span>
                    <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveBezierHandleEvent</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">bz</span><span class="o">.</span><span class="n">node_idx</span><span class="p">,</span>
                                                        <span class="n">by_user</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                    <span class="n">bz</span><span class="o">.</span><span class="n">update_curve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">real_center</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moving_all</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">Vec2</span><span class="p">):</span>
            <span class="c1"># Only move src_handle_tip if moving all nodes and they are moved by the same amount.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">src_c_handle</span><span class="o">.</span><span class="n">tip</span> <span class="o">+=</span> <span class="n">offset</span>
            <span class="c1"># move center pos as well if it is not auto-set as the centroid</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span> <span class="o">+=</span> <span class="n">offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">src_handle_moved</span><span class="p">()</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveBezierHandleEvent</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">by_user</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">direct</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span></div>

<div class="viewcode-block" id="ReactionElement.commit_node_pos"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionElement.commit_node_pos">[docs]</a>    <span class="k">def</span> <span class="nf">commit_node_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handler for after the controller is told to move a node.&quot;&quot;&quot;</span>
        <span class="n">ctrl</span><span class="p">:</span> <span class="n">IController</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">controller</span>
        <span class="n">neti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">net_index</span>
        <span class="n">reai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">index</span>
        <span class="k">for</span> <span class="n">bz</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">src_beziers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bz</span><span class="o">.</span><span class="n">node_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_indices</span><span class="p">:</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">set_src_node_handle</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">bz</span><span class="o">.</span><span class="n">node_idx</span><span class="p">,</span> <span class="n">bz</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">tip</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">bz</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">dest_beziers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bz</span><span class="o">.</span><span class="n">node_idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_indices</span><span class="p">:</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">set_dest_node_handle</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="n">bz</span><span class="o">.</span><span class="n">node_idx</span><span class="p">,</span> <span class="n">bz</span><span class="o">.</span><span class="n">handle</span><span class="o">.</span><span class="n">tip</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_moving_all</span><span class="p">:</span>
            <span class="n">ctrl</span><span class="o">.</span><span class="n">set_center_handle</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">src_c_handle</span><span class="o">.</span><span class="n">tip</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span><span class="p">:</span>
                <span class="n">ctrl</span><span class="o">.</span><span class="n">set_reaction_center</span><span class="p">(</span><span class="n">neti</span><span class="p">,</span> <span class="n">reai</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">center_pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dirty_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></div>

<div class="viewcode-block" id="ReactionElement.destroy"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionElement.destroy">[docs]</a>    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">unbind_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">moved_handler_id</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span></div>

<div class="viewcode-block" id="ReactionElement.pos_inside"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionElement.pos_inside">[docs]</a>    <span class="k">def</span> <span class="nf">pos_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">is_mouse_on</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReactionElement.on_mouse_enter"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionElement.on_mouse_enter">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_mouse_move</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReactionElement.on_left_down"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionElement.on_left_down">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Return True so that this can be selected</span></div>

<div class="viewcode-block" id="ReactionElement.on_paint"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionElement.on_paint">[docs]</a>    <span class="k">def</span> <span class="nf">on_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">do_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">fill_color</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected</span><span class="p">)</span>

        <span class="n">MOD_NODE_PAD</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">RXN_PAD</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">MODIFIER_RADIUS</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">TEE_LENGTH</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="n">line_width</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;modifier_line_width&#39;</span><span class="p">)</span>
        <span class="n">pen</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePen</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">GraphicsPenInfo</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;modifier_line_color&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">Width</span><span class="p">(</span><span class="n">line_width</span><span class="p">))</span>
        <span class="n">brush</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreateBrush</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Brush</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;modifier_line_color&#39;</span><span class="p">)))</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">SetPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">SetBrush</span><span class="p">(</span><span class="n">brush</span><span class="p">)</span>
        <span class="c1"># Draw modifier lines</span>
        <span class="k">for</span> <span class="n">modifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">modifiers</span><span class="p">:</span>
            <span class="n">mod_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">node_idx_map</span><span class="p">[</span><span class="n">modifier</span><span class="p">]</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">mod_node</span><span class="o">.</span><span class="n">rect</span>
            <span class="n">clipping_rect</span> <span class="o">=</span> <span class="n">padded_rect</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">MOD_NODE_PAD</span><span class="p">)</span>

            <span class="n">node_center</span> <span class="o">=</span> <span class="n">rect</span><span class="o">.</span><span class="n">center_point</span>
            <span class="n">rxn_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">real_center</span>

            <span class="c1"># If too close, don&#39;t draw. Pad rectangle and circle with 1 to avoid floating point</span>
            <span class="c1"># shenanigans</span>
            <span class="k">if</span> <span class="n">pt_in_rect</span><span class="p">(</span><span class="n">rxn_center</span><span class="p">,</span> <span class="n">padded_rect</span><span class="p">(</span><span class="n">clipping_rect</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">pt_in_circle</span><span class="p">(</span><span class="n">node_center</span><span class="p">,</span> <span class="n">RXN_PAD</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rxn_center</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># create segment</span>
            <span class="n">segment</span> <span class="o">=</span> <span class="p">(</span><span class="n">node_center</span><span class="p">,</span> <span class="n">rxn_center</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">node_center</span> <span class="o">-</span> <span class="n">rxn_center</span>
            <span class="n">rxn_intersection</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxn_center</span> <span class="o">+</span> <span class="n">diff</span><span class="o">.</span><span class="n">normalized</span><span class="p">(</span><span class="n">RXN_PAD</span><span class="p">))</span>
            <span class="n">node_intersection</span> <span class="o">=</span> <span class="n">segment_rect_intersection</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">clipping_rect</span><span class="p">)</span>

            <span class="c1"># gc.StrokeLine(*node_intersection, *rxn_intersection)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePath</span><span class="p">()</span>
            <span class="n">path</span><span class="o">.</span><span class="n">MoveToPoint</span><span class="p">(</span><span class="o">*</span><span class="n">node_intersection</span><span class="p">)</span>
            <span class="n">path</span><span class="o">.</span><span class="n">AddLineToPoint</span><span class="p">(</span><span class="o">*</span><span class="n">rxn_intersection</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">modifier_tip_style</span> <span class="o">==</span> <span class="n">ModifierTipStyle</span><span class="o">.</span><span class="n">CIRCLE</span><span class="p">:</span>
                <span class="n">path</span><span class="o">.</span><span class="n">AddCircle</span><span class="p">(</span><span class="o">*</span><span class="n">rxn_intersection</span><span class="p">,</span> <span class="n">MODIFIER_RADIUS</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction</span><span class="o">.</span><span class="n">modifier_tip_style</span> <span class="o">==</span> <span class="n">ModifierTipStyle</span><span class="o">.</span><span class="n">TEE</span><span class="p">:</span>
                <span class="c1"># draw T-shaped tip</span>
                <span class="n">ortho</span> <span class="o">=</span> <span class="n">rotate_unit</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">pt1</span> <span class="o">=</span> <span class="n">rxn_intersection</span> <span class="o">+</span> <span class="n">ortho</span> <span class="o">*</span> <span class="n">TEE_LENGTH</span>
                <span class="n">pt2</span> <span class="o">=</span> <span class="n">rxn_intersection</span> <span class="o">-</span> <span class="n">ortho</span> <span class="o">*</span> <span class="n">TEE_LENGTH</span>
                <span class="n">path</span><span class="o">.</span><span class="n">MoveToPoint</span><span class="p">(</span><span class="o">*</span><span class="n">pt1</span><span class="p">)</span>
                <span class="n">path</span><span class="o">.</span><span class="n">AddLineToPoint</span><span class="p">(</span><span class="o">*</span><span class="n">pt2</span><span class="p">)</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">StrokePath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">gc</span><span class="o">.</span><span class="n">FillPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>
            <span class="c1"># path.MoveToPoint(0.0, 50.0)</span>

<div class="viewcode-block" id="ReactionElement.bounding_rect"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.ReactionElement.bounding_rect">[docs]</a>    <span class="k">def</span> <span class="nf">bounding_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Rect</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">bezier</span><span class="o">.</span><span class="n">get_bounding_rect</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="CompartmentElt"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CompartmentElt">[docs]</a><span class="k">class</span> <span class="nc">CompartmentElt</span><span class="p">(</span><span class="n">CanvasElement</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compartment</span><span class="p">:</span> <span class="n">Compartment</span><span class="p">,</span> <span class="n">major_layer</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">minor_layer</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">((</span><span class="n">major_layer</span><span class="p">,</span> <span class="n">minor_layer</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartment</span> <span class="o">=</span> <span class="n">compartment</span>

<div class="viewcode-block" id="CompartmentElt.pos_inside"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CompartmentElt.pos_inside">[docs]</a>    <span class="k">def</span> <span class="nf">pos_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">thickness</span> <span class="o">=</span>  <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">border_width</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pt_on_rect_sides</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="n">thickness</span><span class="p">)</span></div>

<div class="viewcode-block" id="CompartmentElt.on_left_down"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CompartmentElt.on_left_down">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">,</span> <span class="n">highlight</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">position</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">highlight</span><span class="p">:</span>
            <span class="n">border</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Colour</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">border</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">border</span>
            <span class="n">fill</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">fill</span>
        <span class="n">draw_rect</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">rect</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="n">border</span><span class="p">,</span>
                  <span class="n">border_width</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">border_width</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">fill</span><span class="p">,</span>
                  <span class="n">corner_radius</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;comp_corner_radius&#39;</span><span class="p">))</span>

<div class="viewcode-block" id="CompartmentElt.on_paint"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CompartmentElt.on_paint">[docs]</a>    <span class="k">def</span> <span class="nf">on_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="CompartmentElt.highlight_paint"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CompartmentElt.highlight_paint">[docs]</a>    <span class="k">def</span> <span class="nf">highlight_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_paint</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="CompartmentElt.bounding_rect"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.CompartmentElt.bounding_rect">[docs]</a>    <span class="k">def</span> <span class="nf">bounding_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Rect</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartment</span><span class="o">.</span><span class="n">rect</span></div></div>


<div class="viewcode-block" id="SelectBox"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox">[docs]</a><span class="k">class</span> <span class="nc">SelectBox</span><span class="p">(</span><span class="n">CanvasElement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that represents a select box, i.e. the bounding box draw around the selected nodes.</span>

<span class="sd">    Supports moving and resizing operations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        CURSOR_TYPES: List of cursor types starting with that for the top-left handle and going</span>
<span class="sd">                      clockwise.</span>
<span class="sd">        nodes: List of selected nodes, as contained in this select box.</span>
<span class="sd">        related_elts: List of NodeElements related to each node instance; matches the node list</span>
<span class="sd">                      1-1.</span>
<span class="sd">        bounding_rect: The exact bounding rectangle (without padding).</span>
<span class="sd">        mode: Current input mode of the SelectBox.</span>

<span class="sd">    Note:</span>
<span class="sd">        The behavior of the SelectBox depends on the nodes and compartments selected, but not the</span>
<span class="sd">        reactions. The cases of behaviors are documented here:</span>

<span class="sd">        1) Only compartments are selected. Nodes within these compartments are dragged along with</span>
<span class="sd">           them, but they are not resized.</span>
<span class="sd">        3) Only nodes are selected, and they are all in the same compartment. In this case, the</span>
<span class="sd">           nodes may be moved normally. They also may be moved outside of their compartment to be</span>
<span class="sd">           assigned to another compartment (this is the only case where this is possible). However</span>
<span class="sd">           note that the nodes may not be resized to be larger than the containing compartment.</span>
<span class="sd">        3) Otherwise, there are two cases depending on if the selected nodes are in the union of</span>
<span class="sd">           the selected compartments.</span>
<span class="sd">            a) If the selected nodes are entirely contained in the list of selected compartments,</span>
<span class="sd">               then everything is moved and resized together, as usual.</span>
<span class="sd">            b) Otherwise (i.e. some node is not in any selected compartment), then dragging and</span>
<span class="sd">               resizing are disabled.</span>
<span class="sd">        Note that in case 2), if all selected nodes are in the base compartment (i.e. no</span>
<span class="sd">        compartment), then the base compartment is assumed to be selected, and resizing and moving</span>
<span class="sd">        work as usual.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CURSOR_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_SIZENWSE</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_SIZENS</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_SIZENESW</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_SIZEWE</span><span class="p">,</span>
                    <span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_SIZENWSE</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_SIZENS</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_SIZENESW</span><span class="p">,</span> <span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_SIZEWE</span><span class="p">]</span>
    <span class="n">HANDLE_MULT</span> <span class="o">=</span> <span class="p">[</span><span class="n">Vec2</span><span class="p">(),</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                   <span class="n">Vec2</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)]</span>

    <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]</span>
    <span class="n">node_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">compartments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Compartment</span><span class="p">]</span>
    <span class="n">comp_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="c1"># List of nodes that are not selected, but are within selected compartments. Used only</span>
    <span class="c1"># for SMode.CONTAINED</span>
    <span class="n">peripheral_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]</span>
    <span class="n">related_elts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CanvasElement</span><span class="p">]</span>
    <span class="n">bounding_rect</span><span class="p">:</span> <span class="n">Rect</span>
    <span class="n">_padding</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1">#: padding for the bounding rectangle around the selected nodes</span>
    <span class="n">_drag_rel</span><span class="p">:</span> <span class="n">Vec2</span>  <span class="c1">#: relative position of the mouse to the bounding rect when dragging started</span>
    <span class="c1">#: whether the node was drag-moved between left_down and left_up.</span>
    <span class="n">_did_move</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">_orig_rpos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Vec2</span><span class="p">]</span>  <span class="c1">#: relative positions of the comps and nodes to the select box</span>
    <span class="n">_orig_rsize</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Vec2</span><span class="p">]</span>  <span class="c1">#: sizes of the comps and nodes to the select box</span>
    <span class="c1">#: relative positions of the compartments and nodes to cursor; updated when dragging starts</span>
    <span class="n">_rel_positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Vec2</span><span class="p">]</span>
    <span class="n">_resize_handle</span><span class="p">:</span> <span class="nb">int</span>  <span class="c1">#: the node resize handle.</span>
    <span class="n">node_min_ratio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Vec2</span><span class="p">]</span>
    <span class="n">comp_min_ratio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Vec2</span><span class="p">]</span>
    <span class="c1">#: the minimum resize ratio for each axis, to avoid making the nodes too small</span>
    <span class="n">_min_resize_ratio</span><span class="p">:</span> <span class="n">Vec2</span>
    <span class="c1">#: the bounding rect when dragging/resizing started</span>
    <span class="n">_orig_rect</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Rect</span><span class="p">]</span>
    <span class="n">_bounds</span><span class="p">:</span> <span class="n">Rect</span>  <span class="c1">#: the bounds that the bounding rect may not exceed</span>
    <span class="n">special_mode</span><span class="p">:</span> <span class="s1">&#39;SelectBox.SMode&#39;</span>

<div class="viewcode-block" id="SelectBox.Mode"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.Mode">[docs]</a>    <span class="k">class</span> <span class="nc">Mode</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
        <span class="n">IDLE</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">MOVING</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">RESIZING</span> <span class="o">=</span> <span class="mi">2</span></div>

<div class="viewcode-block" id="SelectBox.SMode"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.SMode">[docs]</a>    <span class="k">class</span> <span class="nc">SMode</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For what this does, see &quot;Notes&quot; section of the class documentation.&quot;&quot;&quot;</span>

        <span class="n">COMP_ONLY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="sd">&quot;&quot;&quot;Only compartments are selected.&quot;&quot;&quot;</span>
        <span class="n">NODES_IN_ONE</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="sd">&quot;&quot;&quot;Only nodes are selected, and they are in a single compartment.&quot;&quot;&quot;</span>
        <span class="n">CONTAINED</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="sd">&quot;&quot;&quot;Nodes are entirely contained in the selected compartments, or they are all in the base</span>
<span class="sd">        compartment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">NOT_CONTAINED</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="sd">&quot;&quot;&quot;Nodes are not entirely contained in the selected compartments.&quot;&quot;&quot;</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">canvas</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">],</span> <span class="n">compartments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Compartment</span><span class="p">],</span> <span class="n">bounds</span><span class="p">:</span> <span class="n">Rect</span><span class="p">,</span>
                 <span class="n">controller</span><span class="p">:</span> <span class="n">IController</span><span class="p">,</span> <span class="n">net_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">layer</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peripheral_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">compartments</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span> <span class="o">=</span> <span class="n">controller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net_index</span> <span class="o">=</span> <span class="n">net_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">IDLE</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rel</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_did_move</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rpos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rsizes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rel_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rect</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_min_resize_ratio</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_part</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span> <span class="o">=</span> <span class="n">bounds</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>

<div class="viewcode-block" id="SelectBox.update"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.update">[docs]</a>    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">],</span> <span class="n">compartments</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Compartment</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span> <span class="o">=</span> <span class="n">compartments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comp_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">compartments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">compartments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># If only one node is selected, reduce padding</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_padding</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;select_outline_padding&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_padding</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;select_box_padding&#39;</span><span class="p">)</span>
            <span class="c1"># Align bounding box if only one node is selected, see NodeElement::on_paint for</span>
            <span class="c1"># explanations. Note that self._padding should be an integer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_padding</span> <span class="o">=</span> <span class="n">int_round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_padding</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bounding_rect</span> <span class="o">=</span> <span class="n">get_bounding_rect</span><span class="p">(</span>
                <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">rect</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">rect</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">])</span>

        <span class="n">selected_comps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">)</span> <span class="o">|</span> <span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span>
        <span class="c1"># Determine SMode</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">special_mode</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">SMode</span><span class="o">.</span><span class="n">COMP_ONLY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">assoc_comps</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="o">.</span><span class="n">comp_idx</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">compartments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">assoc_comps</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Nodes are in one compartment</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">special_mode</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">SMode</span><span class="o">.</span><span class="n">NODES_IN_ONE</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Cannot possibly contain</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">special_mode</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">SMode</span><span class="o">.</span><span class="n">NOT_CONTAINED</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">selected_comps</span> <span class="o">&gt;=</span> <span class="n">assoc_comps</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">special_mode</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">SMode</span><span class="o">.</span><span class="n">CONTAINED</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">special_mode</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">SMode</span><span class="o">.</span><span class="n">NOT_CONTAINED</span>

        <span class="c1"># Compute peripheral nodes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_mode</span> <span class="o">==</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">SMode</span><span class="o">.</span><span class="n">NOT_CONTAINED</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peripheral_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peri_indices</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">compartments</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span> <span class="ow">in</span> <span class="n">selected_comps</span><span class="p">:</span>
                    <span class="n">peri_indices</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>

            <span class="n">peri_indices</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peripheral_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">node_idx_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">peri_indices</span><span class="p">]</span></div>

<div class="viewcode-block" id="SelectBox.outline_rect"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.outline_rect">[docs]</a>    <span class="k">def</span> <span class="nf">outline_rect</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Rect</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper that returns the scaled, padded bounding rectangle.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">padded_rect</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bounding_rect</span><span class="p">)</span><span class="o">.</span><span class="n">aligned</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_padding</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_resize_handle_rects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper that computes the scaled positions and sizes of the resize handles.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of (pos, size) tuples representing the resize handle</span>
<span class="sd">            rectangles. They are ordered such that the top-left handle is the first element, and</span>
<span class="sd">            all other handles follow in clockwise fashion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">outline_rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline_rect</span><span class="p">()</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">outline_rect</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                   <span class="n">pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">size</span><span class="o">.</span><span class="n">y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                   <span class="n">pos</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">size</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">.</span><span class="n">y</span><span class="p">),</span>
                   <span class="n">pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">.</span><span class="n">y</span><span class="p">),</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">.</span><span class="n">y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">size</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">HANDLE_MULT</span><span class="p">]</span>
        <span class="n">side</span> <span class="o">=</span> <span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;select_handle_length&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">Rect</span><span class="p">(</span><span class="n">c</span> <span class="o">-</span> <span class="n">Vec2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">side</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">Vec2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">side</span><span class="p">))</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">centers</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_resize_handle_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">pos</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline_rect</span><span class="p">()</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">8</span>
        <span class="k">return</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">size</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">SelectBox</span><span class="o">.</span><span class="n">HANDLE_MULT</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_pos_inside_part</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Helper for determining if logical_pos is within which, if any, part of this widget.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The handle index (0-3) if pos is within a handle, -1 if pos is not within a handle</span>
<span class="sd">            but within a node or on the compartment edge, or -2 if pos is outside.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">2</span>

        <span class="n">rects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle_rects</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rect</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rects</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pt_in_rect</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">,</span> <span class="n">rect</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">i</span>

        <span class="n">nrects</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">rect</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
        <span class="n">crects</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">rect</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">pt_in_rect</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">nrects</span><span class="p">)</span> \
            <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">pt_on_rect_sides</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">crects</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">2</span>

<div class="viewcode-block" id="SelectBox.pos_inside"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.pos_inside">[docs]</a>    <span class="k">def</span> <span class="nf">pos_inside</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_inside_part</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">2</span></div>

<div class="viewcode-block" id="SelectBox.on_mouse_enter"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.on_mouse_enter">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_enter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on_mouse_move</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span></div>

<div class="viewcode-block" id="SelectBox.on_mouse_move"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.on_mouse_move">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">!=</span> <span class="n">InputMode</span><span class="o">.</span><span class="n">SELECT</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># clearly, don&#39;t change the cursor if we&#39;re not in select mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_inside_part</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_part</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">CURSOR_TYPES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_hovered_part</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Cursor</span><span class="p">(</span><span class="n">cursor</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_part</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">SetCursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Cursor</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">CURSOR_SIZING</span><span class="p">))</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SelectBox.on_mouse_leave"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.on_mouse_leave">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_leave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_part</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="c1"># HACK re-set input_mode with the same value to make canvas update the cursor</span>
        <span class="c1"># See issue #9 for details</span>
        <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span> <span class="o">=</span> <span class="n">cstate</span><span class="o">.</span><span class="n">input_mode</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SelectBox.on_paint"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.on_paint">[docs]</a>    <span class="k">def</span> <span class="nf">on_paint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outline_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">even_round</span><span class="p">(</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;select_outline_width&#39;</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">pos</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline_rect</span><span class="p">()</span><span class="o">.</span><span class="n">as_tuple</span><span class="p">()</span>

            <span class="c1"># draw main outline</span>
            <span class="n">draw_rect</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">Rect</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">border</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;handle_color&#39;</span><span class="p">),</span>
                      <span class="n">border_width</span><span class="o">=</span><span class="n">outline_width</span><span class="p">,</span> <span class="n">corner_radius</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">handle_rect</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle_rects</span><span class="p">():</span>
                <span class="c1"># convert to device position for drawing</span>
                <span class="n">draw_rect</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">handle_rect</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">get_theme</span><span class="p">(</span><span class="s1">&#39;handle_color&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="SelectBox.map_rel_pos"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.map_rel_pos">[docs]</a>    <span class="k">def</span> <span class="nf">map_rel_pos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Vec2</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Vec2</span><span class="p">]:</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">Vec2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_padding</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">temp</span></div>

<div class="viewcode-block" id="SelectBox.on_left_down"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.on_left_down">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># if multi-selecting and clicked on a node/reaction, then the user must mean to de-select</span>
        <span class="c1"># that element. In this exceptional case we return False so that canvas can continue the</span>
        <span class="c1"># pos_inside loop and find the node/reaction in question later.</span>
        <span class="k">if</span> <span class="n">cstate</span><span class="o">.</span><span class="n">multi_select</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">related_elts</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">elt</span><span class="o">.</span><span class="n">pos_inside</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># make sure that user can select items inside compartment, even if the compartment is</span>
            <span class="c1"># itself selected.</span>
            <span class="c1"># for elt in self.related_elts:</span>
            <span class="c1">#     if elt.pos_inside(logical_pos):</span>
            <span class="c1">#         if isinstance(elt, ReactionElement):</span>
            <span class="c1">#             return False</span>
            <span class="c1">#         elif isinstance(elt, NodeElement) and elt.node.comp_idx != -1:</span>
            <span class="c1">#             return False</span>
            <span class="c1">#         else:</span>
            <span class="c1">#             break</span>
            <span class="k">pass</span>

        <span class="n">handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_part</span>
        <span class="c1"># assert self._mode == SelectBox.Mode.IDLE</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">RESIZING</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle</span> <span class="o">=</span> <span class="n">handle</span>
            <span class="c1"># calculate minimum resize ratio, enforcing min size constraints on nodes and comps</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_min_resize_ratio</span><span class="p">()</span>

            <span class="c1">#self._orig_rect = self.outline_rect()</span>
            <span class="c1"># Take unaligned bounding rect as orig_rect for better accuracy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rect</span> <span class="o">=</span> <span class="n">padded_rect</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bounding_rect</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_padding</span><span class="p">)</span>
            <span class="c1"># relative starting positions to the select box</span>
            <span class="n">orig_node_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rel_pos</span><span class="p">((</span><span class="n">n</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
            <span class="n">orig_comp_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_rel_pos</span><span class="p">((</span><span class="n">c</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">))</span>
            <span class="n">orig_node_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">]</span>
            <span class="n">orig_comp_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rpos</span> <span class="o">=</span> <span class="n">orig_comp_pos</span> <span class="o">+</span> <span class="n">orig_node_pos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rsizes</span> <span class="o">=</span> <span class="n">orig_comp_sizes</span> <span class="o">+</span> <span class="n">orig_node_sizes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle_pos</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span> <span class="o">-</span> <span class="n">logical_pos</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">handle</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">MOVING</span>
            <span class="c1"># relative starting positions to the mouse positions</span>
            <span class="n">rel_node_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span>
                            <span class="n">logical_pos</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">lockNode</span><span class="p">]</span>
            <span class="n">rel_comp_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">logical_pos</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rel_positions</span> <span class="o">=</span> <span class="n">rel_comp_pos</span> <span class="o">+</span> <span class="n">rel_node_pos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">logical_pos</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SelectBox.compute_min_ratio"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.compute_min_ratio">[docs]</a>    <span class="k">def</span> <span class="nf">compute_min_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Vec2</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Vec2</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Compute minimum size ratio resizing nodes and compartments.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing (node mininum resize ratio, comp minimum resize ratio). Each ratio</span>
<span class="sd">            may be None, in the case that no elements of that type is selected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node_min_ratio</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">comp_min_ratio</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
            <span class="n">min_height</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
            <span class="n">node_min_ratio</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;min_node_width&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">min_width</span><span class="p">,</span>
                                  <span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;min_node_height&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">min_height</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">min_comp_width</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span>
            <span class="n">min_comp_height</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span>
            <span class="n">comp_min_ratio</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;min_comp_width&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">min_comp_width</span><span class="p">,</span>
                                  <span class="n">get_setting</span><span class="p">(</span><span class="s1">&#39;min_comp_height&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">min_comp_height</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peripheral_nodes</span><span class="p">:</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">comp_idx_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">comp_idx</span><span class="p">]</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">elem_div</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">comp_min_ratio</span> <span class="o">=</span> <span class="n">comp_min_ratio</span><span class="o">.</span><span class="n">reduce2</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">node_min_ratio</span><span class="p">,</span> <span class="n">comp_min_ratio</span></div>

    <span class="k">def</span> <span class="nf">_update_min_resize_ratio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node_min_ratio</span><span class="p">,</span> <span class="n">comp_min_ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_min_ratio</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">node_min_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">comp_min_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_min_resize_ratio</span> <span class="o">=</span> <span class="n">node_min_ratio</span><span class="o">.</span><span class="n">reduce2</span><span class="p">(</span><span class="nb">max</span><span class="p">,</span> <span class="n">comp_min_ratio</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">node_min_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_min_resize_ratio</span> <span class="o">=</span> <span class="n">node_min_ratio</span>
        <span class="k">elif</span> <span class="n">comp_min_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_min_resize_ratio</span> <span class="o">=</span> <span class="n">comp_min_ratio</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Cannot possibly click on handle when nothing is selected.&#39;</span>

<div class="viewcode-block" id="SelectBox.on_left_up"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.on_left_up">[docs]</a>    <span class="k">def</span> <span class="nf">on_left_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">MOVING</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_did_move</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_did_move</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_commit_move</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">RESIZING</span><span class="p">:</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_did_move</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peripheral_nodes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_node_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_compartment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_compartment_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">post_event</span><span class="p">(</span><span class="n">DidCommitDragEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

            <span class="c1"># Need to do this in case _special_mode == NOT_CONTAINED, so that the mouse has now</span>
            <span class="c1"># left the handle. on_mouse_leave is not triggered because it&#39;s considered to be dragging.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hovered_part</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pos_inside_part</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">IDLE</span></div>

<div class="viewcode-block" id="SelectBox.on_mouse_drag"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.on_mouse_drag">[docs]</a>    <span class="k">def</span> <span class="nf">on_mouse_drag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logical_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">!=</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">IDLE</span>
        <span class="n">rect_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">RectData</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">+</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">RectData</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_mode</span> <span class="o">==</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">SMode</span><span class="o">.</span><span class="n">NOT_CONTAINED</span><span class="p">:</span>
            <span class="c1"># Return True since we still want this to appear to be dragging, just not working.</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">RESIZING</span><span class="p">:</span>
            <span class="n">rect_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">RectData</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">+</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">RectData</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
            <span class="c1"># TODO move the orig_rpos, etc. code to update()</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_mode</span> <span class="o">==</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">SMode</span><span class="o">.</span><span class="n">NODES_IN_ONE</span><span class="p">:</span>
                <span class="c1"># constrain resizing to within this compartment</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">comp_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">containing_comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">GetCompartment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">comp_idx</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">containing_comp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="n">bounds</span> <span class="o">=</span> <span class="n">containing_comp</span><span class="o">.</span><span class="n">rect</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_resize</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">,</span> <span class="n">rect_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rpos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rsizes</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">lockNode</span><span class="p">]</span>
            <span class="n">rect_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">RectData</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">+</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">RectData</span><span class="p">],</span> <span class="n">nodes</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rect_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_move</span><span class="p">(</span><span class="n">logical_pos</span><span class="p">,</span> <span class="n">rect_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rel_positions</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="nf">_resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">,</span> <span class="n">rect_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RectData</span><span class="p">],</span> <span class="n">orig_pos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Vec2</span><span class="p">],</span>
                <span class="n">orig_sizes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Vec2</span><span class="p">],</span> <span class="n">bounds</span><span class="p">:</span> <span class="n">Rect</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Helper that performs resize on the bounding box, given the logical mouse position.&quot;&quot;&quot;</span>
        <span class="c1"># STEP 1, get new rect vertices</span>
        <span class="c1"># see class comment for resize handle format. For side-handles, get the vertex in the</span>
        <span class="c1"># counter-clockwise direction</span>
        <span class="n">dragged_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="c1"># get the vertex opposite dragged idx as fixed_idx</span>
        <span class="n">fixed_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">dragged_idx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">orig_dragged_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rect</span><span class="o">.</span><span class="n">nth_vertex</span><span class="p">(</span><span class="n">dragged_idx</span><span class="p">)</span>
        <span class="n">cur_dragged_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outline_rect</span><span class="p">()</span><span class="o">.</span><span class="n">nth_vertex</span><span class="p">(</span><span class="n">dragged_idx</span><span class="p">)</span>
        <span class="n">fixed_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_orig_rect</span><span class="o">.</span><span class="n">nth_vertex</span><span class="p">(</span><span class="n">fixed_idx</span><span class="p">)</span>

        <span class="n">target_point</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle_offset</span>

        <span class="c1"># if a side-handle, then only resize one axis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># vertical resize; keep x the same</span>
                <span class="n">target_point</span> <span class="o">=</span> <span class="n">target_point</span><span class="o">.</span><span class="n">swapped</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">orig_dragged_point</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resize_handle</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">3</span>
                <span class="n">target_point</span> <span class="o">=</span> <span class="n">target_point</span><span class="o">.</span><span class="n">swapped</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">orig_dragged_point</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="c1"># clamp target point</span>
        <span class="n">target_point</span> <span class="o">=</span> <span class="n">clamp_point</span><span class="p">(</span><span class="n">target_point</span><span class="p">,</span> <span class="n">bounds</span><span class="p">)</span>

        <span class="c1"># STEP 2, get and validate rect ratio</span>

        <span class="c1"># raw difference between (current/target) dragged vertex and fixed vertex. Raw as in this</span>
        <span class="c1"># is the visual difference shown on the bounding rect.</span>
        <span class="n">orig_diff</span> <span class="o">=</span> <span class="n">orig_dragged_point</span> <span class="o">-</span> <span class="n">fixed_point</span>
        <span class="n">target_diff</span> <span class="o">=</span> <span class="n">target_point</span> <span class="o">-</span> <span class="n">fixed_point</span>

        <span class="n">signs</span> <span class="o">=</span> <span class="n">orig_diff</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">target_diff</span><span class="p">)</span>

        <span class="c1"># bounding_rect flipped?</span>
        <span class="k">if</span> <span class="n">signs</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">target_point</span> <span class="o">=</span> <span class="n">target_point</span><span class="o">.</span><span class="n">swapped</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cur_dragged_point</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">signs</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">target_point</span> <span class="o">=</span> <span class="n">target_point</span><span class="o">.</span><span class="n">swapped</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">cur_dragged_point</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="c1"># take absolute value and subtract padding to get actual difference (i.e. sizing)</span>
        <span class="n">pad_off</span> <span class="o">=</span> <span class="n">Vec2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_padding</span><span class="p">)</span>
        <span class="n">orig_bb_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">orig_dragged_point</span> <span class="o">-</span>
                        <span class="n">fixed_point</span><span class="p">)</span><span class="o">.</span><span class="n">elem_abs</span><span class="p">()</span> <span class="o">-</span> <span class="n">pad_off</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">target_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">target_point</span> <span class="o">-</span> <span class="n">fixed_point</span><span class="p">)</span><span class="o">.</span><span class="n">elem_abs</span><span class="p">()</span> <span class="o">-</span> <span class="n">pad_off</span> <span class="o">*</span> <span class="mi">2</span>

        <span class="n">size_ratio</span> <span class="o">=</span> <span class="n">target_size</span><span class="o">.</span><span class="n">elem_div</span><span class="p">(</span><span class="n">orig_bb_size</span><span class="p">)</span>

        <span class="c1"># size too small?</span>
        <span class="k">if</span> <span class="n">size_ratio</span><span class="o">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_resize_ratio</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
            <span class="n">size_ratio</span> <span class="o">=</span> <span class="n">size_ratio</span><span class="o">.</span><span class="n">swapped</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_resize_ratio</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">size_ratio</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_resize_ratio</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
            <span class="n">size_ratio</span> <span class="o">=</span> <span class="n">size_ratio</span><span class="o">.</span><span class="n">swapped</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_min_resize_ratio</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="c1"># re-calculate target_size in case size_ratio changed</span>
        <span class="n">target_size</span> <span class="o">=</span> <span class="n">orig_bb_size</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">size_ratio</span><span class="p">)</span>

        <span class="c1"># STEP 3 calculate new bounding_rect position and size</span>
        <span class="n">br_pos</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">fixed_point</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">target_point</span><span class="o">.</span><span class="n">x</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">fixed_point</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">target_point</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>

        <span class="c1"># STEP 4 calculate and apply new node positions and sizes</span>
        <span class="c1"># calculate and keep incremental ratio for the event arguments</span>
        <span class="n">inc_ratio</span> <span class="o">=</span> <span class="n">orig_bb_size</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">size_ratio</span><span class="p">)</span><span class="o">.</span><span class="n">elem_div</span><span class="p">(</span><span class="n">rect_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">rdata</span><span class="p">,</span> <span class="n">opos</span><span class="p">,</span> <span class="n">osize</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">rect_data</span><span class="p">,</span> <span class="n">orig_pos</span><span class="p">,</span> <span class="n">orig_sizes</span><span class="p">)):</span>
            <span class="c1">#assert opos.x &gt;= -1e-6 and opos.y &gt;= -1e-6</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">br_pos</span> <span class="o">+</span> <span class="n">opos</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">size_ratio</span><span class="p">)</span> <span class="o">+</span> <span class="n">pad_off</span><span class="p">)</span>
            <span class="c1"># HACK rect_data is compartments + nodes. So we only append to offsets we&#39;ve reached</span>
            <span class="c1"># the nodes sectoin</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):</span>
                <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">rdata</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
            <span class="n">rdata</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">pos</span>
            <span class="n">rdata</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">osize</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">size_ratio</span><span class="p">)</span>

        <span class="c1"># STEP 5 apply new bounding_rect position and size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounding_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">br_pos</span> <span class="o">+</span> <span class="n">pad_off</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounding_rect</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">target_size</span>

        <span class="c1"># STEP 6 post main events</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidResizeNodesEvent</span><span class="p">(</span><span class="n">node_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_indices</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">inc_ratio</span><span class="p">,</span>
                                           <span class="n">dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveNodesEvent</span><span class="p">(</span><span class="n">node_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_indices</span><span class="p">,</span>
                                         <span class="n">offset</span><span class="o">=</span><span class="n">offsets</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">):],</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidResizeCompartmentsEvent</span><span class="p">(</span>
                <span class="n">compartment_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_indices</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">inc_ratio</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveCompartmentsEvent</span><span class="p">(</span>
                <span class="n">compartment_indices</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comp_indices</span><span class="p">,</span>
                <span class="n">offset</span><span class="o">=</span><span class="n">offsets</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)],</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># STEP 7 adjust peripheral node positions so that they are inside the compartment</span>
        <span class="n">adjusted_nodes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">offsets</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peripheral_nodes</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">node</span><span class="o">.</span><span class="n">comp_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">comp_idx_map</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">comp_idx</span><span class="p">]</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">clamp_rect_pos</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">rect</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">rect</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">adjusted_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="n">offsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">adjusted_nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveNodesEvent</span><span class="p">(</span><span class="n">adjusted_nodes</span><span class="p">,</span> <span class="n">offsets</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">,</span> <span class="n">rect_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">RectData</span><span class="p">],</span> <span class="n">rel_positions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Vec2</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Helper that performs resize on the bounding box, given the logical mouse position.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rect_data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rel_positions</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">rect_data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="c1"># campute tentative new positions. May need to clamp it.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_did_move</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">new_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="n">rp</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">rel_positions</span><span class="p">]</span>
        <span class="n">min_x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">new_positions</span><span class="p">)</span>
        <span class="n">min_y</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">new_positions</span><span class="p">)</span>
        <span class="n">max_x</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span>
                    <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_positions</span><span class="p">,</span> <span class="n">rect_data</span><span class="p">))</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span>
                    <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_positions</span><span class="p">,</span> <span class="n">rect_data</span><span class="p">))</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">s_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span>
        <span class="n">lim_topleft</span> <span class="o">=</span> <span class="n">s_bounds</span><span class="o">.</span><span class="n">position</span>
        <span class="n">lim_botright</span> <span class="o">=</span> <span class="n">s_bounds</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">s_bounds</span><span class="o">.</span><span class="n">size</span>

        <span class="k">if</span> <span class="n">min_x</span> <span class="o">&lt;</span> <span class="n">lim_topleft</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">max_x</span> <span class="o">&lt;=</span> <span class="n">lim_botright</span><span class="o">.</span><span class="n">x</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">lim_topleft</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">max_x</span> <span class="o">&gt;</span> <span class="n">lim_botright</span><span class="o">.</span><span class="n">x</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">lim_botright</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">max_x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">min_y</span> <span class="o">&lt;</span> <span class="n">lim_topleft</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">max_y</span> <span class="o">&lt;=</span> <span class="n">lim_botright</span><span class="o">.</span><span class="n">y</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lim_topleft</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">max_y</span> <span class="o">&gt;</span> <span class="n">lim_botright</span><span class="o">.</span><span class="n">y</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">+=</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lim_botright</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">max_y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bounding_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drag_rel</span><span class="p">)</span>
        <span class="c1"># The actual amount moved by the rects</span>
        <span class="n">pos_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">-</span> <span class="n">rect_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">position</span>
        <span class="k">for</span> <span class="n">rdata</span><span class="p">,</span> <span class="n">np</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rect_data</span><span class="p">,</span> <span class="n">new_positions</span><span class="p">):</span>
            <span class="n">rdata</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span>

        <span class="c1"># Note that don&#39;t need to test if out of bounds by peripheral nodes, since all</span>
        <span class="c1"># peripheral nodes must be inside selected compartments.</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peripheral_nodes</span><span class="p">:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">position</span> <span class="o">+=</span> <span class="n">pos_offset</span>

        <span class="n">all_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">peripheral_nodes</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_nodes</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveNodesEvent</span><span class="p">([</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">all_nodes</span><span class="p">],</span> <span class="n">pos_offset</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">post_event</span><span class="p">(</span><span class="n">DidMoveCompartmentsEvent</span><span class="p">(</span><span class="n">compartment_indices</span><span class="o">=</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">],</span>
                                                <span class="n">offset</span><span class="o">=</span><span class="n">pos_offset</span><span class="p">,</span> <span class="n">dragged</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<div class="viewcode-block" id="SelectBox.move_offset"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.SelectBox.move_offset">[docs]</a>    <span class="k">def</span> <span class="nf">move_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">offset</span><span class="p">:</span> <span class="n">Vec2</span><span class="p">):</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">lockNode</span><span class="p">]</span>
        <span class="n">rect_data</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">RectData</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">)</span> <span class="o">+</span> <span class="n">cast</span><span class="p">(</span><span class="n">List</span><span class="p">[</span><span class="n">RectData</span><span class="p">],</span> <span class="n">nodes</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounding_rect</span><span class="o">.</span><span class="n">position</span>
        <span class="n">rel_node_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">pos</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">lockNode</span><span class="p">]</span>
        <span class="n">rel_comp_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">position</span> <span class="o">-</span> <span class="n">pos</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">]</span>
        <span class="n">rel_positions</span> <span class="o">=</span> <span class="n">rel_comp_pos</span> <span class="o">+</span> <span class="n">rel_node_pos</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rect_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_move</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">rect_data</span><span class="p">,</span> <span class="n">rel_positions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commit_move</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_commit_move</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">group_action</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">peripheral_nodes</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">move_compartment</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_mode</span> <span class="o">==</span> <span class="n">SelectBox</span><span class="o">.</span><span class="n">SMode</span><span class="o">.</span><span class="n">NODES_IN_ONE</span><span class="p">:</span>
                <span class="n">compi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">InWhichCompartment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
                <span class="n">old_compi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">comp_idx</span>
                <span class="k">if</span> <span class="n">compi</span> <span class="o">!=</span> <span class="n">old_compi</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">set_compartment_of_node</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">net_index</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">compi</span><span class="p">)</span>
                    <span class="n">post_event</span><span class="p">(</span><span class="n">DidChangeCompartmentOfNodesEvent</span><span class="p">(</span>
                        <span class="n">node_indices</span><span class="o">=</span><span class="p">[</span><span class="n">n</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">],</span>
                        <span class="n">old_compi</span><span class="o">=</span><span class="n">old_compi</span><span class="p">,</span>
                        <span class="n">new_compi</span><span class="o">=</span><span class="n">compi</span>
                    <span class="p">))</span>

            <span class="n">post_event</span><span class="p">(</span><span class="n">DidCommitDragEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>

<div class="viewcode-block" id="primitive_peninfo"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.primitive_peninfo">[docs]</a><span class="k">def</span> <span class="nf">primitive_peninfo</span><span class="p">(</span><span class="n">color</span><span class="p">:</span> <span class="n">Color</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsPenInfo</span><span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">to_wxcolour</span><span class="p">(),</span> <span class="n">width</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_alias</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">Style</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">PENSTYLE_SHORT_DASH</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">info</span></div>


<div class="viewcode-block" id="primitive_brush"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.primitive_brush">[docs]</a><span class="k">def</span> <span class="nf">primitive_brush</span><span class="p">(</span><span class="n">color</span><span class="p">:</span> <span class="n">Color</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="c1"># style = wx.BRUSHSTYLE_FIRST_HATCH if is_alias else wx.BRUSHSTYLE_SOLID</span>
    <span class="n">style</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">BRUSHSTYLE_SOLID</span>
    <span class="n">brush</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Brush</span><span class="p">(</span><span class="n">color</span><span class="o">.</span><span class="n">to_wxcolour</span><span class="p">(),</span> <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">brush</span></div>


<div class="viewcode-block" id="draw_circle_to_gc"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.draw_circle_to_gc">[docs]</a><span class="k">def</span> <span class="nf">draw_circle_to_gc</span><span class="p">(</span><span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">,</span> <span class="n">box</span><span class="p">:</span> <span class="n">Rect</span><span class="p">,</span> <span class="n">circle</span><span class="p">:</span> <span class="n">CirclePrim</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">peninfo</span> <span class="o">=</span> <span class="n">primitive_peninfo</span><span class="p">(</span><span class="n">circle</span><span class="o">.</span><span class="n">border_color</span><span class="p">,</span> <span class="n">circle</span><span class="o">.</span><span class="n">border_width</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">)</span>
    <span class="n">pen</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePen</span><span class="p">(</span><span class="n">peninfo</span><span class="p">)</span>
    <span class="n">brush</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreateBrush</span><span class="p">(</span><span class="n">primitive_brush</span><span class="p">(</span><span class="n">circle</span><span class="o">.</span><span class="n">fill_color</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">))</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">SetPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">SetBrush</span><span class="p">(</span><span class="n">brush</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePath</span><span class="p">()</span>
    <span class="n">path</span><span class="o">.</span><span class="n">AddEllipse</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">DrawPath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>


<div class="viewcode-block" id="draw_rect_to_gc"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.draw_rect_to_gc">[docs]</a><span class="k">def</span> <span class="nf">draw_rect_to_gc</span><span class="p">(</span><span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">,</span> <span class="n">box</span><span class="p">:</span> <span class="n">Rect</span><span class="p">,</span> <span class="n">rect</span><span class="p">:</span> <span class="n">RectanglePrim</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="c1"># restrict the border width of the node to an even integer</span>
    <span class="c1"># this is necessary for aligning the node rectangle to the selection rectangle</span>
    <span class="c1"># why? see Rect::aligned().</span>
    <span class="n">box</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">aligned</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rect</span><span class="o">.</span><span class="n">border_width</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">border_width</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">border_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">even_round</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">border_width</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">pen</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePen</span><span class="p">(</span><span class="n">primitive_peninfo</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">border_color</span><span class="p">,</span> <span class="n">border_width</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">))</span>
    <span class="n">brush</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreateBrush</span><span class="p">(</span><span class="n">primitive_brush</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">fill_color</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">))</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">SetPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">SetBrush</span><span class="p">(</span><span class="n">brush</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">DrawRoundedRectangle</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">box</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">rect</span><span class="o">.</span><span class="n">corner_radius</span><span class="p">)</span></div>


<div class="viewcode-block" id="draw_polygon_to_gc"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.draw_polygon_to_gc">[docs]</a><span class="k">def</span> <span class="nf">draw_polygon_to_gc</span><span class="p">(</span><span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">,</span> <span class="n">box</span><span class="p">:</span> <span class="n">Rect</span><span class="p">,</span> <span class="n">poly</span><span class="p">:</span> <span class="n">PolygonPrim</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
    <span class="n">pen</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreatePen</span><span class="p">(</span><span class="n">primitive_peninfo</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">border_color</span><span class="p">,</span> <span class="n">poly</span><span class="o">.</span><span class="n">border_width</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">))</span>
    <span class="n">brush</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreateBrush</span><span class="p">(</span><span class="n">primitive_brush</span><span class="p">(</span><span class="n">poly</span><span class="o">.</span><span class="n">fill_color</span><span class="p">,</span> <span class="n">is_alias</span><span class="p">))</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">SetPen</span><span class="p">(</span><span class="n">pen</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">SetBrush</span><span class="p">(</span><span class="n">brush</span><span class="p">)</span>
    <span class="c1"># offset so polygon is centered at (0.5, 0.5)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="o">+</span> <span class="n">Vec2</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">poly</span><span class="o">.</span><span class="n">points</span><span class="p">]</span>
    <span class="n">transformed_pts</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">points</span><span class="p">]</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">DrawLines</span><span class="p">([</span><span class="n">wx</span><span class="o">.</span><span class="n">Point2D</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">transformed_pts</span><span class="p">])</span></div>


<span class="c1"># HACK bypass Python typing warnings with Type variables</span>
<span class="n">draw_fn_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">CirclePrim</span><span class="p">:</span> <span class="n">draw_circle_to_gc</span><span class="p">,</span>
    <span class="n">RectanglePrim</span><span class="p">:</span> <span class="n">draw_rect_to_gc</span><span class="p">,</span>
    <span class="n">HexagonPrim</span><span class="p">:</span> <span class="n">draw_polygon_to_gc</span><span class="p">,</span>
    <span class="n">LinePrim</span><span class="p">:</span> <span class="n">draw_polygon_to_gc</span><span class="p">,</span>
    <span class="n">TrianglePrim</span><span class="p">:</span> <span class="n">draw_polygon_to_gc</span>
<span class="p">}</span>


<span class="c1"># def apply_transform_to_gc(gc: wx.GraphicsContext, transform: Transform):</span>
<span class="c1">#     gc.Translate(*transform.translation)</span>
<span class="c1">#     gc.Rotate(transform.rotation)</span>
<span class="c1">#     gc.Scale(*transform.scale)</span>


<div class="viewcode-block" id="draw_composite_shape"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.draw_composite_shape">[docs]</a><span class="k">def</span> <span class="nf">draw_composite_shape</span><span class="p">(</span><span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">,</span> <span class="n">bounding_rect</span><span class="p">:</span> <span class="n">Rect</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">):</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">composite_shape</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">PushState</span><span class="p">()</span>
    <span class="c1"># gc.Translate(*(bounding_rect.position.elem_mul(bounding_rect.size)))</span>
    <span class="c1"># gc.Scale(*bounding_rect.size)</span>
    <span class="k">for</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">transform</span> <span class="ow">in</span> <span class="n">shape</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">PushState</span><span class="p">()</span>
        <span class="c1"># apply_transform_to_gc(gc, transform)</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">bounding_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="p">),</span>
                   <span class="n">bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">scale</span><span class="p">))</span>
        <span class="n">draw_fn_map</span><span class="p">[</span><span class="n">primitive</span><span class="o">.</span><span class="vm">__class__</span><span class="p">](</span><span class="n">gc</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">primitive</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">original_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">PopState</span><span class="p">()</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">PopState</span><span class="p">()</span>

    <span class="n">gc</span><span class="o">.</span><span class="n">PushState</span><span class="p">()</span>
    <span class="c1"># apply_transform_to_gc(gc, node.composite_shape.text_item[1])</span>
    <span class="n">draw_text_to_gc</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">bounding_rect</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">composite_shape</span><span class="o">.</span><span class="n">text_item</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">PopState</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">_truncate_text</span><span class="p">(</span><span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">,</span> <span class="n">max_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Truncate the given text (add ellipsis to the end) so that its width fits inside `max_width`.</span>

<span class="sd">    Assume that we are using the currently selected font in gc.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">GetFullTextExtent</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="c1"># very rough chopping</span>
    <span class="k">if</span> <span class="n">tw</span> <span class="o">&gt;</span> <span class="n">max_width</span><span class="p">:</span>
        <span class="n">text_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_width</span> <span class="o">/</span> <span class="n">tw</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="n">text_len</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;....&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;....&#39;</span>

    <span class="k">return</span> <span class="n">text</span>


<div class="viewcode-block" id="draw_text_to_gc"><a class="viewcode-back" href="../../../rkviewer/rkviewer.canvas.html#rkviewer.canvas.elements.draw_text_to_gc">[docs]</a><span class="k">def</span> <span class="nf">draw_text_to_gc</span><span class="p">(</span><span class="n">gc</span><span class="p">:</span> <span class="n">wx</span><span class="o">.</span><span class="n">GraphicsContext</span><span class="p">,</span> <span class="n">bounding_rect</span><span class="p">:</span> <span class="n">Rect</span><span class="p">,</span> <span class="n">full_text_string</span><span class="p">,</span> <span class="n">text_item</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">TextPrim</span><span class="p">,</span> <span class="n">Transform</span><span class="p">]):</span>
    <span class="n">primitive</span><span class="p">,</span> <span class="n">transform</span> <span class="o">=</span> <span class="n">text_item</span>

    <span class="c1"># Maybe cache this?</span>
    <span class="n">fg_color</span> <span class="o">=</span> <span class="n">primitive</span><span class="o">.</span><span class="n">font_color</span><span class="o">.</span><span class="n">to_wxcolour</span><span class="p">()</span>
    <span class="n">font</span> <span class="o">=</span> <span class="n">wx</span><span class="o">.</span><span class="n">Font</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">FontInfo</span><span class="p">(</span><span class="n">primitive</span><span class="o">.</span><span class="n">font_size</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">Family</span><span class="p">(</span><span class="n">primitive</span><span class="o">.</span><span class="n">font_family</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">Style</span><span class="p">(</span><span class="n">primitive</span><span class="o">.</span><span class="n">font_style</span><span class="p">)</span>
                   <span class="o">.</span><span class="n">Weight</span><span class="p">(</span><span class="n">primitive</span><span class="o">.</span><span class="n">font_weight</span><span class="p">))</span>
    <span class="n">gfont</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreateFont</span><span class="p">(</span><span class="n">font</span><span class="p">,</span> <span class="n">fg_color</span><span class="p">)</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">SetFont</span><span class="p">(</span><span class="n">gfont</span><span class="p">)</span>
    <span class="n">brush</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">CreateBrush</span><span class="p">(</span><span class="n">wx</span><span class="o">.</span><span class="n">Brush</span><span class="p">(</span><span class="n">primitive</span><span class="o">.</span><span class="n">bg_color</span><span class="o">.</span><span class="n">to_wxcolour</span><span class="p">()))</span>

    <span class="n">width</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">bounding_rect</span><span class="o">.</span><span class="n">size</span>
    <span class="n">text_string</span> <span class="o">=</span> <span class="n">_truncate_text</span><span class="p">(</span><span class="n">gc</span><span class="p">,</span> <span class="n">bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">full_text_string</span><span class="p">)</span>
    <span class="n">tw</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">GetFullTextExtent</span><span class="p">(</span><span class="n">text_string</span><span class="p">)</span>
    <span class="n">tw_full</span><span class="p">,</span> <span class="n">th_full</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">GetFullTextExtent</span><span class="p">(</span><span class="n">full_text_string</span><span class="p">)</span>

    <span class="c1"># remaining x and y</span>
    <span class="n">rx</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">tw</span>
    <span class="n">ry</span> <span class="o">=</span> <span class="n">height</span> <span class="o">-</span> <span class="n">th</span>
    <span class="c1"># upper left corner of node</span>
    <span class="n">text_pos</span> <span class="o">=</span> <span class="n">bounding_rect</span><span class="o">.</span><span class="n">position</span> <span class="o">+</span> <span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">elem_mul</span><span class="p">(</span><span class="n">bounding_rect</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="c1"># do not truncate text if outside node</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">primitive</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="n">TextPosition</span><span class="o">.</span><span class="n">IN_NODE</span><span class="p">:</span>
        <span class="n">text_string</span> <span class="o">=</span> <span class="n">full_text_string</span>
        <span class="n">text_pos</span> <span class="o">=</span> <span class="n">text_pos</span> <span class="o">-</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">tw_full</span> <span class="o">+</span> <span class="n">th</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="n">th</span> <span class="o">+</span> <span class="n">tw_full</span> <span class="o">+</span> <span class="n">width</span>

    <span class="k">if</span> <span class="n">primitive</span><span class="o">.</span><span class="n">alignment</span> <span class="o">==</span> <span class="n">TextAlignment</span><span class="o">.</span><span class="n">LEFT</span><span class="p">:</span>
        <span class="n">draw_pos</span> <span class="o">=</span> <span class="n">text_pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ry</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">primitive</span><span class="o">.</span><span class="n">alignment</span> <span class="o">==</span> <span class="n">TextAlignment</span><span class="o">.</span><span class="n">CENTER</span><span class="p">:</span>
        <span class="n">draw_pos</span> <span class="o">=</span> <span class="n">text_pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="k">elif</span> <span class="n">primitive</span><span class="o">.</span><span class="n">alignment</span> <span class="o">==</span> <span class="n">TextAlignment</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">:</span>
        <span class="n">draw_pos</span> <span class="o">=</span> <span class="n">text_pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;This should not happen&quot;</span>

    <span class="k">if</span> <span class="n">primitive</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="n">TextPosition</span><span class="o">.</span><span class="n">ABOVE</span><span class="p">:</span>
        <span class="n">draw_pos</span> <span class="o">=</span> <span class="n">draw_pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">th</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">primitive</span><span class="o">.</span><span class="n">position</span> <span class="o">==</span> <span class="n">TextPosition</span><span class="o">.</span><span class="n">BELOW</span><span class="p">:</span>
        <span class="n">draw_pos</span> <span class="o">=</span> <span class="n">draw_pos</span> <span class="o">+</span> <span class="n">Vec2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">th</span><span class="p">)</span>

    <span class="n">gc</span><span class="o">.</span><span class="n">DrawText</span><span class="p">(</span><span class="n">text_string</span><span class="p">,</span> <span class="n">draw_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">draw_pos</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">brush</span><span class="p">)</span></div>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2023, Jin Xu, Gary Geng, Nhan D. Nguyen, Carmen Perena-Cortes, Claire Samuels, Herbert M. Sauro

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>